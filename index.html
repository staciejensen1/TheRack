<!DOCTYPE html>
<!--
  THE RACK - Reptile Breeding Program Management
  Version: 2.11.22
  Last Updated: 2026-01-09
  
  Changelog:
  - 2.11.22: Filter bar fixes
             - Fixed bug: Clutch search was showing on all tabs (now ONLY on Clutches)
             - Moved Archive from Navigation to Tools section
             - All filter bars now properly hide before showing correct one
  - 2.11.21: Invoice PDF fixes
             - Removed auto-generated Payment Method section (was incorrectly showing)
             - Fixed Amount Due gray bar to extend full width in PDF
  - 2.11.20: Dashboard alert cards now filter to show only matching items
             - Overdue Clutches: Shows only incubating clutches past est. hatch date
             - Due Within 7 Days: Shows only clutches due in next 7 days
             - Unshipped Sales: Shows only sold items needing shipping
             - Shipping Soon: Shows items shipping within 3 days
             - Unpaid Deposits: Shows only on-hold items with deposit status
             - Balance Due: Shows items where total paid < sold price
             - Needs Sexing: Shows unlisted hatchlings with unknown sex
             - Ready to List: Shows unlisted hatchlings 30+ days old
             - Dark filter badge shows active filter with X to clear
  - 2.11.19: Redesigned Add Activity modal
             - Activity table: Feedings, Refusals, Sheds, Ovulations (this month)
             - Dashboard: Took Meal, Refused Meal, Paired, Locked, Ovulation, Laid (season totals)
  - 2.11.12: Quick Activity save button now shows "Saving..." while saving
  - 2.11.11: Added Delete button to Activity table (direct delete, no archive)
  - 2.11.10: Fixed Activity not capturing UNIQUE ID
             - UNIQUE ID and CLUTCH ID are now allowed for Activity tab (not formulas there)
             - Still protected on Collection and Clutch tabs where they ARE formulas
  - 2.11.9: Removed "Log another activity?" confirmation dialog after saving
  - 2.11.8: Fixed Save button not working on Edit/Add forms
            - Save button onclick was being overwritten by quick Activity modal
            - Now resets onclick to saveRecord() when opening Add/Edit modals
  - 2.11.7: Clutch-specific quick activities
            - Added: Hatched and Clutch Went Bad activities for clutch table
            - Activity button shows different options based on table (clutch vs animal)
            - Clutch activities: Hatched, Clutch Went Bad, Note
            - Animal activities: Took Meal, Refused Meal, Shed, Weight, Note, Health Hold
  - 2.11.6: CRITICAL BUG FIXES
            - Fixed: Activity button now works (saveBtn reference corrected)
            - Fixed: Formula columns protected in frontend (UNIQUE ID, QR CODE, CLUTCH ID, etc)
            - Note: BACKEND Code.gs MUST be updated to v2.11.0 for full protection
            - The backend now skips formula columns during save/update operations
  - 2.11.5: New features and character encoding fixes
            - Added: + Activity button on Collection, Clutch, Hatchling tables
            - Added: Animal search/select dropdown in Add Activity form  
            - Added: Invoice button in sidebar (links to Sales view)
            - Fixed: All corrupted emoji characters removed
            - Fixed: Back button now shows < Back properly
  - 2.11.4: Critical fixes for formula protection and sales stats
            - CRITICAL: Protected ALL formula columns (UNIQUE ID, QR CODE, CLUTCH ID, DAYS TILL HATCH, etc.)
            - CRITICAL: Forms never send data to formula columns - database handles them
            - Fixed: Sales stats now properly calculate for selected year
            - Fixed: Dates pass through as-is (no formatting/parsing that could break data)
            - Removed: MorphMarket import temporarily disabled (needs redesign)
            - Removed: All date parsing/formatting that could corrupt data
  - 2.11.3: Major bug fixes - UNIQUE ID/CLUTCH ID protection, date format fix, search bar, duplicate ID check, sales stats fix
  - 2.11.1: Invoice feature complete - modal, multi-animal, PDF download, print, tax, deposits, terms
  - 2.11.0: Invoice feature - generate PDF invoices from Sales view, multi-animal support, tax, deposits, print/download
  - 2.10.9: Fixed Edit for imported rows - falls back to finding row by UNIQUE ID if __rowIndex missing
  - 2.10.7: Fixed filter bar and stats cards showing on Dashboard
  - 2.10.6: NEW approach for Edit/Delete - uses global row array with inline onclick handlers
  - 2.10.5: Fixed MorphMarket import - year-only DOB now becomes 01/01/YYYY
  - 2.10.4: Made Hatchlings/Sales table stats monochrome, removed Clutches section from Dashboard
  - 2.10.0: Filter dropdowns, clickable gene tags, maturity auto-calc, status badges
  - 2.9.0: Delete button on all table views, stats cards, Settings tab integration
  - 2.8.0: Archive feature - delete moves to Archive tab
  - 2.7.0: MorphMarket CSV import with field mapping
  - 2.5.0: Mobile-friendly redesign
  - 2.0.0: Apps Script API backend
  - 1.0.0: Initial release
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Rack - Breeding Program Management</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .mono { font-family: ui-monospace, monospace; }
    .modal-backdrop { backdrop-filter: blur(4px); }
    .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    
    /* QR Print Styles */
    @media print {
      body * { visibility: hidden; }
      #qrPrintArea, #qrPrintArea * { visibility: visible; }
      #qrPrintArea { position: absolute; left: 0; top: 0; }
      #invoicePrintArea, #invoicePrintArea * { visibility: visible; }
      #invoicePrintArea { position: absolute; left: 0; top: 0; width: 100%; }
    }
    .qr-label { page-break-inside: avoid; }
    
    /* Invoice Styles */
    .invoice-preview {
      background: white;
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
      font-size: 14px;
      line-height: 1.5;
    }
    .invoice-preview table {
      width: 100%;
      border-collapse: collapse;
    }
    .invoice-preview th, .invoice-preview td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .invoice-preview th {
      background: #f9fafb;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #6b7280;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen">
  
  <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">
    <!-- Header -->
    <header class="bg-white rounded-2xl p-4 md:p-6 shadow-sm mb-4 md:mb-6 border border-gray-200">
      <div class="flex items-center justify-between gap-4">
        <!-- Hamburger + Logo -->
        <div class="flex items-center gap-3">
          <!-- Hamburger Menu Button (mobile only) -->
          <button id="menuBtn" onclick="toggleMobileMenu()" class="md:hidden p-2 -ml-2 text-gray-700 hover:bg-gray-100 rounded-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
          
          <!-- Logo SVG -->
          <svg viewBox="0 0 320 60" class="h-10 md:h-14" xmlns="http://www.w3.org/2000/svg">
            <g transform="translate(30, 25)">
              <path d="M-16 -14 L-8 -14 L0 -6 L-8 2 L0 10 L-8 18 L-16 18" 
                    stroke="#000" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M16 -14 L8 -14 L0 -6 L8 2 L0 10 L8 18 L16 18" 
                    stroke="#000" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="-16" cy="-14" r="2" fill="#000"/>
              <circle cx="16" cy="-14" r="2" fill="#000"/>
            </g>
            <text x="62" y="32" fill="#000" font-family="Inter, system-ui, sans-serif" font-weight="800" font-size="26" letter-spacing="-1">THE RACK</text>
            <text x="62" y="48" fill="#888" font-family="Inter, system-ui, sans-serif" font-weight="500" font-size="8" letter-spacing="2">RACK IT. TRACK IT. RUN IT.</text>
          </svg>
          <span id="versionTag" class="text-xs text-gray-400 hidden md:inline">v2.4.1</span>
        </div>

        <!-- Desktop: Login/Connected -->
        <div class="hidden md:flex flex-wrap items-center gap-2 md:gap-3">
          <!-- Login Form (shown when not logged in) -->
          <div id="loginGroup" class="flex flex-wrap items-center gap-2">
            <input
              type="email"
              id="emailInput"
              placeholder="Email (from purchase)"
              class="px-3 py-2 border border-gray-300 rounded-xl bg-gray-50 text-sm w-48 focus:border-gray-500 focus:ring-1 focus:ring-gray-500"
            />
            <input
              type="text"
              id="accessCodeInput"
              placeholder="Access Code"
              class="px-3 py-2 border border-gray-300 rounded-xl bg-gray-50 mono text-sm w-48 focus:border-gray-500 focus:ring-1 focus:ring-gray-500"
            />
            <button id="loginBtn" class="px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black text-sm">
              Log In
            </button>
          </div>

          <!-- Connected Status (shown when logged in) -->
          <div id="connectedGroup" class="flex items-center gap-2 hidden">
            <span id="userEmail" class="text-sm text-gray-600"></span>
            <button id="syncBtn" onclick="loadData()" class="px-3 py-2 bg-gray-100 text-gray-700 font-medium rounded-xl hover:bg-gray-200 text-sm" title="Sync data">
               Sync
            </button>
            <button id="signOutBtn" class="px-3 py-2 bg-gray-200 text-gray-700 font-medium rounded-xl hover:bg-gray-300 text-sm">
              Sign out
            </button>
          </div>
        </div>

        <!-- Mobile: Sync button only when logged in -->
        <div id="mobileSyncBtn" class="md:hidden hidden">
          <button onclick="loadData()" class="p-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200" title="Sync">
            
          </button>
        </div>
      </div>

      <!-- Mobile Login Form -->
      <div id="mobileLoginGroup" class="md:hidden mt-4 hidden">
        <div class="flex flex-col gap-2">
          <input
            type="email"
            id="mobileEmailInput"
            placeholder="Email (from purchase)"
            class="px-3 py-2 border border-gray-300 rounded-xl bg-gray-50 text-sm focus:border-gray-500 focus:ring-1 focus:ring-gray-500"
          />
          <input
            type="text"
            id="mobileAccessCodeInput"
            placeholder="Access Code"
            class="px-3 py-2 border border-gray-300 rounded-xl bg-gray-50 mono text-sm focus:border-gray-500 focus:ring-1 focus:ring-gray-500"
          />
          <button id="mobileLoginBtn" class="px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black text-sm">
            Log In
          </button>
        </div>
      </div>

      <div class="mt-3 flex items-center gap-4 text-sm">
        <span id="statusText" class="text-gray-500">Starting up...</span>
      </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div id="mobileMenuOverlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" onclick="toggleMobileMenu()"></div>
    
    <!-- Mobile Slide-out Menu -->
    <aside id="mobileMenu" class="fixed top-0 left-0 h-full w-72 bg-white shadow-2xl z-50 transform -translate-x-full transition-transform duration-300 md:hidden overflow-y-auto">
      <div class="p-4">
        <div class="flex items-center justify-between mb-6">
          <span class="font-bold text-gray-900">Menu</span>
          <button onclick="toggleMobileMenu()" class="p-2 text-gray-500 hover:bg-gray-100 rounded-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Mobile User Info -->
        <div id="mobileUserInfo" class="mb-6 p-3 bg-gray-50 rounded-xl hidden">
          <div id="mobileUserEmail" class="text-sm text-gray-600 truncate"></div>
          <button onclick="handleSignOut(); toggleMobileMenu();" class="mt-2 text-sm text-red-600 hover:text-red-700">Sign out</button>
        </div>

        <!-- Navigation -->
        <div class="mb-6">
          <div class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Navigation</div>
          <nav id="mobileNavTabs" class="flex flex-col gap-1"></nav>
        </div>

        <!-- Quick Add -->
        <div class="mb-6">
          <div class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Quick Add</div>
          <div class="flex flex-col gap-1">
            <button onclick="openAddModal('collection'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Breeder</button>
            <button onclick="openAddModal('clutch'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Clutch</button>
            <button onclick="openAddModal('hatchling'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Hatchling</button>
            <button onclick="openAddModal('activity'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Activity</button>
          </div>
        </div>

        <!-- Tools -->
        <div class="pt-4 border-t border-gray-100">
          <div class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Tools</div>
          <div class="flex flex-col gap-1">
            <button onclick="navigateTo('sales'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Create Invoice</button>
            <button onclick="exportCSV('collection'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Export Collection</button>
            <button onclick="exportCSV('clutch'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Export Clutches</button>
            <button onclick="showDataHealth(); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Data Health</button>
            <button onclick="openQRGenerator(); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Print QR Codes</button>
            <button onclick="navigateTo('archive'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Archive</button>
            <button onclick="openSettingsModal(); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Settings</button>
          </div>
        </div>

        <!-- Support -->
        <div class="mt-6 pt-4 border-t border-gray-100">
          <button onclick="openChangelogModal(); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg block w-full text-left">
            What's New
          </button>
          <a href="https://docs.google.com/forms/d/e/1FAIpQLSc1cdNzPiLLteHIIUMD83yUc4BLZ1JL8hmpuwsiYUGMcPHBaQ/viewform" target="_blank" onclick="toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg block">
            Submit Support Ticket
          </a>
        </div>
      </div>
    </aside>

    <div class="flex flex-col md:flex-row gap-6">
      <!-- Desktop Sidebar -->
      <aside class="hidden md:block w-56 shrink-0">
        <div class="bg-white rounded-2xl p-4 shadow-sm sticky top-6 border border-gray-200">
          <!-- Quick Add -->
          <div class="mb-6">
            <div class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Quick Add</div>
            <div class="flex flex-col gap-1">
              <button onclick="openAddModal('collection')" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Breeder</button>
              <button onclick="openAddModal('clutch')" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Clutch</button>
              <button onclick="openAddModal('hatchling')" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Hatchling</button>
              <button onclick="openAddModal('activity')" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Activity</button>
            </div>
          </div>
          
          <!-- Navigation -->
          <div class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Navigation</div>
          <nav id="navTabs" class="flex flex-col gap-1">
          </nav>

          <!-- Tools -->
          <div class="mt-6 pt-4 border-t border-gray-100">
            <div class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Tools</div>
            <div class="flex flex-col gap-1">
              <button onclick="navigateTo('sales')" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Create Invoice</button>
              <button onclick="exportCSV('collection')" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Export Collection</button>
              <button onclick="exportCSV('clutch')" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Export Clutches</button>
              <button onclick="openQRGenerator()" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Print QR Codes</button>
              <button onclick="showDataHealth()" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Data Health</button>
              <button onclick="navigateTo('archive')" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Archive</button>
              <button onclick="openSettingsModal()" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Settings</button>
            </div>
          </div>

          <!-- Support -->
          <div class="mt-6 pt-4 border-t border-gray-100">
            <button onclick="openChangelogModal()" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg block w-full text-left">
              What's New
            </button>
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSc1cdNzPiLLteHIIUMD83yUc4BLZ1JL8hmpuwsiYUGMcPHBaQ/viewform" target="_blank" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg block">
              Submit Support Ticket
            </a>
          </div>
        </div>
      </aside>

      <!-- Main content -->
      <main class="flex-1 min-w-0">
        <!-- Mobile Quick Add Bar -->
        <div class="md:hidden bg-white rounded-2xl p-3 shadow-sm border border-gray-200 mb-4">
          <div class="flex items-center justify-between gap-2 overflow-x-auto">
            <button onclick="openAddModal('collection')" class="flex-shrink-0 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-200">+ Breeder</button>
            <button onclick="openAddModal('clutch')" class="flex-shrink-0 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-200">+ Clutch</button>
            <button onclick="openAddModal('hatchling')" class="flex-shrink-0 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-200">+ Hatchling</button>
            <button onclick="openAddModal('activity')" class="flex-shrink-0 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-200">+ Activity</button>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-4 md:p-6 shadow-sm border border-gray-200">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <button id="backBtn" onclick="goBack()" class="px-3 py-2 bg-gray-100 text-gray-700 font-medium rounded-xl hover:bg-gray-200 text-sm hidden">
                < Back
              </button>
              <h2 id="pageTitle" class="text-xl font-bold text-gray-900 capitalize">Dashboard</h2>
            </div>
            <button id="addBtn" onclick="openAddForCurrentTab()" class="px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black hidden text-sm">
              + Add New
            </button>
          </div>
          
          <!-- Dashboard -->
          <div id="dashboardView"></div>

          <!-- Stats Cards (shown on table pages) -->
          <div id="tableStatsView" class="hidden mb-4"></div>

          <!-- Filter Bar (shown on table pages) -->
          <div id="filterBar" class="hidden mb-4 flex flex-wrap gap-2 items-center">
            <input type="text" id="searchInput" placeholder="Search name or ID..." oninput="applyFilter('search', this.value)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white w-48">
            <select id="filterSex" onchange="applyFilter('sex', this.value)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
              <option value="">All Sex</option>
              <option value="Female">Female</option>
              <option value="Male">Male</option>
              <option value="Unknown">Unknown</option>
            </select>
            <select id="filterStatus" onchange="applyFilter('status', this.value)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
              <option value="">All Status</option>
              <option value="Breeder">Breeder</option>
              <option value="Listed">Listed</option>
              <option value="Unlisted">Unlisted</option>
              <option value="Holdback">Holdback</option>
              <option value="On Hold">On Hold</option>
              <option value="Sold">Sold</option>
              <option value="On Loan">On Loan</option>
            </select>
            <select id="filterSpecies" onchange="applyFilter('species', this.value)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
              <option value="">All Species</option>
            </select>
            <span id="geneFilterDisplay" class="hidden px-3 py-1 bg-gray-100 border border-gray-300 rounded-full text-sm flex items-center gap-2">
              <span id="geneFilterText"></span>
              <button onclick="clearGeneFilter()" class="text-gray-500 hover:text-gray-700">&times;</button>
            </span>
            <button id="clearFiltersBtn" onclick="clearAllFilters()" class="hidden px-3 py-2 text-gray-500 hover:text-gray-700 text-sm">
              Clear Filters
            </button>
          </div>
          
          <!-- Sales Filter Bar -->
          <div id="salesFilterBar" class="hidden mb-4 flex flex-wrap gap-2 items-center">
            <input type="text" id="salesSearchInput" placeholder="Search name or ID..." oninput="applyFilter('search', this.value)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white w-48">
            <select id="filterSalesYear" onchange="applyFilter('salesYear', this.value)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
              <option value="">All Years</option>
            </select>
            <select id="filterSalesStatus" onchange="applyFilter('salesStatus', this.value)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
              <option value="">All Status</option>
              <option value="On Hold">On Hold</option>
              <option value="Sold">Sold</option>
            </select>
          </div>
          
          <!-- Clutches Filter Bar -->
          <div id="clutchesFilterBar" class="hidden mb-4 flex flex-wrap gap-2 items-center">
            <input type="text" id="clutchSearchInput" placeholder="Search clutch ID..." oninput="applyFilter('search', this.value)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white w-48">
          </div>
          
          <!-- Alert Filter Display (shown on any table when filtering by alert) -->
          <div id="alertFilterDisplay" class="hidden mb-4">
            <span class="px-3 py-2 bg-gray-800 text-white rounded-full text-sm flex items-center gap-2 inline-flex">
              <span id="alertFilterLabel">Filter Active</span>
              <button onclick="clearAlertFilter()" class="text-gray-300 hover:text-white font-bold">&times;</button>
            </span>
          </div>

          <!-- Data table -->
          <div id="tableView" class="overflow-x-auto hidden">
            <table class="min-w-full text-sm">
              <thead id="tableHead">
                <tr class="border-b border-gray-200"></tr>
              </thead>
              <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- QR Code Generator Modal -->
  <div id="qrModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden z-50 overflow-auto">
    <div class="min-h-screen flex items-start justify-center p-4">
      <div class="w-full max-w-4xl my-8 bg-white rounded-2xl shadow-2xl">
        <div class="p-4 md:p-6 border-b border-slate-200 flex items-center justify-between">
          <h3 class="text-xl font-bold text-slate-900">Print QR Codes</h3>
          <button onclick="closeQRModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <div class="p-4 md:p-6">
          <!-- Options -->
          <div class="mb-6 flex flex-wrap gap-4 items-center">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Select Animals</label>
              <select id="qrAnimalSelect" onchange="updateQRPreview()" class="px-3 py-2 border border-gray-300 rounded-xl text-sm">
                <option value="all">All Animals</option>
                <option value="breeders">Breeders Only</option>
                <option value="hatchlings">Hatchlings Only</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Label Size</label>
              <select id="qrSizeSelect" onchange="updateQRPreview()" class="px-3 py-2 border border-gray-300 rounded-xl text-sm">
                <option value="small">Small (1" x 1")</option>
                <option value="medium" selected>Medium (1.5" x 1.5")</option>
                <option value="large">Large (2" x 2")</option>
              </select>
            </div>
            <button onclick="printQRCodes()" class="px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black text-sm">
              Print
            </button>
          </div>
          
          <!-- Preview -->
          <div id="qrPreview" class="border border-gray-200 rounded-xl p-4 bg-gray-50 max-h-96 overflow-auto">
            <p class="text-gray-500 text-sm">Loading preview...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden z-50 overflow-auto">
    <div class="min-h-screen flex items-start justify-center p-4">
      <div class="w-full max-w-4xl my-8 bg-white rounded-2xl shadow-2xl">
        <div class="p-4 md:p-6 border-b border-slate-200 flex items-center justify-between">
          <h3 class="text-xl font-bold text-slate-900">Import from MorphMarket</h3>
          <button onclick="closeImportModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <div class="p-4 md:p-6">
          <!-- Step 1: Upload -->
          <div id="importStep1">
            <div class="mb-4">
              <p class="text-gray-600 mb-4">Upload your MorphMarket CSV export file. Go to MorphMarket &gt; My Store &gt; Inventory &gt; Export to download your file.</p>
              <label class="block">
                <span class="sr-only">Choose CSV file</span>
                <input type="file" id="importFileInput" accept=".csv" onchange="handleImportFile(event)" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-gray-900 file:text-white hover:file:bg-black cursor-pointer"/>
              </label>
            </div>
          </div>
          
          <!-- Step 2: Preview -->
          <div id="importStep2" class="hidden">
            <div class="mb-4 flex items-center justify-between">
              <div>
                <span id="importCount" class="font-bold text-gray-900">0</span>
                <span class="text-gray-600">animals to import</span>
              </div>
              <div class="flex gap-2">
                <button onclick="resetImport()" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-xl hover:bg-gray-300 text-sm">
                  Back
                </button>
                <button onclick="executeImport()" id="importBtn" class="px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black text-sm">
                  Import All
                </button>
              </div>
            </div>
            
            <!-- Preview Table -->
            <div class="border border-gray-200 rounded-xl overflow-hidden">
              <div class="max-h-96 overflow-auto">
                <table class="min-w-full text-sm">
                  <thead class="bg-gray-50 sticky top-0">
                    <tr>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Action</th>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Name</th>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Manual ID</th>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Sex</th>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Status</th>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Genes</th>
                    </tr>
                  </thead>
                  <tbody id="importPreviewBody" class="divide-y divide-gray-100">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Step 3: Progress -->
          <div id="importStep3" class="hidden">
            <div class="text-center py-8">
              <div class="mb-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-gray-900"></div>
              </div>
              <p id="importProgress" class="text-gray-600 font-medium">Importing...</p>
              <p class="text-gray-400 text-sm mt-2">Please be patient - this may take a few minutes for large imports.</p>
              <p class="text-gray-400 text-sm">Do not close this window.</p>
            </div>
          </div>
          
          <!-- Step 4: Complete -->
          <div id="importStep4" class="hidden">
            <div class="text-center py-8">
              <div class="text-4xl mb-4">Done!</div>
              <p id="importResult" class="text-gray-600 mb-4">Successfully imported 0 animals.</p>
              <button onclick="closeImportModal(); loadData();" class="px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black text-sm">
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="modal" class="fixed inset-0 bg-black/50 modal-backdrop hidden z-50 overflow-auto">
    <div class="min-h-screen flex items-start justify-center p-4">
      <div class="w-full max-w-2xl my-8 bg-white rounded-2xl shadow-2xl">
        <div class="p-4 md:p-6 border-b border-slate-200 flex items-center justify-between">
          <h3 id="modalTitle" class="text-xl font-bold text-slate-900">Add New</h3>
          <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <!-- Read-only ID display -->
        <div id="modalIdDisplay" class="hidden px-4 md:px-6 pt-4">
          <div class="bg-slate-100 rounded-xl px-4 py-3">
            <div class="text-xs text-slate-500 uppercase">Unique ID</div>
            <div id="modalIdValue" class="font-bold mono text-lg"></div>
            <div class="text-xs text-slate-400">Auto-generated (read-only)</div>
          </div>
        </div>

        <div id="modalBody" class="p-4 md:p-6 max-h-[60vh] overflow-auto"></div>

        <div class="p-4 md:p-6 border-t border-slate-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
          <span id="modalError" class="text-red-600 text-sm"></span>
          <div class="flex gap-3">
            <button onclick="closeModal()" class="px-5 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200">
              Cancel
            </button>
            <button id="saveBtn" onclick="saveRecord()" class="px-5 py-2.5 bg-gray-900 text-white font-bold rounded-xl hover:bg-black">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hatch Modal -->
  <div id="hatchModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden z-50 overflow-auto">
    <div class="min-h-screen flex items-start justify-center p-4">
      <div class="w-full max-w-4xl my-8 bg-white rounded-2xl shadow-2xl">
        <div class="p-4 md:p-6 border-b border-slate-200 flex items-center justify-between">
          <div>
            <h3 class="text-xl font-bold text-slate-900">Hatch Clutch</h3>
            <p id="hatchClutchId" class="text-sm text-slate-500"></p>
          </div>
          <button onclick="closeHatchModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <div id="hatchModalBody" class="p-4 md:p-6"></div>

        <div class="p-4 md:p-6 border-t border-slate-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
          <span id="hatchModalError" class="text-red-600 text-sm"></span>
          <div class="flex flex-wrap gap-3">
            <button onclick="closeHatchModal()" class="px-5 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200">
              Cancel
            </button>
            <button id="hatchOnlyBtn" onclick="markHatchedOnly()" class="px-5 py-2.5 bg-gray-600 text-white font-bold rounded-xl hover:bg-gray-700">
              Mark Hatched Only
            </button>
            <button id="hatchAndCreateBtn" onclick="hatchAndCreateHatchlings()" class="px-5 py-2.5 bg-gray-900 text-white font-bold rounded-xl hover:bg-black">
              Hatch & Create Hatchlings
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sale Modal -->
  <div id="saleModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden z-50 overflow-auto">
    <div class="min-h-screen flex items-start justify-center p-4">
      <div class="w-full max-w-lg my-8 bg-white rounded-2xl shadow-2xl">
        <div class="p-4 md:p-6 border-b border-slate-200 flex items-center justify-between">
          <div>
            <h3 class="text-xl font-bold text-slate-900">Record Sale</h3>
            <p id="saleAnimalId" class="text-sm text-slate-500 mono"></p>
          </div>
          <button onclick="closeSaleModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <div id="saleModalBody" class="p-4 md:p-6"></div>

        <div class="p-4 md:p-6 border-t border-slate-200 flex justify-between items-center">
          <span id="saleModalError" class="text-red-600 text-sm"></span>
          <div class="flex gap-3">
            <button onclick="closeSaleModal()" class="px-5 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200">
              Cancel
            </button>
            <button id="saveSaleBtn" onclick="saveSale()" class="px-5 py-2.5 bg-gray-900 text-white font-bold rounded-xl hover:bg-black">
              Save Sale
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div id="invoiceModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden z-50 overflow-auto">
    <div class="min-h-screen flex items-start justify-center p-4">
      <div class="w-full max-w-4xl my-8 bg-white rounded-2xl shadow-2xl">
        <div class="p-4 md:p-6 border-b border-slate-200 flex items-center justify-between">
          <div>
            <h3 class="text-xl font-bold text-slate-900">Create Invoice</h3>
            <p id="invoiceNumber" class="text-sm text-slate-500 mono"></p>
          </div>
          <button onclick="closeInvoiceModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <div id="invoiceModalBody" class="p-4 md:p-6 max-h-[70vh] overflow-auto"></div>

        <div class="p-4 md:p-6 border-t border-slate-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
          <span id="invoiceModalError" class="text-red-600 text-sm"></span>
          <div class="flex flex-wrap gap-3">
            <button onclick="closeInvoiceModal()" class="px-5 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200">
              Cancel
            </button>
            <button onclick="previewInvoice()" class="px-5 py-2.5 bg-gray-600 text-white font-bold rounded-xl hover:bg-gray-700">
              Preview
            </button>
            <button onclick="downloadInvoicePDF()" class="px-5 py-2.5 bg-gray-900 text-white font-bold rounded-xl hover:bg-black">
              Download PDF
            </button>
            <button onclick="printInvoice()" class="px-5 py-2.5 bg-gray-900 text-white font-bold rounded-xl hover:bg-black">
              Print
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Preview Modal -->
  <div id="invoicePreviewModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden z-50 overflow-auto">
    <div class="min-h-screen flex items-start justify-center p-4">
      <div class="w-full max-w-4xl my-8 bg-white rounded-2xl shadow-2xl">
        <div class="p-4 md:p-6 border-b border-slate-200 flex items-center justify-between">
          <h3 class="text-xl font-bold text-slate-900">Invoice Preview</h3>
          <button onclick="closeInvoicePreview()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <div id="invoicePreviewBody" class="p-4 md:p-6 max-h-[70vh] overflow-auto bg-gray-100">
          <div id="invoicePrintArea"></div>
        </div>

        <div class="p-4 md:p-6 border-t border-slate-200 flex justify-end gap-3">
          <button onclick="closeInvoicePreview()" class="px-5 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200">
            Back to Edit
          </button>
          <button onclick="downloadInvoicePDF()" class="px-5 py-2.5 bg-gray-900 text-white font-bold rounded-xl hover:bg-black">
            Download PDF
          </button>
          <button onclick="printInvoiceFromPreview()" class="px-5 py-2.5 bg-gray-900 text-white font-bold rounded-xl hover:bg-black">
            Print
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============ CONFIGURATION ============
    var VERSION = "2.11.22";
    var API_URL = "https://script.google.com/macros/s/AKfycbxBCpAzek-NAGTLtORGt6JmenXjPlcH_p1XmuPTycZ4mSHRvkn8kFxrcd_Hu8nMAmnK/exec";
    
    var SHEET_TABS = {
      collection: "Collection",
      clutch: "Clutch", 
      activity: "Activity",
      archive: "Archive",
      settings: "Settings"
    };

    var FIELD_OPTIONS = {
      SEX: ["Female", "Male", "Unknown"],
      STATUS: ["Breeder", "Holdback", "Listed", "Unlisted", "On Hold", "Sold", "Deceased", "Retired", "On Loan"],
      CLUTCH_STATUS: ["Incubating", "Hatched", "Failed"],
      ACTIVITY: ["Took Meal", "Refused Meal", "Weight", "Shed", "Note", "Health Hold", "Paired", "Lock", "Follicle Size", "Ovulation", "Pre Lay Shed", "Laid", "Sold", "Hatched", "Clutch Went Bad"],
      SALE_SOURCE: ["MorphMarket", "Instagram", "Facebook", "Repeat Buyer", "Local Show", "Website", "Other"],
      PAYMENT_STATUS: ["Deposit", "Paid", "Refunded"]
    };

    // ============ STATE ============
    var state = {
      email: localStorage.getItem("therack_email") || "",
      sheetId: localStorage.getItem("therack_sheet_id") || "",
      isLoggedIn: false,
      isLoading: false,
      activeTab: "dashboard",
      data: { collection: [], clutch: [], activity: [], archive: [], settings: {} },
      headers: { collection: [], clutch: [], activity: [], archive: [] },
      settings: {},
      modalMode: "add",
      modalTab: null,
      editRowIndex: null,
      formData: {},
      hatchClutchRow: null,
      hatchDate: "",
      hatchCount: 1,
      hatchDrafts: [],
      saleAnimalRow: null,
      saleForm: {},
      // QR scan pending action
      qrPending: null,
      // Table filters
      filters: {
        sex: "",
        status: "",
        species: "",
        gene: "",
        salesYear: "",
        salesStatus: "",
        search: ""
      },
      // Invoice state
      invoice: {
        number: "",
        date: "",
        animals: [],
        buyerName: "",
        buyerEmail: "",
        buyerAddress: "",
        shipping: 0,
        taxRate: 0,
        notes: ""
      }
    };

    // ============ INITIALIZATION ============
    function init() {
      // Set version
      document.getElementById("versionTag").textContent = "v" + VERSION;
      
      // Check for QR code parameters in URL
      var urlParams = new URLSearchParams(window.location.search);
      var qrCode = urlParams.get('code');
      var qrAnimal = urlParams.get('animal');
      
      if (qrCode && qrAnimal) {
        // Clear URL params without reload
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Check if already logged into this account
        if (state.sheetId === qrCode && state.email) {
          state.isLoggedIn = true;
          state.qrPending = { animal: qrAnimal };
          updateUI();
          setStatus("QR scanned! Loading data...");
          loadData(); // Will trigger QR action after load
        } else {
          // Need to log in - save pending action
          state.qrPending = { code: qrCode, animal: qrAnimal };
          updateUI();
          setStatus("QR scanned for " + qrAnimal + ". Please log in to record activity.");
        }
      } else if (state.email && state.sheetId) {
        // Normal login check
        state.isLoggedIn = true;
        updateUI();
        setStatus("Welcome back! Loading your data...");
        loadData();
      } else {
        updateUI();
        setStatus("Enter your email and access code to log in.");
      }

      document.getElementById("loginBtn").addEventListener("click", handleLogin);
      document.getElementById("mobileLoginBtn").addEventListener("click", handleMobileLogin);
      document.getElementById("signOutBtn").addEventListener("click", handleSignOut);

      renderNavTabs();
    }

    // ============ MOBILE MENU ============
    function toggleMobileMenu() {
      var menu = document.getElementById("mobileMenu");
      var overlay = document.getElementById("mobileMenuOverlay");
      var isOpen = !menu.classList.contains("-translate-x-full");
      
      if (isOpen) {
        menu.classList.add("-translate-x-full");
        overlay.classList.add("hidden");
        document.body.style.overflow = "";
      } else {
        menu.classList.remove("-translate-x-full");
        overlay.classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }
    }

    function handleMobileLogin() {
      var email = document.getElementById("mobileEmailInput").value.trim().toLowerCase();
      var code = document.getElementById("mobileAccessCodeInput").value.trim();

      if (!email) {
        setStatus("Please enter your email", true);
        return;
      }
      if (!code) {
        setStatus("Please enter your access code", true);
        return;
      }

      setStatus("Logging in...");
      document.getElementById("mobileLoginBtn").textContent = "Logging in...";
      document.getElementById("mobileLoginBtn").disabled = true;

      // If QR pending, use that code
      if (state.qrPending && state.qrPending.code) {
        code = state.qrPending.code;
      }

      var url = API_URL + "?action=login&email=" + encodeURIComponent(email) + "&code=" + encodeURIComponent(code);
      
      fetch(url)
        .then(function(response) { return response.json(); })
        .then(function(data) {
          if (data.success) {
            state.email = email;
            state.sheetId = data.sheetId;
            state.isLoggedIn = true;

            localStorage.setItem("therack_email", email);
            localStorage.setItem("therack_sheet_id", data.sheetId);

            // Preserve QR animal for after load
            if (state.qrPending && state.qrPending.animal) {
              state.qrPending = { animal: state.qrPending.animal };
            }

            setStatus("Logged in! Loading your data...");
            updateUI();
            loadData();
          } else {
            setStatus(data.error || "Invalid email or access code", true);
          }
        })
        .catch(function(error) {
          setStatus("Login failed: " + error.message, true);
        })
        .finally(function() {
          document.getElementById("mobileLoginBtn").textContent = "Log In";
          document.getElementById("mobileLoginBtn").disabled = false;
        });
    }

    // ============ API HELPER ============
    function apiCall(action, params) {
      var url = API_URL + "?action=" + action;
      url += "&email=" + encodeURIComponent(state.email);
      url += "&code=" + encodeURIComponent(state.sheetId);
      
      for (var key in params) {
        if (params[key] !== undefined) {
          var value = typeof params[key] === 'object' ? JSON.stringify(params[key]) : params[key];
          url += "&" + key + "=" + encodeURIComponent(value);
        }
      }
      
      return fetch(url).then(function(response) { 
        return response.json(); 
      });
    }

    // ============ LOGIN ============
    function handleLogin() {
      var email = document.getElementById("emailInput").value.trim().toLowerCase();
      var code = document.getElementById("accessCodeInput").value.trim();

      if (!email) {
        setStatus("Please enter your email", true);
        return;
      }
      if (!code) {
        setStatus("Please enter your access code", true);
        return;
      }

      setStatus("Logging in...");
      document.getElementById("loginBtn").textContent = "Logging in...";
      document.getElementById("loginBtn").disabled = true;

      // If QR pending, use that code
      if (state.qrPending && state.qrPending.code) {
        code = state.qrPending.code;
      }

      // Validate email + code combo
      var url = API_URL + "?action=login&email=" + encodeURIComponent(email) + "&code=" + encodeURIComponent(code);
      
      fetch(url)
        .then(function(response) { return response.json(); })
        .then(function(data) {
          if (data.success) {
            // Login successful
            state.email = email;
            state.sheetId = data.sheetId;
            state.isLoggedIn = true;

            // Save to localStorage for auto-login
            localStorage.setItem("therack_email", email);
            localStorage.setItem("therack_sheet_id", data.sheetId);

            // Preserve QR animal for after load
            if (state.qrPending && state.qrPending.animal) {
              state.qrPending = { animal: state.qrPending.animal };
            }

            setStatus("Logged in! Loading your data...");
            updateUI();
            loadData();
          } else {
            setStatus(data.error || "Invalid email or access code", true);
          }
        })
        .catch(function(error) {
          setStatus("Error: " + error.message, true);
        })
        .finally(function() {
          document.getElementById("loginBtn").textContent = "Log In";
          document.getElementById("loginBtn").disabled = false;
        });
    }

    function handleSignOut() {
      state.isLoggedIn = false;
      state.email = "";
      state.sheetId = "";
      state.data = { collection: [], clutch: [], activity: [], archive: [] };
      state.headers = { collection: [], clutch: [], activity: [], archive: [] };

      localStorage.removeItem("therack_email");
      localStorage.removeItem("therack_sheet_id");

      document.getElementById("emailInput").value = "";
      document.getElementById("accessCodeInput").value = "";
      document.getElementById("mobileEmailInput").value = "";
      document.getElementById("mobileAccessCodeInput").value = "";

      updateUI();
      renderCurrentView();
      setStatus("Signed out. Enter your email and access code to log in.");
    }

    function updateUI() {
      var loginGroup = document.getElementById("loginGroup");
      var connectedGroup = document.getElementById("connectedGroup");
      var mobileLoginGroup = document.getElementById("mobileLoginGroup");
      var mobileSyncBtn = document.getElementById("mobileSyncBtn");
      var mobileUserInfo = document.getElementById("mobileUserInfo");

      if (state.isLoggedIn) {
        loginGroup.classList.add("hidden");
        connectedGroup.classList.remove("hidden");
        mobileLoginGroup.classList.add("hidden");
        mobileSyncBtn.classList.remove("hidden");
        mobileUserInfo.classList.remove("hidden");
        document.getElementById("userEmail").textContent = state.email;
        document.getElementById("mobileUserEmail").textContent = state.email;
      } else {
        loginGroup.classList.remove("hidden");
        connectedGroup.classList.add("hidden");
        mobileLoginGroup.classList.remove("hidden");
        mobileSyncBtn.classList.add("hidden");
        mobileUserInfo.classList.add("hidden");
      }
    }

    // ============ DATA LOADING ============
    function loadData() {
      if (!state.isLoggedIn) { 
        setStatus("Please log in first.", true); 
        return; 
      }

      state.isLoading = true;
      setStatus("Loading data... this may take a few seconds. No worries, we're just getting everything ready for the day!");

      apiCall('getData', {})
        .then(function(response) {
          if (response.success) {
            var data = response.data;
            
            state.headers = {
              collection: data.collection ? data.collection.headers : [],
              clutch: data.clutch ? data.clutch.headers : [],
              activity: data.activity ? data.activity.headers : [],
              archive: data.archive ? data.archive.headers : []
            };
            
            state.data = {
              collection: data.collection ? data.collection.rows : [],
              clutch: data.clutch ? data.clutch.rows : [],
              activity: data.activity ? data.activity.rows : [],
              archive: data.archive ? data.archive.rows : []
            };
            
            console.log("=== DATA LOAD DEBUG ===");
            console.log("API Response data:", data);
            console.log("data.clutch:", data.clutch);
            console.log("state.data.clutch:", state.data.clutch);
            console.log("state.data.clutch.length:", state.data.clutch.length);
            console.log("state.data.collection.length:", state.data.collection.length);
            console.log("state.data.archive:", state.data.archive);
            console.log("=== END DATA LOAD DEBUG ===");

            // Parse settings (key-value pairs)
            state.settings = {};
            if (data.settings && data.settings.rows) {
              data.settings.rows.forEach(function(row) {
                var field = row["FIELD"] || row["Field"] || "";
                var value = row["VALUE"] || row["Value"] || "";
                if (field) {
                  state.settings[field.toUpperCase()] = value;
                }
              });
            }

            // Count only non-empty rows for display
            var animalCount = state.data.collection.filter(function(r) {
              return (r.STATUS || "").trim() !== "" || (r["UNIQUE ID"] || "").trim() !== "";
            }).length;
            var clutchCount = state.data.clutch.filter(function(r) {
              return (r.STATUS || "").trim() !== "" || (r["CLUTCH ID"] || "").trim() !== "";
            }).length;
            var activityCount = state.data.activity.filter(function(r) {
              return (r.ACTIVITY || "").trim() !== "" || (r["UNIQUE ID"] || "").trim() !== "";
            }).length;

            setStatus("Loaded " + animalCount + " animals, " + 
                      clutchCount + " clutches, " + 
                      activityCount + " activities");
            
            // Update UI with settings
            updateUIWithSettings();
            renderCurrentView();
            
            // Check for pending QR action
            if (state.qrPending && state.qrPending.animal) {
              handleQRScan(state.qrPending.animal);
              state.qrPending = null;
            }
          } else {
            setStatus(response.error || "Failed to load data", true);
          }
        })
        .catch(function(error) {
          setStatus("Error loading data: " + error.message, true);
        })
        .finally(function() {
          state.isLoading = false;
        });
    }
    
    function updateUIWithSettings() {
      // Update business name in header if set
      var businessName = state.settings["BUSINESS NAME"];
      if (businessName) {
        var taglineEl = document.querySelector('.tagline-text');
        if (taglineEl) {
          taglineEl.textContent = businessName;
        }
      }
    }

    function setStatus(msg, isError) {
      var el = document.getElementById("statusText");
      el.textContent = msg;
      el.className = isError ? "text-red-600" : "text-slate-500";
    }

    // ============ QR CODE HANDLING ============
    function handleQRScan(animalId) {
      // Find the animal in collection
      var animal = state.data.collection.find(function(r) {
        return r["UNIQUE ID"] === animalId;
      });
      
      if (!animal) {
        setStatus("Animal " + animalId + " not found in your collection.", true);
        return;
      }
      
      // Open activity modal pre-filled for this animal
      openActivityForAnimal(animal);
    }

    function openActivityForAnimal(animal) {
      state.modalMode = "add";
      state.modalTab = "activity";
      state.editRowIndex = null;
      state.formData = {
        "DATE": new Date().toISOString().split('T')[0],
        "UNIQUE ID": animal["UNIQUE ID"]
      };
      
      renderActivityModalForQR(animal);
      document.getElementById("modal").classList.remove("hidden");
    }

    // Quick Activity modal - called from + Activity button on tables
    function openQuickActivityModal(row) {
      // For clutches, we need to handle differently - log activity for the clutch
      if (state.activeTab === "clutches") {
        // For clutches, open a note activity with the clutch ID
        state.modalMode = "add";
        state.modalTab = "activity";
        state.editRowIndex = null;
        state.formData = {
          "DATE": new Date().toISOString().split('T')[0],
          "UNIQUE ID": row["CLUTCH ID"] || ""
        };
        
        var clutchInfo = {
          "ANIMAL NAME": "Clutch: " + (row["CLUTCH ID"] || "Unknown"),
          "UNIQUE ID": row["CLUTCH ID"] || ""
        };
        renderActivityModalForQR(clutchInfo, true); // true = isClutch
        document.getElementById("modal").classList.remove("hidden");
      } else {
        // For collection/hatchlings, use the existing function
        openActivityForAnimal(row);
      }
    }

    function renderActivityModalForQR(animal, isClutch) {
      var animalName = animal["ANIMAL NAME"] || animal["UNIQUE ID"];
      var animalId = animal["UNIQUE ID"];
      
      document.getElementById("modalTitle").textContent = isClutch ? "Log Clutch Activity" : "Log Activity";
      
      var html = '<div class="space-y-4">';
      
      // Animal/Clutch info banner
      html += '<div class="bg-gray-100 rounded-xl p-3 mb-4">';
      html += '<div class="font-bold text-gray-900">' + animalName + '</div>';
      html += '<div class="text-sm text-gray-500 mono">' + animalId + '</div>';
      html += '</div>';
      
      // Date (default today)
      html += '<div>';
      html += '<label class="block text-sm font-medium text-gray-700 mb-1">Date</label>';
      html += '<input type="date" id="field_DATE" value="' + state.formData["DATE"] + '" class="w-full px-3 py-2 border border-gray-300 rounded-xl">';
      html += '</div>';
      
      // Activity type - big buttons for quick tap
      html += '<div>';
      html += '<label class="block text-sm font-medium text-gray-700 mb-2">Activity</label>';
      html += '<div class="grid grid-cols-2 gap-2">';
      
      // Different activities for clutches vs animals
      var quickActivities;
      if (isClutch) {
        quickActivities = ["Hatched", "Clutch Went Bad", "Note"];
      } else {
        // Row 1: Feeding
        quickActivities = [
          "Took Meal", "Refused Meal",
          // Row 2: General
          "Shed", "Weight",
          // Row 3: Breeding
          "Paired", "Lock",
          // Row 4: Female specific
          "Ovulation", "Pre Lay Shed",
          // Row 5: Other
          "Note", "Health Hold"
        ];
      }
      
      quickActivities.forEach(function(act) {
        var selected = state.formData["ACTIVITY"] === act ? "bg-gray-900 text-white" : "bg-gray-100 text-gray-700 hover:bg-gray-200";
        html += '<button type="button" onclick="selectQRActivity(\'' + act + '\')" class="qr-activity-btn px-4 py-3 rounded-xl font-medium text-sm ' + selected + '">' + act + '</button>';
      });
      
      html += '</div>';
      html += '</div>';
      
      // Value field (for weight, notes, etc)
      var showValueField = state.formData["ACTIVITY"] === "Weight" || 
                           state.formData["ACTIVITY"] === "Note" || 
                           state.formData["ACTIVITY"] === "Hatched" || 
                           state.formData["ACTIVITY"] === "Clutch Went Bad" ||
                           state.formData["ACTIVITY"] === "Health Hold" ||
                           state.formData["ACTIVITY"] === "Ovulation";
      html += '<div id="qrValueField" class="' + (showValueField ? "" : "hidden") + '">';
      html += '<label class="block text-sm font-medium text-gray-700 mb-1" id="qrValueLabel">Value</label>';
      html += '<input type="text" id="field_VALUE" value="' + (state.formData["VALUE"] || "") + '" class="w-full px-3 py-2 border border-gray-300 rounded-xl" placeholder="Enter value...">';
      html += '</div>';
      
      // Paired With field (for Paired/Lock activities)
      var showPairedField = state.formData["ACTIVITY"] === "Paired" || state.formData["ACTIVITY"] === "Lock";
      html += '<div id="qrPairedField" class="' + (showPairedField ? "" : "hidden") + '">';
      html += '<label class="block text-sm font-medium text-gray-700 mb-1">Paired With</label>';
      html += '<select id="field_PAIRED_WITH" class="w-full px-3 py-2 border border-gray-300 rounded-xl">';
      html += '<option value="">Select animal...</option>';
      // Get list of breeders
      var breeders = state.data.collection.filter(function(r) {
        var st = (r.STATUS || "").toLowerCase();
        return st === "breeder" || st === "holdback" || st === "on loan";
      });
      breeders.forEach(function(b) {
        var bName = b["ANIMAL NAME"] || "";
        var bId = b["UNIQUE ID"] || "";
        var label = bName ? bName + " | " + bId : bId;
        var selected = (state.formData["PAIRED_WITH"] === label) ? " selected" : "";
        html += '<option value="' + escapeHtml(label) + '"' + selected + '>' + escapeHtml(label) + '</option>';
      });
      html += '</select>';
      html += '</div>';
      
      html += '</div>';
      
      document.getElementById("modalBody").innerHTML = html;
      
      // Update save button
      document.getElementById("saveBtn").onclick = saveQRActivity;
    }

    function selectQRActivity(activity) {
      state.formData["ACTIVITY"] = activity;
      
      // Update button styles
      document.querySelectorAll('.qr-activity-btn').forEach(function(btn) {
        if (btn.textContent === activity) {
          btn.className = 'qr-activity-btn px-4 py-3 rounded-xl font-medium text-sm bg-gray-900 text-white';
        } else {
          btn.className = 'qr-activity-btn px-4 py-3 rounded-xl font-medium text-sm bg-gray-100 text-gray-700 hover:bg-gray-200';
        }
      });
      
      // Show/hide value field
      var valueField = document.getElementById('qrValueField');
      var valueLabel = document.getElementById('qrValueLabel');
      var pairedField = document.getElementById('qrPairedField');
      
      // Hide paired field by default
      if (pairedField) pairedField.classList.add('hidden');
      
      if (activity === "Weight") {
        valueField.classList.remove('hidden');
        valueLabel.textContent = "Weight (g)";
      } else if (activity === "Note" || activity === "Health Hold") {
        valueField.classList.remove('hidden');
        valueLabel.textContent = "Notes";
      } else if (activity === "Hatched") {
        valueField.classList.remove('hidden');
        valueLabel.textContent = "# Hatched";
      } else if (activity === "Clutch Went Bad") {
        valueField.classList.remove('hidden');
        valueLabel.textContent = "Reason (optional)";
      } else if (activity === "Ovulation") {
        valueField.classList.remove('hidden');
        valueLabel.textContent = "Follicle Size (mm)";
      } else if (activity === "Paired" || activity === "Lock") {
        valueField.classList.add('hidden');
        if (pairedField) pairedField.classList.remove('hidden');
      } else {
        valueField.classList.add('hidden');
      }
    }

    function saveQRActivity() {
      var date = document.getElementById("field_DATE").value;
      var activity = state.formData["ACTIVITY"];
      var value = document.getElementById("field_VALUE") ? document.getElementById("field_VALUE").value : "";
      var pairedWith = document.getElementById("field_PAIRED_WITH") ? document.getElementById("field_PAIRED_WITH").value : "";
      
      if (!activity) {
        setStatus("Please select an activity", true);
        return;
      }
      
      // For Paired/Lock, use the paired animal as the value
      if ((activity === "Paired" || activity === "Lock") && pairedWith) {
        value = pairedWith;
      }
      
      var record = {
        "DATE": date,
        "UNIQUE ID": state.formData["UNIQUE ID"],
        "ACTIVITY": activity,
        "VALUE": value
      };
      
      // Save to sheet
      setStatus("Saving...");
      document.getElementById("saveBtn").textContent = "Saving...";
      document.getElementById("saveBtn").disabled = true;
      
      apiCall('saveRecord', { tab: 'Activity', data: record })
        .then(function(response) {
          if (response.success) {
            // Add to local data
            record.__rowIndex = state.data.activity.length;
            state.data.activity.push(record);
            
            setStatus("Activity logged for " + state.formData["UNIQUE ID"]);
            closeModal();
          } else {
            setStatus(response.error || "Failed to save", true);
          }
        })
        .catch(function(error) {
          setStatus("Error: " + error.message, true);
        })
        .finally(function() {
          document.getElementById("saveBtn").textContent = "Save";
          document.getElementById("saveBtn").disabled = false;
        });
    }

    // ============ NAVIGATION ============
    var navHistory = [];

    function renderNavTabs() {
      var tabs = [
        { key: "dashboard", label: "Dashboard" },
        { key: "collection", label: "Collection" },
        { key: "clutches", label: "Clutches" },
        { key: "pairings", label: "Pairings" },
        { key: "hatchlings", label: "Hatchlings" },
        { key: "sales", label: "Sales" },
        { key: "activity", label: "Activity" }
      ];
      
      // Desktop nav
      var nav = document.getElementById("navTabs");
      nav.innerHTML = "";
      tabs.forEach(function(tab) {
        var btn = document.createElement("button");
        btn.textContent = tab.label;
        btn.className = "px-3 py-2 text-sm rounded-lg font-medium text-left " + 
          (state.activeTab === tab.key ? "bg-gray-900 text-white" : "text-gray-600 hover:bg-gray-100");
        btn.onclick = function() { navigateTo(tab.key); };
        nav.appendChild(btn);
      });

      // Mobile nav
      var mobileNav = document.getElementById("mobileNavTabs");
      mobileNav.innerHTML = "";
      tabs.forEach(function(tab) {
        var btn = document.createElement("button");
        btn.textContent = tab.label;
        btn.className = "px-3 py-2 text-sm rounded-lg font-medium text-left " + 
          (state.activeTab === tab.key ? "bg-gray-900 text-white" : "text-gray-600 hover:bg-gray-100");
        btn.onclick = function() { navigateTo(tab.key); toggleMobileMenu(); };
        mobileNav.appendChild(btn);
      });
    }

    function navigateTo(tab) {
      if (state.activeTab !== tab) {
        navHistory.push(state.activeTab);
        state.activeTab = tab;
        renderNavTabs();
        renderCurrentView();
      }
    }

    function goBack() {
      if (navHistory.length > 0) {
        state.activeTab = navHistory.pop();
        renderNavTabs();
        renderCurrentView();
      }
    }

    function renderCurrentView() {
      var titles = {
        dashboard: "Dashboard",
        collection: "Collection",
        clutches: "Clutches",
        pairings: "Pairings",
        hatchlings: "Hatchlings",
        sales: "Sales",
        activity: "Activity",
        archive: "Archive"
      };
      document.getElementById("pageTitle").textContent = titles[state.activeTab] || state.activeTab;
      var isDash = state.activeTab === "dashboard";
      var isArchive = state.activeTab === "archive";
      document.getElementById("dashboardView").classList.toggle("hidden", !isDash);
      document.getElementById("tableView").classList.toggle("hidden", isDash || isArchive);
      document.getElementById("addBtn").classList.toggle("hidden", isDash || isArchive || state.activeTab === "pairings");
      
      // Always hide filter bar and stats on dashboard/archive
      if (isDash || isArchive) {
        document.getElementById("filterBar").classList.add("hidden");
        document.getElementById("tableStatsView").classList.add("hidden");
        document.getElementById("tableStatsView").innerHTML = '';
      }
      
      // Show/hide back button
      document.getElementById("backBtn").classList.toggle("hidden", navHistory.length === 0);
      
      if (isDash) renderDashboard();
      else if (isArchive) renderArchiveView();
      else renderTable();
    }

    // ============ DASHBOARD ============
    function renderDashboard() {
      var stats = calculateStats();
      var html = '';
      
      // Alerts Section (only show if there are alerts)
      var hasAlerts = stats.overdueClutches > 0 || stats.clutchesDueSoon > 0 || stats.unshipped > 0 || 
                      stats.needsSexing > 0 || stats.readyToList > 0 ||
                      stats.unpaidDeposits > 0 || stats.shippingSoon > 0 || stats.unpaidBalance > 0;
      
      if (hasAlerts) {
        html += '<div class="mb-8">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-900 font-semibold mb-3">ALERTS</div>';
        html += '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">';
        
        //  Overdue Clutches (DARKEST - most urgent)
        if (stats.overdueClutches > 0) {
          html += '<div onclick="filterByAlert(\'overdueClutches\');" class="cursor-pointer bg-gradient-to-br from-gray-700 to-gray-800 border-2 border-gray-900 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-300">Overdue Clutches</div>';
          html += '<div class="text-2xl font-black text-white">' + stats.overdueClutches + '</div>';
          html += '</div>';
          html += '';
          html += '</div>';
          html += '</div>';
        }
        
        //  Clutches Due Soon (DARK)
        if (stats.clutchesDueSoon > 0) {
          html += '<div onclick="filterByAlert(\'clutchesDueSoon\');" class="cursor-pointer bg-gradient-to-br from-gray-500 to-gray-600 border-2 border-gray-700 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-200">Due Within 7 Days</div>';
          html += '<div class="text-2xl font-black text-white">' + stats.clutchesDueSoon + '</div>';
          html += '</div>';
          html += '';
          html += '</div>';
          html += '</div>';
        }
        
        //  Unshipped Sales (MEDIUM-DARK)
        if (stats.unshipped > 0) {
          html += '<div onclick="filterByAlert(\'unshipped\');" class="cursor-pointer bg-gradient-to-br from-gray-400 to-gray-500 border-2 border-gray-600 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-100">Unshipped Sales</div>';
          html += '<div class="text-2xl font-black text-white">' + stats.unshipped + '</div>';
          html += '</div>';
          html += '';
          html += '</div>';
          html += '</div>';
        }
        
        //  Shipping Soon (MEDIUM)
        if (stats.shippingSoon > 0) {
          html += '<div onclick="filterByAlert(\'shippingSoon\');" class="cursor-pointer bg-gradient-to-br from-gray-300 to-gray-400 border-2 border-gray-500 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-700">Shipping in 3 Days</div>';
          html += '<div class="text-2xl font-black text-gray-900">' + stats.shippingSoon + '</div>';
          html += '</div>';
          html += '';
          html += '</div>';
          html += '</div>';
        }
        
        //  Unpaid Deposits (MEDIUM)
        if (stats.unpaidDeposits > 0) {
          html += '<div onclick="filterByAlert(\'unpaidDeposits\');" class="cursor-pointer bg-gradient-to-br from-gray-300 to-gray-400 border-2 border-gray-500 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-700">Unpaid Deposits</div>';
          html += '<div class="text-2xl font-black text-gray-900">' + stats.unpaidDeposits + '</div>';
          html += '</div>';
          html += '';
          html += '</div>';
          html += '</div>';
        }
        
        // Balance Due (MEDIUM) - Sold Price > Total Paid
        if (stats.unpaidBalance > 0) {
          html += '<div onclick="filterByAlert(\'balanceDue\');" class="cursor-pointer bg-gradient-to-br from-gray-300 to-gray-400 border-2 border-gray-500 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-700">Balance Due</div>';
          html += '<div class="text-2xl font-black text-gray-900">' + stats.unpaidBalance + '</div>';
          html += '</div>';
          html += '';
          html += '</div>';
          html += '</div>';
        }
        
        // Needs Sexing (LIGHT)
        if (stats.needsSexing > 0) {
          html += '<div onclick="filterByAlert(\'needsSexing\');" class="cursor-pointer bg-gradient-to-br from-gray-200 to-gray-300 border-2 border-gray-400 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-600">Needs Sexing</div>';
          html += '<div class="text-2xl font-black text-gray-900">' + stats.needsSexing + '</div>';
          html += '</div>';
          html += '';
          html += '</div>';
          html += '</div>';
        }
        
        //  Ready to List (LIGHTEST)
        if (stats.readyToList > 0) {
          html += '<div onclick="filterByAlert(\'readyToList\');" class="cursor-pointer bg-gradient-to-br from-gray-100 to-gray-200 border-2 border-gray-300 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-600">Ready to List</div>';
          html += '<div class="text-2xl font-black text-gray-900">' + stats.readyToList + '</div>';
          html += '</div>';
          html += '';
          html += '</div>';
          html += '</div>';
        }
        
        html += '</div></div>';
      }
      
      // Breeders Section
      html += '<div class="mb-8"><div class="text-xs uppercase tracking-wider text-slate-500 font-semibold mb-3">Breeders</div>';
      html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
      html += statCard("Total Breeders", stats.totalBreeders, "slate", null, "state.activeTab=&#39;collection&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Males", stats.maleBreeders, "blue", Math.round(stats.malePct * 100) + "%", "state.activeTab=&#39;collection&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Females", stats.femaleBreeders, "pink", Math.round(stats.femalePct * 100) + "%", "state.activeTab=&#39;collection&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Holdbacks", stats.holdbacks, "amber", null, "state.activeTab=&#39;collection&#39;; renderNavTabs(); renderCurrentView();");
      html += '</div></div>';

      // Clutches Section
      html += '<div class="mb-8"><div class="text-xs uppercase tracking-wider text-slate-500 font-semibold mb-3">Incubator</div>';
      html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
      html += statCard("Incubating", stats.incubating, "green", null, "state.activeTab=&#39;clutches&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Hatched (Year)", stats.hatchedThisYear, "emerald", null, "state.activeTab=&#39;clutches&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Avg Days to Hatch", stats.avgDaysToHatch, "teal");
      html += statCard("Avg Fertile Eggs", stats.avgFertileEggs, "cyan");
      html += '</div></div>';

      // Hatchlings Section
      html += '<div class="mb-8"><div class="text-xs uppercase tracking-wider text-slate-500 font-semibold mb-3">Hatchlings</div>';
      html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
      html += statCard("Listed", stats.listed, "violet", null, "state.activeTab=&#39;hatchlings&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Unlisted", stats.unlisted, "slate", null, "state.activeTab=&#39;hatchlings&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Females", stats.hatchFemales, "pink", "Unknown: " + stats.hatchUnknown, "state.activeTab=&#39;hatchlings&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Males", stats.hatchMales, "blue", "Unknown: " + stats.hatchUnknown, "state.activeTab=&#39;hatchlings&#39;; renderNavTabs(); renderCurrentView();");
      html += '</div></div>';

      // Activity Section (This Month Stats)
      var activityStats = calculateActivityStats();
      html += '<div class="mb-8"><div class="text-xs uppercase tracking-wider text-slate-500 font-semibold mb-3">Activity (This Month)</div>';
      html += '<div class="grid grid-cols-2 md:grid-cols-6 gap-4">';
      html += statCard("Took Meal", activityStats.tookMeal, "green", null, "state.activeTab=&#39;activity&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Refused Meal", activityStats.refusedMeal, "orange", null, "state.activeTab=&#39;activity&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Paired", activityStats.paired, "blue", null, "state.activeTab=&#39;activity&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Locked", activityStats.locked, "violet", null, "state.activeTab=&#39;activity&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Ovulation", activityStats.ovulation, "pink", null, "state.activeTab=&#39;activity&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Laid", activityStats.laid, "emerald", null, "state.activeTab=&#39;activity&#39;; renderNavTabs(); renderCurrentView();");
      html += '</div></div>';

      // Sales Section
      html += '<div class="mb-8"><div class="text-xs uppercase tracking-wider text-slate-500 font-semibold mb-3">Sales (This Year)</div>';
      html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
      html += statCard("Sold", stats.soldThisYear, "green", null, "state.activeTab=&#39;sales&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Revenue", stats.revenueDisplay, "emerald", null, "state.activeTab=&#39;sales&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("On Hold", stats.onHold, "orange", null, "state.activeTab=&#39;sales&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Unshipped", stats.unshipped, "red", null, "state.activeTab=&#39;sales&#39;; renderNavTabs(); renderCurrentView();");
      html += '</div></div>';

      // Last Year Sales Section
      html += '<div class="mb-8"><div class="text-xs uppercase tracking-wider text-slate-400 font-semibold mb-3">Sales (Last Year)</div>';
      html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
      html += statCard("Sold", stats.soldLastYear, "slate", null, null);
      html += statCard("Revenue", stats.revenueLastYearDisplay, "slate", null, null);
      html += '</div></div>';

      document.getElementById("dashboardView").innerHTML = html;
    }

    function statCard(label, value, color, subtitle, onclick) {
      var colors = {
        slate: "from-gray-50 to-gray-100 text-gray-900",
        gray: "from-gray-50 to-gray-100 text-gray-900",
        charcoal: "from-gray-200 to-gray-300 text-gray-900",
        dark: "from-gray-300 to-gray-400 text-gray-900",
        blue: "from-gray-100 to-gray-200 text-gray-900",
        pink: "from-gray-100 to-gray-200 text-gray-900",
        amber: "from-gray-200 to-gray-300 text-gray-900",
        green: "from-gray-100 to-gray-200 text-gray-900",
        emerald: "from-gray-150 to-gray-250 text-gray-900",
        teal: "from-gray-100 to-gray-200 text-gray-900",
        cyan: "from-gray-50 to-gray-100 text-gray-900",
        violet: "from-gray-200 to-gray-300 text-gray-900",
        orange: "from-gray-150 to-gray-250 text-gray-900",
        red: "from-gray-300 to-gray-400 text-gray-900"
      };
      var sub = subtitle ? '<div class="text-xs opacity-60 mt-1">' + subtitle + '</div>' : '';
      var clickClass = onclick ? ' cursor-pointer hover:shadow-lg transition-shadow' : '';
      var clickAttr = onclick ? ' onclick="' + onclick + '"' : '';
      return '<div class="bg-gradient-to-br ' + colors[color] + ' rounded-2xl p-4 md:p-5 stat-card border border-gray-200' + clickClass + '"' + clickAttr + '>' +
             '<div class="text-xs uppercase tracking-wider opacity-70">' + label + '</div>' +
             '<div class="text-2xl md:text-4xl font-black mt-1">' + value + '</div>' + sub + '</div>';
    }

    function calculateStats() {
      // Filter out empty rows (rows without a STATUS or UNIQUE ID)
      var rows = state.data.collection.filter(function(r) {
        return (r.STATUS || "").trim() !== "" || (r["UNIQUE ID"] || "").trim() !== "";
      });
      var clutchRows = state.data.clutch.filter(function(r) {
        return (r.STATUS || "").trim() !== "" || (r["CLUTCH ID"] || "").trim() !== "";
      });
      var year = new Date().getFullYear();
      var today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Date for "due soon" (7 days from now)
      var sevenDaysOut = new Date(today);
      sevenDaysOut.setDate(sevenDaysOut.getDate() + 7);
      
      // Date for "ready to list" (30 days ago)
      var thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      // Date for "shipping soon" (3 days from now)
      var threeDaysOut = new Date(today);
      threeDaysOut.setDate(threeDaysOut.getDate() + 3);
      
      var s = {
        totalBreeders: 0, maleBreeders: 0, femaleBreeders: 0, holdbacks: 0,
        incubating: 0, hatchedThisYear: 0, avgDaysToHatch: "--", avgFertileEggs: "--",
        listed: 0, unlisted: 0, hatchMales: 0, hatchFemales: 0, hatchUnknown: 0,
        soldThisYear: 0, revenue: 0, revenueDisplay: "$0", onHold: 0, unshipped: 0,
        // Last year stats
        soldLastYear: 0, revenueLastYear: 0, revenueLastYearDisplay: "$0",
        malePct: 0, femalePct: 0,
        // Alerts
        overdueClutches: 0, 
        clutchesDueSoon: 0,
        needsSexing: 0,
        readyToList: 0,
        unpaidDeposits: 0,
        shippingSoon: 0,
        unpaidBalance: 0
      };
      
      var lastYear = year - 1;

      rows.forEach(function(r) {
        var st = (r.STATUS || "").toLowerCase().trim();
        var sex = (r.SEX || "").toLowerCase().trim();
        var dob = parseDate(r["DATE OF BIRTH"]);
        var paymentStatus = (r["PAYMENT STATUS"] || "").toLowerCase().trim();
        var shipDate = parseDate(r["SHIP DATE"]);
        
        // Breeders
        if (st === "breeder" || st === "on loan") {
          s.totalBreeders++;
          if (sex.startsWith("m")) s.maleBreeders++;
          if (sex.startsWith("f")) s.femaleBreeders++;
        }
        if (st === "holdback") s.holdbacks++;
        
        // Hatchlings (listed/unlisted)
        if (st === "listed" || st === "for sale") {
          s.listed++;
          countSex(sex, s, "hatch");
        }
        if (st === "unlisted" || st === "not listed") {
          s.unlisted++;
          countSex(sex, s, "hatch");
          // Needs sexing (unlisted with unknown sex)
          if (!sex || sex === "unknown") s.needsSexing++;
          // Ready to list (unlisted, 30+ days old)
          if (dob && dob <= thirtyDaysAgo) s.readyToList++;
        }
        
        // Sales
        if (st === "on hold" || st === "hold") {
          s.onHold++;
          // Check for unpaid deposits (old method)
          if (paymentStatus === "deposit") s.unpaidDeposits++;
          // Check shipping soon
          if (shipDate && shipDate >= today && shipDate <= threeDaysOut) s.shippingSoon++;
          // Check for unpaid balance (sold price vs total paid)
          var soldPrice = parseFloat(r["SOLD PRICE"]) || 0;
          var totalPaid = parseFloat(r["TOTAL PAID"]) || 0;
          if (soldPrice > 0 && totalPaid < soldPrice) {
            s.unpaidBalance++;
          }
        }
        if (st === "sold") {
          var soldYear = getYearFromDate(r["DATE SOLD"]);
          var price = parseFloat(r["SOLD PRICE"]) || 0;
          if (soldYear === year) {
            s.soldThisYear++;
            s.revenue += price;
          }
          // Last year sales
          if (soldYear === lastYear) {
            s.soldLastYear++;
            s.revenueLastYear += price;
          }
          // Unshipped = ship date within next 7 days (or past due)
          var shipDate = parseDate(r["SHIP DATE"]);
          if (shipDate && shipDate <= sevenDaysOut) {
            s.unshipped++;
          }
          // Check shipping soon for sold items too
          if (shipDate && shipDate >= today && shipDate <= threeDaysOut) s.shippingSoon++;
          // Check for unpaid balance (sold price vs total paid)
          var totalPaid = parseFloat(r["TOTAL PAID"]) || 0;
          if (price > 0 && totalPaid < price) {
            s.unpaidBalance++;
          }
        }
      });

      // Breeder percentages
      if (s.totalBreeders > 0) {
        s.malePct = s.maleBreeders / s.totalBreeders;
        s.femalePct = s.femaleBreeders / s.totalBreeders;
      }

      // Clutch stats
      var daysSum = 0, daysCount = 0, fertileSum = 0, fertileCount = 0;
      clutchRows.forEach(function(r) {
        var st = (r.STATUS || "").toLowerCase().trim();
        if (st === "incubating") {
          s.incubating++;
          // Check if overdue or due soon
          var estHatchDate = r["EST. HATCH DATE"] || r["EST HATCH DATE"] || r["ESTIMATED HATCH DATE"] || "";
          if (estHatchDate) {
            var estDate = parseDate(estHatchDate);
            if (estDate) {
              if (estDate < today) {
                s.overdueClutches++;
              } else if (estDate >= today && estDate <= sevenDaysOut) {
                s.clutchesDueSoon++;
              }
            }
          }
        }
        if (st === "hatched") {
          var hatchDate = parseDate(r["HATCH DATE"]);
          if (hatchDate && hatchDate.getFullYear() === year) s.hatchedThisYear++;
          
          var layDate = parseDate(r["LAY DATE"]);
          if (hatchDate && layDate) {
            var days = Math.round((hatchDate - layDate) / 86400000);
            if (days > 0 && days < 100) { daysSum += days; daysCount++; }
          }
          
          var fertile = parseInt(r["# FERTILE"]) || 0;
          if (fertile > 0) { fertileSum += fertile; fertileCount++; }
        }
      });
      
      if (daysCount > 0) s.avgDaysToHatch = Math.round(daysSum / daysCount);
      if (fertileCount > 0) s.avgFertileEggs = Math.round(fertileSum / fertileCount);
      s.revenueDisplay = "$" + Math.round(s.revenue).toLocaleString();
      s.revenueLastYearDisplay = "$" + Math.round(s.revenueLastYear).toLocaleString();

      return s;
    }

    function countSex(sex, stats, prefix) {
      if (sex.startsWith("m")) stats[prefix + "Males"]++;
      else if (sex.startsWith("f")) stats[prefix + "Females"]++;
      else stats[prefix + "Unknown"]++;
    }
    
    // Calculate sales stats for a specific year
    function calculateSalesStatsForYear(year) {
      var rows = state.data.collection || [];
      var sold = 0;
      var revenue = 0;
      
      rows.forEach(function(r) {
        var st = (r.STATUS || "").toLowerCase().trim();
        if (st === "sold") {
          var rawDate = r["DATE SOLD"];
          var price = parseFloat(r["SOLD PRICE"]) || 0;
          
          // Extract year from date - handle multiple formats
          var dateYear = null;
          if (rawDate) {
            // Try to get year from various formats
            if (typeof rawDate === 'string') {
              // Format: "2025-04-10" or "2025-04-10 00:00:00" or "4/10/2025"
              var match = rawDate.match(/(\d{4})/);
              if (match) {
                dateYear = parseInt(match[1]);
              }
            } else if (rawDate instanceof Date || (rawDate && rawDate.getFullYear)) {
              dateYear = rawDate.getFullYear();
            } else if (typeof rawDate === 'number') {
              // Could be Excel serial date or timestamp
              var d = new Date(rawDate);
              if (!isNaN(d.getTime())) {
                dateYear = d.getFullYear();
              }
            }
          }
          
          // If year filter is set, only count that year
          if (year) {
            if (dateYear === year) {
              sold++;
              revenue += price;
            }
          } else {
            // No year filter - count all
            sold++;
            revenue += price;
          }
        }
      });
      
      return { sold: sold, revenue: Math.round(revenue) };
    }

    function calculateActivityStats() {
      var rows = state.data.activity || [];
      var now = new Date();
      var currentMonth = now.getMonth();
      var currentYear = now.getFullYear();
      
      var stats = {
        feedingsMonth: 0,
        refusalsMonth: 0,
        shedsMonth: 0,
        ovulationsMonth: 0,
        // For dashboard (this month)
        tookMeal: 0,
        refusedMeal: 0,
        paired: 0,
        locked: 0,
        ovulation: 0,
        laid: 0,
        // For pairings view (this year)
        pairedYear: 0,
        lockedYear: 0
      };
      
      rows.forEach(function(r) {
        var activity = (r.ACTIVITY || "").toLowerCase().trim();
        var activityDate = parseDate(r.DATE);
        
        // Check if this month
        var isThisMonth = false;
        if (activityDate) {
          isThisMonth = (activityDate.getMonth() === currentMonth && activityDate.getFullYear() === currentYear);
        }
        
        // Count for Activity table stats (this month only)
        if (isThisMonth) {
          if (activity === "took meal") stats.feedingsMonth++;
          if (activity === "refused meal") stats.refusalsMonth++;
          if (activity === "shed") stats.shedsMonth++;
          if (activity === "ovulation") stats.ovulationsMonth++;
        }
        
        // Count for Dashboard (this month)
        if (isThisMonth) {
          if (activity === "took meal") stats.tookMeal++;
          if (activity === "refused meal") stats.refusedMeal++;
          if (activity === "paired") stats.paired++;
          if (activity === "lock") stats.locked++;
          if (activity === "ovulation") stats.ovulation++;
          if (activity === "laid") stats.laid++;
        }
        
        // Count for Pairings view (this year)
        var isThisYear = false;
        if (activityDate) {
          isThisYear = (activityDate.getFullYear() === currentYear);
        }
        if (isThisYear) {
          if (activity === "paired") stats.pairedYear++;
          if (activity === "lock") stats.lockedYear++;
        }
      });
      
      return stats;
    }

    // Extract year from various date formats without full parsing
    function getYearFromDate(rawDate) {
      if (!rawDate) return null;
      
      if (typeof rawDate === 'string') {
        // Look for 4-digit year pattern
        var match = rawDate.match(/(\d{4})/);
        if (match) {
          return parseInt(match[1]);
        }
      } else if (rawDate instanceof Date || (rawDate && typeof rawDate.getFullYear === 'function')) {
        return rawDate.getFullYear();
      } else if (typeof rawDate === 'number') {
        // Could be timestamp
        var d = new Date(rawDate);
        if (!isNaN(d.getTime()) && d.getFullYear() > 1990) {
          return d.getFullYear();
        }
      }
      return null;
    }

    function parseDate(v) {
      if (!v) return null;
      var d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }

    // Get animal name by UNIQUE ID
    function getAnimalNameById(uniqueId) {
      if (!uniqueId) return "";
      var rows = state.data.collection || [];
      for (var i = 0; i < rows.length; i++) {
        if (rows[i]["UNIQUE ID"] === uniqueId) {
          return rows[i]["ANIMAL NAME"] || "";
        }
      }
      return "";
    }

    // ============ TABLE ============
    function renderTable() {
      var columns = getColumns();
      var rows = getFilteredRows();
      var showHatch = state.activeTab === "clutches";
      var showSale = state.activeTab === "hatchlings";

      // Render stats cards for this view
      renderTableStats();
      
      // Show/hide filter bars based on tab
      var filterBar = document.getElementById("filterBar");
      var salesFilterBar = document.getElementById("salesFilterBar");
      var clutchesFilterBar = document.getElementById("clutchesFilterBar");
      var sheetKey = getSheetKey(state.activeTab);
      
      // Hide ALL filter bars first
      filterBar.classList.add("hidden");
      salesFilterBar.classList.add("hidden");
      if (clutchesFilterBar) clutchesFilterBar.classList.add("hidden");
      
      // Show only the appropriate filter bar for current tab
      if (state.activeTab === "clutches") {
        if (clutchesFilterBar) clutchesFilterBar.classList.remove("hidden");
        var clutchSearchInput = document.getElementById("clutchSearchInput");
        if (clutchSearchInput) clutchSearchInput.value = state.filters.search || "";
      } else if (state.activeTab === "sales") {
        salesFilterBar.classList.remove("hidden");
        populateSalesYearFilter();
        var salesSearchInput = document.getElementById("salesSearchInput");
        if (salesSearchInput) salesSearchInput.value = state.filters.search || "";
      } else if (sheetKey === "collection") {
        // Collection, Hatchlings, Pairings tabs
        filterBar.classList.remove("hidden");
        populateSpeciesFilter();
        var searchInput = document.getElementById("searchInput");
        if (searchInput) searchInput.value = state.filters.search || "";
      } else if (state.activeTab === "activity") {
        filterBar.classList.remove("hidden");
        var searchInput = document.getElementById("searchInput");
        if (searchInput) searchInput.value = state.filters.search || "";
      }
      // For archive and other tabs, all filter bars stay hidden
      
      // Show alert filter badge if active
      var alertFilterDisplay = document.getElementById("alertFilterDisplay");
      var alertFilterLabel = document.getElementById("alertFilterLabel");
      if (alertFilterDisplay && state.filters.alertFilter) {
        var label = ALERT_FILTER_LABELS[state.filters.alertFilter] || state.filters.alertFilter;
        alertFilterLabel.textContent = label;
        alertFilterDisplay.classList.remove("hidden");
      } else if (alertFilterDisplay) {
        alertFilterDisplay.classList.add("hidden");
      }

      // Header
      var headerRow = document.getElementById("tableHead").querySelector("tr");
      headerRow.innerHTML = "";
      
      // Actions header FIRST
      var actionTh = document.createElement("th");
      actionTh.className = "px-3 py-3 text-left font-semibold text-slate-600 bg-slate-50 whitespace-nowrap text-sm sticky left-0 z-10";
      actionTh.textContent = "Actions";
      headerRow.appendChild(actionTh);
      
      columns.forEach(function(col) {
        var th = document.createElement("th");
        th.className = "px-3 py-3 text-left font-semibold text-slate-600 bg-slate-50 whitespace-nowrap text-sm";
        th.textContent = col;
        headerRow.appendChild(th);
      });

      // Body
      var tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      
      if (!rows.length) {
        var tr = document.createElement("tr");
        tr.innerHTML = '<td colspan="' + (columns.length + 1) + '" class="px-4 py-12 text-center text-slate-500">No data</td>';
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(function(row) {
        var tr = document.createElement("tr");
        tr.className = "hover:bg-slate-50";
        
        // Check if this clutch is overdue (for Clutches view)
        var isOverdue = false;
        if (state.activeTab === "clutches") {
          var estHatchDate = row["EST. HATCH DATE"] || row["EST HATCH DATE"] || row["ESTIMATED HATCH DATE"] || "";
          var status = (row.STATUS || "").toLowerCase();
          if (estHatchDate && status === "incubating") {
            var estDate = parseDate(estHatchDate);
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            if (estDate && estDate < today) {
              isOverdue = true;
              tr.className = "hover:bg-gray-200 bg-gray-200";
            }
          }
        }
        
        // Actions FIRST (sticky left)
        var actionTd = document.createElement("td");
        actionTd.className = "px-3 py-3 whitespace-nowrap bg-white sticky left-0 z-10 border-r border-gray-100";
        
        var editBtn = document.createElement("button");
        editBtn.className = "px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs hover:bg-slate-200 mr-1";
        editBtn.textContent = "Edit";
        editBtn.onclick = function() { openEditModal(row); };
        actionTd.appendChild(editBtn);

        // + Activity button for collection, clutches, hatchlings (not activity tab itself)
        if (state.activeTab === "collection" || state.activeTab === "clutches" || state.activeTab === "hatchlings") {
          var activityBtn = document.createElement("button");
          activityBtn.className = "px-2 py-1 bg-green-100 text-green-700 rounded text-xs hover:bg-green-200 mr-1";
          activityBtn.textContent = "+ Activity";
          activityBtn.onclick = (function(r) {
            return function() { openQuickActivityModal(r); };
          })(row);
          actionTd.appendChild(activityBtn);
        }

        if (showHatch) {
          var hatchBtn = document.createElement("button");
          hatchBtn.className = "px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300 mr-1";
          hatchBtn.textContent = "Hatch";
          hatchBtn.onclick = function() { openHatchModal(row); };
          actionTd.appendChild(hatchBtn);
        }

        if (showSale) {
          var saleBtn = document.createElement("button");
          saleBtn.className = "px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs hover:bg-gray-400 mr-1";
          saleBtn.textContent = "Sell";
          saleBtn.onclick = function() { openSaleModal(row); };
          actionTd.appendChild(saleBtn);
          
          var holdbackBtn = document.createElement("button");
          holdbackBtn.className = "px-2 py-1 bg-gray-400 text-white rounded text-xs hover:bg-gray-500 mr-1";
          holdbackBtn.textContent = "+ Holdback";
          holdbackBtn.onclick = function() { markAsHoldback(row); };
          actionTd.appendChild(holdbackBtn);
        }

        // Archive button for collection and clutches
        if (state.activeTab === "collection" || state.activeTab === "clutches" || state.activeTab === "hatchlings" || state.activeTab === "sales") {
          var archiveTab = state.activeTab === "clutches" ? "Clutch" : "Collection";
          var archiveBtn = document.createElement("button");
          archiveBtn.className = "px-2 py-1 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200";
          archiveBtn.textContent = "Delete";
          archiveBtn.onclick = (function(rowIndex, tab) {
            return function() { archiveRecord(rowIndex, tab); };
          })(row.__rowIndex, archiveTab);
          actionTd.appendChild(archiveBtn);
        }

        // Delete button for activity table (direct delete, no archive)
        if (state.activeTab === "activity") {
          var deleteBtn = document.createElement("button");
          deleteBtn.className = "px-2 py-1 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200";
          deleteBtn.textContent = "Delete";
          deleteBtn.onclick = (function(rowIndex) {
            return function() { deleteActivityRecord(rowIndex); };
          })(row.__rowIndex);
          actionTd.appendChild(deleteBtn);
        }

        // Invoice button for Sales view
        if (state.activeTab === "sales") {
          var invoiceBtn = document.createElement("button");
          invoiceBtn.className = "px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300 mr-1";
          invoiceBtn.textContent = "Invoice";
          invoiceBtn.onclick = (function(r) {
            return function() { openInvoiceModal(r); };
          })(row);
          actionTd.insertBefore(invoiceBtn, actionTd.firstChild);
        }

        tr.appendChild(actionTd);
        
        // Data columns
        columns.forEach(function(col, colIdx) {
          var td = document.createElement("td");
          td.className = "px-3 py-3 text-slate-700 whitespace-nowrap text-sm";
          
          // Special handling for QR column
          if (col === "QR") {
            var animalId = row["UNIQUE ID"] || row["MANUAL OVERRIDE"] || "";
            if (animalId) {
              var qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=50x50&data=" + encodeURIComponent("https://app.therackapp.io?code=" + state.sheetId + "&animal=" + animalId);
              td.innerHTML = '<img src="' + qrUrl + '" alt="QR" style="width:40px; height:40px; min-width:40px; min-height:40px; max-width:40px; max-height:40px;" />';
            } else {
              td.textContent = "--";
            }
          }
          // Maturity column
          else if (col === "MATURITY") {
            var maturity = calculateMaturity(row["DATE OF BIRTH"]);
            td.innerHTML = '<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium">' + maturity + '</span>';
          }
          // Status badge
          else if (col === "STATUS") {
            var statusVal = row[col] || "--";
            td.innerHTML = '<span class="px-2 py-1 bg-gray-200 text-gray-800 rounded text-xs font-medium">' + escapeHtml(statusVal) + '</span>';
          }
          // Gene tags
          else if (col === "GENETIC SUMMARY") {
            var genes = row[col] || "";
            if (genes) {
              td.innerHTML = renderGeneTags(genes);
            } else {
              td.textContent = "--";
            }
          }
          // Add warning icon to first data column if overdue
          else if (colIdx === 0 && isOverdue) {
            td.innerHTML = '<span class="text-red-600 font-bold mr-1" title="Overdue - past estimated hatch date">!</span>' + escapeHtml(row[col] || "--");
          }
          // Special handling for Pairings view - SIRE maps to UNIQUE ID, DAM maps to VALUE
          else if (state.activeTab === "pairings" && col === "SIRE") {
            // Get the animal name for the UNIQUE ID
            var sireId = row["UNIQUE ID"] || "";
            var sireName = getAnimalNameById(sireId);
            td.textContent = sireName ? sireName + " | " + sireId : sireId || "--";
          }
          else if (state.activeTab === "pairings" && col === "DAM") {
            // VALUE contains the paired animal (could be "Name | ID" format already)
            var damValue = row["VALUE"] || "";
            td.textContent = damValue || "--";
          }
          // Format date columns nicely
          else if (col.toUpperCase().includes("DATE") && row[col]) {
            var dateVal = parseDate(row[col]);
            if (dateVal) {
              td.textContent = (dateVal.getMonth() + 1) + "/" + dateVal.getDate() + "/" + dateVal.getFullYear();
            } else {
              td.textContent = row[col] || "--";
            }
          } else {
            td.textContent = row[col] || "--";
          }
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }
    
    // Simple button handlers that use window._displayedRows
    function handleEdit(displayIndex) {
      console.log("handleEdit called with displayIndex:", displayIndex);
      console.log("window._displayedRows:", window._displayedRows);
      console.log("window._displayedRows length:", window._displayedRows ? window._displayedRows.length : 0);
      
      var row = window._displayedRows[displayIndex];
      console.log("Retrieved row:", row);
      
      if (!row) {
        setStatus("Row not found at index " + displayIndex, true);
        return;
      }
      openEditModal(row);
    }
    
    function handleHatch(displayIndex) {
      var row = window._displayedRows[displayIndex];
      if (!row) {
        setStatus("Row not found", true);
        return;
      }
      openHatchModal(row);
    }
    
    function handleSell(displayIndex) {
      var row = window._displayedRows[displayIndex];
      if (!row) {
        setStatus("Row not found", true);
        return;
      }
      openSaleModal(row);
    }
    
    function handleHoldback(displayIndex) {
      var row = window._displayedRows[displayIndex];
      if (!row) {
        setStatus("Row not found", true);
        return;
      }
      markAsHoldback(row);
    }
    
    function handleDelete(displayIndex, sourceTab) {
      var row = window._displayedRows[displayIndex];
      if (!row) {
        setStatus("Row not found", true);
        return;
      }
      
      var recordName = row["ANIMAL NAME"] || row["CLUTCH ID"] || "this record";
      
      if (!confirm("Move \"" + recordName + "\" to Archive?\n\nYou can restore it later from the Archive tab.")) {
        return;
      }
      
      setStatus("Archiving...");
      
      // Create clean archive data
      var archiveData = {};
      var keys = Object.keys(row);
      for (var j = 0; j < keys.length; j++) {
        var key = keys[j];
        if (key !== "__rowIndex" && key !== "__raw") {
          archiveData[key] = row[key];
        }
      }
      archiveData["ARCHIVE TYPE"] = sourceTab;
      archiveData["DATE ARCHIVED"] = new Date().toISOString().split('T')[0];
      
      // Get the actual row index for deletion
      var rowIndex = row.__rowIndex;
      
      // If no __rowIndex, we need to find it by matching UNIQUE ID or CLUTCH ID
      if (rowIndex === undefined) {
        var sheetKey = sourceTab === "Clutch" ? "clutch" : "collection";
        var allRows = state.data[sheetKey] || [];
        var uniqueId = row["UNIQUE ID"] || row["MANUAL OVERRIDE"] || row["CLUTCH ID"];
        
        for (var k = 0; k < allRows.length; k++) {
          var r = allRows[k];
          var rId = r["UNIQUE ID"] || r["MANUAL OVERRIDE"] || r["CLUTCH ID"];
          if (rId && rId === uniqueId) {
            rowIndex = r.__rowIndex;
            break;
          }
        }
      }
      
      if (rowIndex === undefined) {
        setStatus("Could not find row index for deletion", true);
        return;
      }
      
      // Save to Archive tab, then delete from original
      apiCall('saveRecord', { tab: 'Archive', data: archiveData })
        .then(function(response) {
          if (response.success) {
            return apiCall('deleteRecord', { tab: sourceTab, rowIndex: rowIndex });
          } else {
            throw new Error(response.error || "Failed to archive");
          }
        })
        .then(function(response) {
          if (response.success) {
            setStatus("Moved to Archive");
            loadData();
          } else {
            throw new Error(response.error || "Failed to delete original");
          }
        })
        .catch(function(error) {
          setStatus("Error: " + error.message, true);
        });
    }
    
    function calculateMaturity(dob) {
      if (!dob) return "UNK";
      var birthDate = parseDate(dob);
      if (!birthDate) return "UNK";
      
      var today = new Date();
      var months = (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
      
      if (months < 6) return "HTCH";
      if (months < 18) return "SUB";
      return "ADULT";
    }
    
    function renderGeneTags(genes) {
      if (!genes) return "--";
      
      // Split by common delimiters and clean up
      var geneList = genes.split(/[\s,]+/).filter(function(g) { 
        return g.trim().length > 0; 
      });
      
      // Group consecutive words that might be one gene (e.g., "desert ghost" -> "Desert Ghost")
      var parsedGenes = [];
      var hetBuffer = "";
      
      for (var i = 0; i < geneList.length; i++) {
        var gene = geneList[i].trim();
        if (!gene) continue;
        
        // Check for het/possible het patterns
        if (gene.toLowerCase() === "het" || gene.toLowerCase() === "poss" || gene.toLowerCase() === "100%") {
          hetBuffer = gene;
          continue;
        }
        
        // If we have a het buffer, combine with next gene
        if (hetBuffer) {
          parsedGenes.push(hetBuffer + " " + gene);
          hetBuffer = "";
        } else {
          parsedGenes.push(gene);
        }
      }
      
      // Render as clickable tags (max 5 shown, then "+X more")
      var maxShow = 5;
      var html = '<div class="flex flex-wrap gap-1">';
      
      for (var j = 0; j < Math.min(parsedGenes.length, maxShow); j++) {
        var g = parsedGenes[j];
        html += '<span class="px-2 py-0.5 bg-gray-100 border border-gray-300 text-gray-700 rounded-full text-xs cursor-pointer hover:bg-gray-200" onclick="filterByGene(\'' + escapeHtml(g).replace(/'/g, "\\'") + '\')">' + escapeHtml(g) + '</span>';
      }
      
      if (parsedGenes.length > maxShow) {
        html += '<span class="px-2 py-0.5 text-gray-500 text-xs">+' + (parsedGenes.length - maxShow) + ' more</span>';
      }
      
      html += '</div>';
      return html;
    }
    
    function filterByGene(gene) {
      state.filters.gene = gene;
      document.getElementById("geneFilterText").textContent = gene;
      document.getElementById("geneFilterDisplay").classList.remove("hidden");
      document.getElementById("clearFiltersBtn").classList.remove("hidden");
      renderTable();
    }
    
    function clearGeneFilter() {
      state.filters.gene = "";
      document.getElementById("geneFilterDisplay").classList.add("hidden");
      updateClearFiltersVisibility();
      renderTable();
    }
    
    function applyFilter(filterType, value) {
      state.filters[filterType] = value;
      updateClearFiltersVisibility();
      renderTable();
    }
    
    // Alert filter labels for display
    var ALERT_FILTER_LABELS = {
      overdueClutches: "Overdue Clutches",
      clutchesDueSoon: "Due Within 7 Days",
      unshipped: "Unshipped Sales",
      shippingSoon: "Shipping Soon",
      unpaidDeposits: "Unpaid Deposits",
      balanceDue: "Balance Due",
      needsSexing: "Needs Sexing",
      readyToList: "Ready to List"
    };
    
    // Alert filter destinations
    var ALERT_FILTER_TABS = {
      overdueClutches: "clutches",
      clutchesDueSoon: "clutches",
      unshipped: "sales",
      shippingSoon: "sales",
      unpaidDeposits: "sales",
      balanceDue: "sales",
      needsSexing: "hatchlings",
      readyToList: "hatchlings"
    };
    
    function filterByAlert(alertType) {
      state.filters.alertFilter = alertType;
      var targetTab = ALERT_FILTER_TABS[alertType] || "collection";
      navigateTo(targetTab);
      updateClearFiltersVisibility();
    }
    
    function clearAlertFilter() {
      state.filters.alertFilter = "";
      var alertFilterDisplay = document.getElementById("alertFilterDisplay");
      if (alertFilterDisplay) alertFilterDisplay.classList.add("hidden");
      updateClearFiltersVisibility();
      renderTable();
    }
    
    function clearAllFilters() {
      state.filters = { sex: "", status: "", species: "", gene: "", salesYear: "", salesStatus: "", search: "", alertFilter: "" };
      document.getElementById("filterSex").value = "";
      document.getElementById("filterStatus").value = "";
      document.getElementById("filterSpecies").value = "";
      var searchInput = document.getElementById("searchInput");
      if (searchInput) searchInput.value = "";
      var salesSearchInput = document.getElementById("salesSearchInput");
      if (salesSearchInput) salesSearchInput.value = "";
      var salesYearSelect = document.getElementById("filterSalesYear");
      if (salesYearSelect) salesYearSelect.value = "";
      var salesStatusSelect = document.getElementById("filterSalesStatus");
      if (salesStatusSelect) salesStatusSelect.value = "";
      document.getElementById("geneFilterDisplay").classList.add("hidden");
      document.getElementById("clearFiltersBtn").classList.add("hidden");
      // Hide all alert filter displays
      var alertFilterDisplay = document.getElementById("alertFilterDisplay");
      if (alertFilterDisplay) alertFilterDisplay.classList.add("hidden");
      renderTable();
    }
    
    function updateClearFiltersVisibility() {
      var hasFilters = state.filters.sex || state.filters.status || state.filters.species || state.filters.gene || state.filters.salesYear || state.filters.salesStatus || state.filters.search || state.filters.alertFilter;
      document.getElementById("clearFiltersBtn").classList.toggle("hidden", !hasFilters);
    }
    
    function populateSpeciesFilter() {
      var species = {};
      state.data.collection.forEach(function(r) {
        var sp = (r.SPECIES || "").trim();
        if (sp) species[sp] = true;
      });
      
      var select = document.getElementById("filterSpecies");
      select.innerHTML = '<option value="">All Species</option>';
      Object.keys(species).sort().forEach(function(sp) {
        select.innerHTML += '<option value="' + escapeHtml(sp) + '">' + escapeHtml(sp) + '</option>';
      });
    }

    function populateSalesYearFilter() {
      var years = {};
      state.data.collection.forEach(function(r) {
        var st = (r.STATUS || "").toLowerCase().trim();
        if (st === "sold" || st === "on hold" || st === "hold") {
          var soldDate = parseDate(r["DATE SOLD"]);
          if (soldDate) {
            years[soldDate.getFullYear()] = true;
          }
        }
      });
      
      var select = document.getElementById("filterSalesYear");
      select.innerHTML = '<option value="">All Years</option>';
      Object.keys(years).sort().reverse().forEach(function(yr) {
        select.innerHTML += '<option value="' + yr + '">' + yr + '</option>';
      });
    }

    function renderTableStats() {
      var statsView = document.getElementById("tableStatsView");
      var stats = calculateStats();
      var html = '';
      
      // Count on loan separately
      var onLoanCount = 0;
      state.data.collection.forEach(function(r) {
        if ((r.STATUS || "").toLowerCase().trim() === "on loan") onLoanCount++;
      });
      
      // Count clutch stats
      var hatchedCount = 0;
      var failedCount = 0;
      var totalEggs = 0;
      state.data.clutch.forEach(function(r) {
        var st = (r.STATUS || "").toLowerCase().trim();
        if (st === "hatched") hatchedCount++;
        if (st === "failed") failedCount++;
        var fertile = parseInt(r["# FERTILE"]) || 0;
        totalEggs += fertile;
      });
      
      if (state.activeTab === "collection") {
        html += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Breeders</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.totalBreeders + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Males</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.maleBreeders + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Females</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.femaleBreeders + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">On Loan</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + onLoanCount + '</div>';
        html += '</div>';
        html += '</div>';
        statsView.innerHTML = html;
        statsView.classList.remove("hidden");
        
      } else if (state.activeTab === "clutches") {
        html += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Incubating</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.incubating + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Hatched</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + hatchedCount + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Failed</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + failedCount + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Total Eggs</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + totalEggs + '</div>';
        html += '</div>';
        html += '</div>';
        statsView.innerHTML = html;
        statsView.classList.remove("hidden");
        
      } else if (state.activeTab === "hatchlings") {
        html += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Listed</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.listed + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Unlisted</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.unlisted + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Holdbacks</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.holdbacks + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">On Hold</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.onHold + '</div>';
        html += '</div>';
        html += '</div>';
        statsView.innerHTML = html;
        statsView.classList.remove("hidden");
        
      } else if (state.activeTab === "sales") {
        var currentYear = new Date().getFullYear();
        var displayYear = state.filters.salesYear ? parseInt(state.filters.salesYear) : currentYear;
        
        // Calculate stats for the selected year
        var salesStats = calculateSalesStatsForYear(displayYear);
        
        // Year filter dropdown
        html += '<div class="mb-4 flex items-center gap-2">';
        html += '<label class="text-sm text-gray-600">Show sales from:</label>';
        html += '<select onchange="state.filters.salesYear=this.value; renderCurrentView();" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">';
        html += '<option value="">All Years</option>';
        for (var y = currentYear; y >= currentYear - 5; y--) {
          var selected = state.filters.salesYear === String(y) ? ' selected' : '';
          html += '<option value="' + y + '"' + selected + '>' + y + '</option>';
        }
        html += '</select>';
        html += '</div>';
        
        html += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Sold (' + displayYear + ')</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + salesStats.sold + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Revenue</div>';
        html += '<div class="text-2xl font-black text-gray-900">$' + salesStats.revenue.toLocaleString() + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">On Hold</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.onHold + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Unshipped</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.unshipped + '</div>';
        html += '</div>';
        html += '</div>';
        statsView.innerHTML = html;
        statsView.classList.remove("hidden");
        
      } else if (state.activeTab === "activity") {
        var activityStats = calculateActivityStats();
        
        html += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Feedings (Month)</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + activityStats.feedingsMonth + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Refusals (Month)</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + activityStats.refusalsMonth + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Sheds (Month)</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + activityStats.shedsMonth + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Ovulations (Month)</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + activityStats.ovulationsMonth + '</div>';
        html += '</div>';
        html += '</div>';
        statsView.innerHTML = html;
        statsView.classList.remove("hidden");
        
      } else if (state.activeTab === "pairings") {
        var activityStats = calculateActivityStats();
        var currentYear = new Date().getFullYear();
        
        html += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Paired (' + currentYear + ')</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + activityStats.pairedYear + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Locked (' + currentYear + ')</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + activityStats.lockedYear + '</div>';
        html += '</div>';
        html += '</div>';
        statsView.innerHTML = html;
        statsView.classList.remove("hidden");
        
      } else {
        statsView.classList.add("hidden");
        statsView.innerHTML = '';
      }
    }

    function getColumns() {
      var prefs = {
        collection: ["QR", "UNIQUE ID", "ANIMAL NAME", "SEX", "MATURITY", "GENETIC SUMMARY", "STATUS"],
        clutches: ["CLUTCH ID", "SIRE", "DAM", "LAY DATE", "# FERTILE", "STATUS"],
        pairings: ["DATE", "SIRE", "DAM", "ACTIVITY"],
        hatchlings: ["QR", "UNIQUE ID", "CLUTCH ID", "ANIMAL NAME", "SEX", "MATURITY", "GENETIC SUMMARY", "STATUS", "LIST PRICE"],
        sales: ["UNIQUE ID", "ANIMAL NAME", "STATUS", "SOLD PRICE", "TOTAL PAID", "DATE SOLD", "BUYER NAME"],
        activity: ["DATE", "UNIQUE ID", "ACTIVITY", "VALUE"]
      };
      var h = state.headers[getSheetKey(state.activeTab)] || [];
      var hUpper = h.map(function(x) { return (x || "").toUpperCase(); });
      var wanted = prefs[state.activeTab] || [];
      // QR and MATURITY are virtual columns, don't filter them out
      var virtualCols = ["QR", "MATURITY"];
      var result = wanted.filter(function(w) { 
        return virtualCols.indexOf(w) >= 0 || hUpper.indexOf(w.toUpperCase()) >= 0; 
      });
      return result.length ? result : h.slice(0, 6);
    }

    function getFilteredRows() {
      var sheetKey = getSheetKey(state.activeTab);
      var rows = state.data[sheetKey] || [];
      var searchTerm = (state.filters.search || "").toLowerCase().trim();
      var alertFilter = state.filters.alertFilter || "";
      var today = new Date();
      today.setHours(0, 0, 0, 0);
      var sevenDaysOut = new Date(today);
      sevenDaysOut.setDate(sevenDaysOut.getDate() + 7);
      var threeDaysOut = new Date(today);
      threeDaysOut.setDate(threeDaysOut.getDate() + 3);
      var thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      return rows.filter(function(r) {
        var st = (r.STATUS || "").toLowerCase().trim();
        
        // Global search filter - applies to all tabs
        if (searchTerm) {
          var name = (r["ANIMAL NAME"] || "").toLowerCase();
          var uniqueId = (r["UNIQUE ID"] || "").toLowerCase();
          var manualId = (r["MANUAL OVERRIDE"] || "").toLowerCase();
          var clutchId = (r["CLUTCH ID"] || "").toLowerCase();
          
          var matchesSearch = name.indexOf(searchTerm) >= 0 ||
                              uniqueId.indexOf(searchTerm) >= 0 ||
                              manualId.indexOf(searchTerm) >= 0 ||
                              clutchId.indexOf(searchTerm) >= 0;
          
          if (!matchesSearch) return false;
        }
        
        if (state.activeTab === "collection") {
          // First check if it's a valid collection status
          if (!(st === "breeder" || st === "collection" || st === "holdback" || st === "on loan")) {
            return false;
          }
          // Apply sex filter
          if (state.filters.sex && r.SEX !== state.filters.sex) {
            return false;
          }
          // Apply status filter
          if (state.filters.status && (r.STATUS || "").toLowerCase() !== state.filters.status.toLowerCase()) {
            return false;
          }
          // Apply species filter
          if (state.filters.species && r.SPECIES !== state.filters.species) {
            return false;
          }
          // Apply gene filter
          if (state.filters.gene) {
            var genes = (r["GENETIC SUMMARY"] || "").toLowerCase();
            if (genes.indexOf(state.filters.gene.toLowerCase()) < 0) {
              return false;
            }
          }
          return true;
        }
        if (state.activeTab === "clutches") {
          // Alert filters for clutches
          if (alertFilter === "overdueClutches") {
            var estHatchDate = r["EST. HATCH DATE"] || r["EST HATCH DATE"] || r["ESTIMATED HATCH DATE"] || "";
            var clutchStatus = (r.STATUS || "").toLowerCase();
            if (clutchStatus !== "incubating") return false;
            if (!estHatchDate) return false;
            var estDate = parseDate(estHatchDate);
            if (!estDate || estDate >= today) return false;
            return true;
          }
          if (alertFilter === "clutchesDueSoon") {
            var estHatchDate = r["EST. HATCH DATE"] || r["EST HATCH DATE"] || r["ESTIMATED HATCH DATE"] || "";
            var clutchStatus = (r.STATUS || "").toLowerCase();
            if (clutchStatus !== "incubating") return false;
            if (!estHatchDate) return false;
            var estDate = parseDate(estHatchDate);
            if (!estDate) return false;
            if (estDate < today || estDate > sevenDaysOut) return false;
            return true;
          }
          // Show all clutches (including hatched) when no alert filter
          return true;
        }
        if (state.activeTab === "hatchlings") {
          // First check if it's a valid hatchling status
          if (!(st === "listed" || st === "unlisted" || st === "not listed" || st === "for sale")) {
            return false;
          }
          
          // Alert filters for hatchlings
          if (alertFilter === "needsSexing") {
            var sex = (r.SEX || "").toLowerCase();
            if (st !== "unlisted" && st !== "not listed") return false;
            if (sex && sex !== "unknown") return false;
            return true;
          }
          if (alertFilter === "readyToList") {
            if (st !== "unlisted" && st !== "not listed") return false;
            var dob = parseDate(r["DATE OF BIRTH"]);
            if (!dob || dob > thirtyDaysAgo) return false;
            return true;
          }
          
          // Apply sex filter
          if (state.filters.sex && r.SEX !== state.filters.sex) {
            return false;
          }
          // Apply status filter
          if (state.filters.status && (r.STATUS || "").toLowerCase() !== state.filters.status.toLowerCase()) {
            return false;
          }
          // Apply species filter
          if (state.filters.species && r.SPECIES !== state.filters.species) {
            return false;
          }
          // Apply gene filter
          if (state.filters.gene) {
            var genes = (r["GENETIC SUMMARY"] || "").toLowerCase();
            if (genes.indexOf(state.filters.gene.toLowerCase()) < 0) {
              return false;
            }
          }
          return true;
        }
        if (state.activeTab === "sales") {
          // First filter by sales status
          if (!(st === "on hold" || st === "hold" || st === "sold")) {
            return false;
          }
          
          // Alert filters for sales
          if (alertFilter === "balanceDue") {
            var soldPrice = parseFloat(r["SOLD PRICE"]) || 0;
            var totalPaid = parseFloat(r["TOTAL PAID"]) || 0;
            if (!(soldPrice > 0 && totalPaid < soldPrice)) return false;
            return true;
          }
          if (alertFilter === "unshipped") {
            if (st !== "sold") return false;
            var shipDate = parseDate(r["SHIP DATE"]);
            if (!shipDate) return true; // No ship date = unshipped
            if (shipDate <= sevenDaysOut) return true;
            return false;
          }
          if (alertFilter === "shippingSoon") {
            var shipDate = parseDate(r["SHIP DATE"]);
            if (!shipDate) return false;
            if (shipDate < today || shipDate > threeDaysOut) return false;
            return true;
          }
          if (alertFilter === "unpaidDeposits") {
            if (st !== "on hold" && st !== "hold") return false;
            var paymentStatus = (r["PAYMENT STATUS"] || "").toLowerCase();
            if (paymentStatus !== "deposit") return false;
            return true;
          }
          
          // Apply year filter if set
          if (state.filters.salesYear) {
            var soldDate = parseDate(r["DATE SOLD"]);
            if (!soldDate || soldDate.getFullYear() !== parseInt(state.filters.salesYear)) {
              return false;
            }
          }
          // Apply status filter if set
          if (state.filters.salesStatus) {
            var statusMatch = state.filters.salesStatus.toLowerCase();
            if (st !== statusMatch && !(statusMatch === "on hold" && st === "hold")) {
              return false;
            }
          }
          return true;
        }
        if (state.activeTab === "pairings") {
          // Filter to only show Paired and Lock activities for current year
          var activity = (r.ACTIVITY || "").toLowerCase().trim();
          if (!(activity === "paired" || activity === "lock")) {
            return false;
          }
          // Filter to current year only
          var activityDate = parseDate(r.DATE);
          var currentYear = new Date().getFullYear();
          if (activityDate && activityDate.getFullYear() !== currentYear) {
            return false;
          }
          return true;
        }
        return true;
      });
    }

    function getSheetKey(tab) {
      if (tab === "clutches") return "clutch";
      if (tab === "hatchlings" || tab === "sales" || tab === "collection") return "collection";
      if (tab === "activity" || tab === "pairings") return "activity";
      return "collection";
    }

    // ============ ADD/EDIT MODAL ============
    function openAddModal(tab) {
      if (!state.isLoggedIn) { setStatus("Log in first", true); return; }
      
      var sheetKey = getSheetKey(tab);
      if (tab === "hatchling") sheetKey = "collection";
      if (tab === "clutch") sheetKey = "clutch";
      if (tab === "activity") sheetKey = "activity";
      
      state.modalMode = "add";
      state.modalTab = sheetKey;
      state.editRowIndex = null;
      state.formData = {};
      
      // Defaults
      var today = new Date().toISOString().split("T")[0];
      if (tab === "collection") {
        state.formData.STATUS = "Breeder";
        state.formData.SEX = "Female";
        state.formData.SPECIES = "Ball Python";
        state.formType = "breeder";
      } else if (tab === "hatchling") {
        state.formData.STATUS = "Unlisted";
        state.formData.SEX = "Unknown";
        state.formData.SPECIES = "Ball Python";
        state.formData["BREEDER SOURCE"] = "Produced In House";
        state.formData["DATE OF BIRTH"] = today;
        state.formType = "hatchling";
      } else if (tab === "clutch") {
        state.formData.STATUS = "Incubating";
        state.formData["LAY DATE"] = today;
        state.formData.SEASON = String(new Date().getFullYear());
        state.formType = "clutch";
      } else if (tab === "activity") {
        state.formData.DATE = today;
        state.formData.ACTIVITY = "Note";
        state.formType = "activity";
      }

      var title = tab === "hatchling" ? "Hatchling" : (tab === "collection" ? "Breeder" : sheetKey.charAt(0).toUpperCase() + sheetKey.slice(1));
      document.getElementById("modalTitle").textContent = "Add " + title;
      
      // Show ID preview for new records (except Activity - that uses a lookup)
      var idDisplay = document.getElementById("modalIdDisplay");
      var idValue = document.getElementById("modalIdValue");
      
      if (tab === "hatchling") {
        idDisplay.classList.remove("hidden");
        idValue.textContent = generateHatchlingId();
      } else if (tab === "clutch") {
        idDisplay.classList.remove("hidden");
        idValue.textContent = generateClutchId(today);
      } else if (tab === "collection") {
        idDisplay.classList.remove("hidden");
        idValue.textContent = generateBreederId();
      } else {
        // Activity and others don't show the ID box
        idDisplay.classList.add("hidden");
      }

      renderModalForm(tab);
      document.getElementById("modal").classList.remove("hidden");
      // Reset save button to normal saveRecord function (may have been changed by quick activity modal)
      document.getElementById("saveBtn").onclick = saveRecord;
    }

    function openEditModal(row) {
      console.log("openEditModal called with row:", row);
      console.log("row.__rowIndex:", row.__rowIndex);
      console.log("row UNIQUE ID:", row["UNIQUE ID"]);
      console.log("row MANUAL OVERRIDE:", row["MANUAL OVERRIDE"]);
      
      if (!state.isLoggedIn) { setStatus("Log in first", true); return; }
      
      // Map view tab to actual sheet tab
      var sheetKey = getSheetKey(state.activeTab);
      console.log("sheetKey:", sheetKey);
      console.log("state.data[sheetKey] length:", (state.data[sheetKey] || []).length);
      
      state.modalMode = "edit";
      state.modalTab = sheetKey;
      
      // Copy row data, normalizing any Date objects to YYYY-MM-DD strings
      state.formData = {};
      for (var key in row) {
        var val = row[key];
        // If it's a Date object, convert to YYYY-MM-DD
        if (val instanceof Date && !isNaN(val.getTime())) {
          state.formData[key] = val.toISOString().split('T')[0];
        } else if (typeof val === "string" && val.includes('T') && key.toUpperCase().includes("DATE")) {
          // If it's an ISO timestamp string for a date field, strip the time
          state.formData[key] = val.split('T')[0];
        } else {
          state.formData[key] = val;
        }
      }
      
      state.formType = null; // Clear formType for edit mode
      
      // Get row index - if missing, find by UNIQUE ID or MANUAL OVERRIDE
      var rowIndex = row.__rowIndex;
      console.log("Initial rowIndex:", rowIndex);
      
      if (rowIndex === undefined) {
        var allRows = state.data[sheetKey] || [];
        var uniqueId = row["UNIQUE ID"] || row["MANUAL OVERRIDE"] || row["CLUTCH ID"];
        console.log("Looking for uniqueId:", uniqueId);
        
        for (var i = 0; i < allRows.length; i++) {
          var r = allRows[i];
          var rId = r["UNIQUE ID"] || r["MANUAL OVERRIDE"] || r["CLUTCH ID"];
          console.log("Checking row", i, "rId:", rId, "__rowIndex:", r.__rowIndex);
          if (rId && rId === uniqueId && r.__rowIndex !== undefined) {
            rowIndex = r.__rowIndex;
            console.log("Found match at rowIndex:", rowIndex);
            break;
          }
        }
      }
      
      console.log("Final rowIndex:", rowIndex);
      
      if (rowIndex === undefined) {
        setStatus("Cannot edit - please click Sync first to reload data", true);
        return;
      }
      
      state.editRowIndex = rowIndex;

      document.getElementById("modalTitle").textContent = "Edit Record";
      
      // Show existing ID
      var idDisplay = document.getElementById("modalIdDisplay");
      var idValue = document.getElementById("modalIdValue");
      var uid = row["UNIQUE ID"] || row["CLUTCH ID"] || "";
      if (uid) {
        idDisplay.classList.remove("hidden");
        idValue.textContent = uid;
      } else {
        idDisplay.classList.add("hidden");
      }

      renderModalForm(sheetKey);
      document.getElementById("modal").classList.remove("hidden");
      // Reset save button to normal saveRecord function (may have been changed by quick activity modal)
      document.getElementById("saveBtn").onclick = saveRecord;
    }

    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
      document.getElementById("modalError").textContent = "";
    }

    function renderModalForm(tab) {
      var headers = state.headers[state.modalTab] || [];
      
      // Fallback headers for activity if none loaded
      if (state.modalTab === "activity" && headers.length === 0) {
        headers = ["DATE", "UNIQUE ID", "ACTIVITY", "VALUE", "SOLD DATE", "SOLD PRICE", "BUYER NAME", "BUYER EMAIL", "SALE SOURCE", "PAYMENT STATUS", "SHIP DATE", "SHIPPING FEE", "PAIRED WITH"];
      }
      
      // Fallback headers for collection if none loaded
      if (state.modalTab === "collection" && headers.length === 0) {
        headers = ["ANIMAL NAME", "SEX", "DATE OF BIRTH", "SPECIES", "GENETIC SUMMARY", "STATUS", "WT PURCHASE (G)", "PURCHASE PRICE", "BREEDER SOURCE", "MANUAL OVERRIDE", "NOTES", "CLUTCH ID", "SIRE", "DAM", "HATCH WEIGHT (G)", "HATCH DATE", "LIST PRICE", "SOLD PRICE", "DATE SOLD", "BUYER NAME", "BUYER EMAIL"];
      }
      
      // Fallback headers for clutch if none loaded
      if (state.modalTab === "clutch" && headers.length === 0) {
        headers = ["CLUTCH ID", "SIRE", "DAM", "LAY DATE", "# EGGS", "# FERTILE", "# SLUGS", "STATUS", "MANUAL OVERRIDE", "NOTES"];
      }
      
      // Special rendering for Activity ADD form
      if (state.modalTab === "activity" && state.modalMode === "add") {
        renderActivityAddForm();
        return;
      }
      
      // Skip UNIQUE ID and CLUTCH ID except for activity form where we need UNIQUE ID
      var skipFields = ["__rowIndex", "__raw", "QR CODE", "SHEET ID", "SHEET_ID"];
      if (state.modalTab !== "activity") {
        skipFields.push("UNIQUE ID");
        skipFields.push("CLUTCH ID");
      }
      
      // Fields to skip for clutch ADD form (these are set via Hatch modal)
      var clutchHatchFields = ["DAYS TO HATCH", "DAYS TIL HATCH", "DAYS TILL HATCH", "# HATCHED", "HATCH DATE", "EST. HATCH DATE", "EST HATCH DATE", "ESTIMATED HATCH DATE", "DAYS (LAY", "MANUAL ID", "QR CODE", "SHEET ID", "SHEET_ID"];
      
      // Fields to skip for breeder ADD form (hatchling/sale specific fields)
      var breederSkipFields = ["HATCH WEIGHT", "HATCH DATE", "LIST PRICE", "BUYER ADDRESS", "MANUAL ID", "CLUTCH ID", "DATE SOLD", "SOLD PRICE", "BUYER NAME", "BUYER EMAIL", "SHIP DATE", "TOTAL PAID", "SHIPPING FEE", "SALE SOURCE", "PAYMENT STATUS", "SIRE", "DAM", "QR CODE", "SHEET ID", "SHEET_ID"];
      
      // Fields to skip for hatchling ADD form
      var hatchlingSkipFields = ["ANIMAL NAME", "LIST PRICE", "BUYER ADDRESS", "DATE SOLD", "SOLD PRICE", "BUYER NAME", "BUYER EMAIL", "SHIP DATE", "TOTAL PAID", "SHIPPING FEE", "SALE SOURCE", "PAYMENT STATUS", "QR CODE", "SHEET ID", "SHEET_ID"];
      
      // Fields to show at the end for hatchling form
      var hatchlingEndFields = ["MANUAL OVERRIDE", "NOTES"];
      
      // Fields that are read-only on hatchling form (auto-filled from clutch)
      var hatchlingReadOnlyFields = ["SIRE", "DAM"];
      
      // Activity form - conditional fields based on ACTIVITY type
      var activityType = (state.formData.ACTIVITY || "").toLowerCase();
      var isSaleActivity = (activityType === "sold");
      var isPairingActivity = (activityType === "paired" || activityType === "lock");
      
      // Fields only shown for specific activities
      var activitySaleFields = ["SOLD DATE", "SOLD PRICE", "BUYER NAME", "BUYER EMAIL", "SALE SOURCE", "PAYMENT STATUS", "SHIP DATE", "SHIPPING FEE"];
      var activityPairingFields = ["PAIRED WITH"];
      
      // Determine which fields to show based on STATUS
      var status = (state.formData.STATUS || "").toLowerCase();
      var showSaleFields = (status === "on hold" || status === "sold");
      var saleFields = ["SOLD PRICE", "DATE SOLD", "BUYER NAME", "BUYER EMAIL", "SHIP DATE", "TOTAL PAID", "SHIPPING FEE"];
      
      // Check if this is a hatchling form - ONLY for hatchling, not clutch or anything else
      var isHatchlingForm = (state.formType === "hatchling" && state.modalMode === "add" && state.modalTab === "collection");

      var html = '';
      
      // Show estimated hatch date preview for clutch form
      if ((tab === "clutch" || state.modalTab === "clutch") && state.formData["LAY DATE"]) {
        var estHatch = calculateEstHatchDate(state.formData["LAY DATE"]);
        html += '<div class="mb-4 bg-gray-100 border border-gray-300 rounded-xl px-4 py-3">';
        html += '<div class="text-xs text-gray-600 uppercase font-semibold">Estimated Hatch Date (Lay Date + 59 days)</div>';
        html += '<div class="font-bold text-gray-800 text-lg">' + estHatch + '</div>';
        html += '</div>';
      }
      
      // Special rendering for hatchling form ONLY
      if (isHatchlingForm) {
        html += renderHatchlingForm(headers);
        document.getElementById("modalBody").innerHTML = html;
        return;
      }
      
      html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
      
      headers.forEach(function(h) {
        if (skipFields.indexOf(h) >= 0) return;
        if (skipFields.indexOf(h.toUpperCase()) >= 0) return;
        if (h.includes("(RESERVED)")) return;
        // Skip fields that look like Sheet IDs (long alphanumeric strings, may contain / or other chars)
        if (/^[A-Z0-9_\-\/]{15,}$/i.test(h)) return;
        // Also skip any field that starts with a number and is very long
        if (/^\d/.test(h) && h.length > 10) return;
        // Skip anything with SHEET in the name
        if (h.toUpperCase().indexOf("SHEET") >= 0) return;
        
        // Collection form - hide sale fields unless status is on hold/sold
        if (state.modalTab === "collection" && saleFields.indexOf(h) >= 0 && !showSaleFields) return;
        
        // Skip hatchling/sale fields on breeder ADD form (status = Breeder)
        if (state.modalTab === "collection" && state.modalMode === "add") {
          var formStatus = (state.formData.STATUS || "").toLowerCase();
          if (formStatus === "breeder" || state.formType === "breeder") {
            var hUpper = h.toUpperCase();
            for (var i = 0; i < breederSkipFields.length; i++) {
              if (hUpper === breederSkipFields[i] || hUpper.indexOf(breederSkipFields[i]) >= 0) return;
            }
          }
        }
        
        // Skip hatch-related fields on clutch ADD form
        if (state.modalTab === "clutch" && state.modalMode === "add") {
          var hUpper = h.toUpperCase();
          for (var i = 0; i < clutchHatchFields.length; i++) {
            if (hUpper === clutchHatchFields[i] || hUpper.includes(clutchHatchFields[i])) return;
          }
        }
        
        // Activity form conditional fields
        if (state.modalTab === "activity") {
          // Skip sale fields unless activity is "Sold"
          if (activitySaleFields.indexOf(h) >= 0 && !isSaleActivity) return;
          // Skip pairing fields unless activity is "Paired" or "Lock"
          if (activityPairingFields.indexOf(h) >= 0 && !isPairingActivity) return;
          // Skip VALUE field if it's a sale (sale data goes in specific fields)
          if (h === "VALUE" && isSaleActivity) return;
        }
        
        var val = state.formData[h] || "";
        var input = "";
        var opts = getFieldOptions(h, state.modalTab);
        
        // Special searchable dropdown for UNIQUE ID in activity form
        if (h.toUpperCase() === "UNIQUE ID" && state.modalTab === "activity" && opts && opts.length > 0) {
          input = '<div class="relative">';
          input += '<input type="text" id="animalSearch" placeholder="Search by name or ID..." oninput="filterAnimalDropdown(this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm mb-1">';
          input += '<select id="animalSelect" onchange="updateFormField(\'UNIQUE ID\', this.value); document.getElementById(\'animalSearch\').value=this.options[this.selectedIndex].text;" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm" size="6">';
          opts.forEach(function(o) {
            var sel = (val && (val === o || val.toLowerCase() === o.toLowerCase())) ? " selected" : "";
            input += '<option value="' + escapeHtml(o) + '"' + sel + '>' + escapeHtml(o) + '</option>';
          });
          input += '</select>';
          input += '</div>';
        } else if (opts && opts.length > 0) {
          input = '<select onchange="updateFormField(\'' + h + '\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
          input += '<option value="">Select...</option>';
          opts.forEach(function(o) {
            var sel = (val && (val === o || val.toLowerCase() === o.toLowerCase())) ? " selected" : "";
            input += '<option value="' + escapeHtml(o) + '"' + sel + '>' + escapeHtml(o) + '</option>';
          });
          input += '</select>';
        } else if (Array.isArray(opts) && opts.length === 0) {
          // Empty dropdown - show text input with placeholder
          var placeholder = "";
          if (h.toUpperCase() === "DAM") placeholder = "No female breeders found";
          if (h.toUpperCase() === "SIRE") placeholder = "No male breeders found";
          if (h.toUpperCase() === "PAIRED WITH") placeholder = "No animals found";
          if (h.toUpperCase() === "UNIQUE ID") placeholder = "No animals found - load data first";
          input = '<input type="text" value="' + escapeHtml(val) + '" onchange="updateFormField(\'' + h + '\', this.value)" placeholder="' + placeholder + '" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
        } else if (h.toUpperCase().includes("DATE")) {
          var isRequired = (h.toUpperCase() === "DATE OF BIRTH" && state.formType === "breeder");
          var requiredAttr = isRequired ? ' required' : '';
          // Format date value for input field (needs YYYY-MM-DD format)
          var dateVal = formatDateForInput(val);
          input = '<input type="date" value="' + dateVal + '" onchange="updateFormField(\'' + h + '\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 mono text-sm"' + requiredAttr + '>';
        } else if (h.toUpperCase().includes("PRICE") || h.toUpperCase().includes("WEIGHT") || h.toUpperCase().includes("FEE") || h.startsWith("#")) {
          input = '<input type="number" step="any" value="' + val + '" onchange="updateFormField(\'' + h + '\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 mono text-sm">';
        } else if (h.toUpperCase().includes("NOTES")) {
          input = '<textarea onchange="updateFormField(\'' + h + '\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm" rows="2">' + escapeHtml(val) + '</textarea>';
        } else if (h.toUpperCase().includes("EMAIL")) {
          input = '<input type="email" value="' + escapeHtml(val) + '" onchange="updateFormField(\'' + h + '\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
        } else {
          input = '<input type="text" value="' + escapeHtml(val) + '" onchange="updateFormField(\'' + h + '\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
        }

        // UI-friendly label overrides
        var displayLabel = h;
        if (h.toUpperCase() === "MANUAL OVERRIDE") {
          displayLabel = "Custom Unique ID (optional)";
        }
        
        // Add required indicator for certain fields
        var requiredMark = '';
        if (h.toUpperCase() === "DATE OF BIRTH" && state.formType === "breeder") {
          requiredMark = ' <span class="text-red-500">*</span>';
        }

        html += '<div><label class="block text-xs font-semibold text-slate-600 uppercase mb-1">' + displayLabel + requiredMark + '</label>' + input + '</div>';
      });

      html += '</div>';
      document.getElementById("modalBody").innerHTML = html;
    }

    function calculateEstHatchDate(layDateStr) {
      if (!layDateStr) return "--";
      var d = parseDate(layDateStr);
      if (!d) return "--";
      d.setDate(d.getDate() + 59);
      return d.toISOString().split("T")[0];
    }
    
    function renderHatchlingForm(headers) {
      var html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
      
      // 1. CLUTCH ID dropdown (first - required)
      var clutchOpts = getClutchOptions() || [];
      var clutchVal = state.formData["CLUTCH ID"] || "";
      html += '<div class="md:col-span-2">';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Clutch ID <span class="text-red-500">*</span></label>';
      html += '<select onchange="updateHatchlingClutch(this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
      html += '<option value="">Select Clutch...</option>';
      clutchOpts.forEach(function(o) {
        var sel = (clutchVal === o) ? " selected" : "";
        html += '<option value="' + escapeHtml(o) + '"' + sel + '>' + escapeHtml(o) + '</option>';
      });
      html += '</select>';
      html += '</div>';
      
      // 2. DAM and SIRE (read-only, auto-filled from clutch)
      var damVal = state.formData["DAM"] || "";
      var sireVal = state.formData["SIRE"] || "";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Dam (from clutch)</label>';
      html += '<div class="w-full px-3 py-2 rounded-xl border border-slate-100 bg-slate-100 text-sm text-slate-600">' + (damVal || "--") + '</div>';
      html += '</div>';
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Sire (from clutch)</label>';
      html += '<div class="w-full px-3 py-2 rounded-xl border border-slate-100 bg-slate-100 text-sm text-slate-600">' + (sireVal || "--") + '</div>';
      html += '</div>';
      
      // 3. DATE OF BIRTH (required) - displays as "Hatch Date" but saves to DATE OF BIRTH column
      var dobVal = state.formData["DATE OF BIRTH"] || "";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Hatch Date <span class="text-red-500">*</span></label>';
      html += '<input type="date" value="' + dobVal + '" onchange="updateFormField(\'DATE OF BIRTH\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 mono text-sm" required>';
      html += '</div>';
      
      // 4. SEX
      var sexVal = state.formData["SEX"] || "Unknown";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Sex</label>';
      html += '<select onchange="updateFormField(\'SEX\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
      ["Unknown", "Female", "Male"].forEach(function(o) {
        var sel = (sexVal === o) ? " selected" : "";
        html += '<option value="' + o + '"' + sel + '>' + o + '</option>';
      });
      html += '</select>';
      html += '</div>';
      
      // 5. STATUS
      var statusVal = state.formData["STATUS"] || "Unlisted";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Status</label>';
      html += '<select onchange="updateFormField(\'STATUS\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
      ["Unlisted", "Listed", "Holdback"].forEach(function(o) {
        var sel = (statusVal === o) ? " selected" : "";
        html += '<option value="' + o + '"' + sel + '>' + o + '</option>';
      });
      html += '</select>';
      html += '</div>';
      
      // 6. HATCH WEIGHT
      if (headers.indexOf("HATCH WEIGHT (G)") >= 0) {
        var weightVal = state.formData["HATCH WEIGHT (G)"] || "";
        html += '<div>';
        html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Hatch Weight (g)</label>';
        html += '<input type="number" step="any" value="' + weightVal + '" onchange="updateFormField(\'HATCH WEIGHT (G)\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 mono text-sm">';
        html += '</div>';
      }
      
      // 7. SPECIES
      var speciesVal = state.formData["SPECIES"] || "Ball Python";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Species</label>';
      html += '<input type="text" value="' + escapeHtml(speciesVal) + '" onchange="updateFormField(\'SPECIES\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
      html += '</div>';
      
      // 8. GENETIC SUMMARY
      var geneticsVal = state.formData["GENETIC SUMMARY"] || "";
      html += '<div class="md:col-span-2">';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Genetic Summary</label>';
      html += '<input type="text" value="' + escapeHtml(geneticsVal) + '" onchange="updateFormField(\'GENETIC SUMMARY\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm" placeholder="e.g. Pastel Het Clown">';
      html += '</div>';
      
      // 9. BREEDER SOURCE
      var sourceVal = state.formData["BREEDER SOURCE"] || "Produced In House";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Breeder Source</label>';
      html += '<input type="text" value="' + escapeHtml(sourceVal) + '" onchange="updateFormField(\'BREEDER SOURCE\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
      html += '</div>';
      
      // Empty spacer for alignment
      html += '<div></div>';
      
      // 10. Custom Unique ID (optional) - at end
      var manualVal = state.formData["MANUAL OVERRIDE"] || "";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Custom Unique ID (optional)</label>';
      html += '<input type="text" value="' + escapeHtml(manualVal) + '" onchange="updateFormField(\'MANUAL OVERRIDE\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm" placeholder="Your own ID system">';
      html += '</div>';
      
      // 11. NOTES - at end
      var notesVal = state.formData["NOTES"] || "";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Notes</label>';
      html += '<textarea onchange="updateFormField(\'NOTES\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm" rows="2">' + escapeHtml(notesVal) + '</textarea>';
      html += '</div>';
      
      html += '</div>';
      return html;
    }
    
    function updateHatchlingClutch(clutchId) {
      state.formData["CLUTCH ID"] = clutchId;
      
      // Look up the clutch to get DAM and SIRE
      var clutchRows = state.data.clutch || [];
      var found = null;
      for (var i = 0; i < clutchRows.length; i++) {
        if (clutchRows[i]["CLUTCH ID"] === clutchId) {
          found = clutchRows[i];
          break;
        }
      }
      
      if (found) {
        state.formData["DAM"] = found["DAM"] || "";
        state.formData["SIRE"] = found["SIRE"] || "";
      } else {
        state.formData["DAM"] = "";
        state.formData["SIRE"] = "";
      }
      
      // Re-render the form
      renderModalForm("hatchling");
    }

    // Custom Activity Add Form - cleaner design
    function renderActivityAddForm() {
      var html = '';
      var today = state.formData["DATE"] || new Date().toISOString().split("T")[0];
      var selectedActivity = state.formData["ACTIVITY"] || "";
      var selectedAnimal = state.formData["UNIQUE ID"] || "";
      
      // Get all animals for selection
      var animals = state.data.collection.filter(function(r) {
        var st = (r.STATUS || "").toLowerCase();
        return st === "breeder" || st === "holdback" || st === "on loan" || st === "listed" || st === "unlisted";
      });
      
      // Step 1: Select Animal (large, prominent)
      html += '<div class="mb-5">';
      html += '<label class="block text-sm font-semibold text-gray-700 mb-2">Select Animal</label>';
      html += '<div class="relative">';
      html += '<input type="text" id="activityAnimalSearch" placeholder="Type to search..." ';
      html += 'oninput="filterActivityAnimals(this.value)" ';
      html += 'class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-sm focus:border-gray-400 focus:outline-none">';
      html += '<div id="activityAnimalList" class="mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-xl bg-white ' + (selectedAnimal ? 'hidden' : '') + '">';
      animals.forEach(function(a) {
        var name = a["ANIMAL NAME"] || "";
        var id = a["UNIQUE ID"] || "";
        var label = name ? name + " | " + id : id;
        html += '<div onclick="selectActivityAnimal(\'' + escapeHtml(id).replace(/'/g, "\\'") + '\', \'' + escapeHtml(label).replace(/'/g, "\\'") + '\')" ';
        html += 'class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-50 last:border-0">';
        html += '<span class="font-medium">' + escapeHtml(name || id) + '</span>';
        if (name && id) html += ' <span class="text-gray-400 text-xs">' + escapeHtml(id) + '</span>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
      
      // Show selected animal
      if (selectedAnimal) {
        var selectedName = getAnimalNameById(selectedAnimal);
        var displayLabel = selectedName ? selectedName + " | " + selectedAnimal : selectedAnimal;
        html += '<div id="selectedAnimalDisplay" class="mt-2 px-4 py-3 bg-gray-900 text-white rounded-xl flex items-center justify-between">';
        html += '<span class="font-medium">' + escapeHtml(displayLabel) + '</span>';
        html += '<button type="button" onclick="clearActivityAnimal()" class="text-gray-400 hover:text-white text-lg">&times;</button>';
        html += '</div>';
      }
      html += '</div>';
      
      // Step 2: Date (simple)
      html += '<div class="mb-5">';
      html += '<label class="block text-sm font-semibold text-gray-700 mb-2">Date</label>';
      html += '<input type="date" id="activityDate" value="' + today + '" ';
      html += 'onchange="state.formData[\'DATE\']=this.value" ';
      html += 'class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-sm focus:border-gray-400 focus:outline-none">';
      html += '</div>';
      
      // Step 3: Activity Type - Visual buttons in categories
      html += '<div class="mb-5">';
      html += '<label class="block text-sm font-semibold text-gray-700 mb-2">Activity Type</label>';
      
      // Feeding row
      html += '<div class="mb-2">';
      html += '<div class="text-xs text-gray-400 uppercase tracking-wide mb-1">Feeding</div>';
      html += '<div class="flex gap-2">';
      html += activityButton("Took Meal", selectedActivity);
      html += activityButton("Refused Meal", selectedActivity);
      html += '</div>';
      html += '</div>';
      
      // General row
      html += '<div class="mb-2">';
      html += '<div class="text-xs text-gray-400 uppercase tracking-wide mb-1">General</div>';
      html += '<div class="flex gap-2">';
      html += activityButton("Shed", selectedActivity);
      html += activityButton("Weight", selectedActivity);
      html += activityButton("Note", selectedActivity);
      html += activityButton("Health Hold", selectedActivity);
      html += '</div>';
      html += '</div>';
      
      // Breeding row
      html += '<div class="mb-2">';
      html += '<div class="text-xs text-gray-400 uppercase tracking-wide mb-1">Breeding</div>';
      html += '<div class="flex gap-2">';
      html += activityButton("Paired", selectedActivity);
      html += activityButton("Lock", selectedActivity);
      html += activityButton("Ovulation", selectedActivity);
      html += activityButton("Pre Lay Shed", selectedActivity);
      html += '</div>';
      html += '</div>';
      
      html += '</div>';
      
      // Step 4: Value field (conditional based on activity)
      var showValue = selectedActivity === "Weight" || selectedActivity === "Note" || selectedActivity === "Health Hold" || selectedActivity === "Ovulation";
      var showPairedWith = selectedActivity === "Paired" || selectedActivity === "Lock";
      
      if (showValue) {
        var valueLabel = "Value";
        var valuePlaceholder = "";
        if (selectedActivity === "Weight") { valueLabel = "Weight (grams)"; valuePlaceholder = "e.g. 1500"; }
        if (selectedActivity === "Note" || selectedActivity === "Health Hold") { valueLabel = "Notes"; valuePlaceholder = "Enter notes..."; }
        if (selectedActivity === "Ovulation") { valueLabel = "Follicle Size (mm)"; valuePlaceholder = "e.g. 35"; }
        
        html += '<div class="mb-5">';
        html += '<label class="block text-sm font-semibold text-gray-700 mb-2">' + valueLabel + '</label>';
        html += '<input type="text" id="activityValue" value="' + escapeHtml(state.formData["VALUE"] || "") + '" ';
        html += 'placeholder="' + valuePlaceholder + '" ';
        html += 'onchange="state.formData[\'VALUE\']=this.value" ';
        html += 'class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-sm focus:border-gray-400 focus:outline-none">';
        html += '</div>';
      }
      
      if (showPairedWith) {
        html += '<div class="mb-5">';
        html += '<label class="block text-sm font-semibold text-gray-700 mb-2">Paired With</label>';
        html += '<select id="activityPairedWith" onchange="state.formData[\'VALUE\']=this.value" ';
        html += 'class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-sm focus:border-gray-400 focus:outline-none">';
        html += '<option value="">Select animal...</option>';
        animals.forEach(function(a) {
          var name = a["ANIMAL NAME"] || "";
          var id = a["UNIQUE ID"] || "";
          var label = name ? name + " | " + id : id;
          var sel = (state.formData["VALUE"] === label) ? " selected" : "";
          html += '<option value="' + escapeHtml(label) + '"' + sel + '>' + escapeHtml(label) + '</option>';
        });
        html += '</select>';
        html += '</div>';
      }
      
      document.getElementById("modalBody").innerHTML = html;
      
      // Set up save button
      document.getElementById("saveBtn").onclick = saveActivityFromForm;
    }
    
    function activityButton(label, selected) {
      var isSelected = (selected === label);
      var baseClass = "px-3 py-2 rounded-lg text-sm font-medium transition-colors ";
      var colorClass = isSelected ? "bg-gray-900 text-white" : "bg-gray-100 text-gray-700 hover:bg-gray-200";
      return '<button type="button" onclick="selectActivityType(\'' + label + '\')" class="' + baseClass + colorClass + '">' + label + '</button>';
    }
    
    function filterActivityAnimals(search) {
      var list = document.getElementById("activityAnimalList");
      var items = list.getElementsByTagName("div");
      var searchLower = search.toLowerCase();
      var anyVisible = false;
      
      for (var i = 0; i < items.length; i++) {
        var text = items[i].textContent.toLowerCase();
        if (text.indexOf(searchLower) >= 0) {
          items[i].style.display = "";
          anyVisible = true;
        } else {
          items[i].style.display = "none";
        }
      }
      
      list.classList.toggle("hidden", !anyVisible && !search);
    }
    
    function selectActivityAnimal(id, label) {
      state.formData["UNIQUE ID"] = id;
      renderActivityAddForm();
    }
    
    function clearActivityAnimal() {
      state.formData["UNIQUE ID"] = "";
      renderActivityAddForm();
    }
    
    function selectActivityType(activity) {
      state.formData["ACTIVITY"] = activity;
      state.formData["VALUE"] = ""; // Clear value when changing activity type
      renderActivityAddForm();
    }
    
    function saveActivityFromForm() {
      var animalId = state.formData["UNIQUE ID"] || "";
      var date = state.formData["DATE"] || "";
      var activity = state.formData["ACTIVITY"] || "";
      var value = state.formData["VALUE"] || "";
      
      if (!animalId) {
        document.getElementById("modalError").textContent = "Please select an animal";
        return;
      }
      if (!activity) {
        document.getElementById("modalError").textContent = "Please select an activity type";
        return;
      }
      
      var record = {
        "DATE": date,
        "UNIQUE ID": animalId,
        "ACTIVITY": activity,
        "VALUE": value
      };
      
      setStatus("Saving...");
      document.getElementById("saveBtn").textContent = "Saving...";
      document.getElementById("saveBtn").disabled = true;
      
      apiCall('saveRecord', { tab: 'Activity', data: record })
        .then(function(response) {
          if (response.success) {
            record.__rowIndex = state.data.activity.length;
            state.data.activity.push(record);
            setStatus("Activity logged!");
            closeModal();
            renderCurrentView();
          } else {
            document.getElementById("modalError").textContent = response.error || "Failed to save";
          }
        })
        .catch(function(error) {
          document.getElementById("modalError").textContent = "Error: " + error.message;
        })
        .finally(function() {
          document.getElementById("saveBtn").textContent = "Save";
          document.getElementById("saveBtn").disabled = false;
        });
    }

    function getFieldOptions(field, sheetKey) {
      var f = field.toUpperCase();
      if (f === "SEX") return FIELD_OPTIONS.SEX;
      if (f === "STATUS" && sheetKey === "clutch") return FIELD_OPTIONS.CLUTCH_STATUS;
      if (f === "STATUS") return FIELD_OPTIONS.STATUS;
      if (f === "ACTIVITY") return FIELD_OPTIONS.ACTIVITY;
      if (f === "SALE SOURCE") return FIELD_OPTIONS.SALE_SOURCE;
      if (f === "PAYMENT STATUS") return FIELD_OPTIONS.PAYMENT_STATUS;
      
      // DAM/SIRE dropdowns
      if (f === "DAM") return getBreederOptions("Female");
      if (f === "SIRE") return getBreederOptions("Male");
      if (f === "CLUTCH ID" && sheetKey === "collection") return getClutchOptions();
      
      // Activity form - UNIQUE ID dropdown (all animals)
      if (f === "UNIQUE ID" && sheetKey === "activity") return getAllAnimalOptions();
      // Activity form - PAIRED WITH dropdown (for pairing/lock activities)
      if (f === "PAIRED WITH") return getAllAnimalOptions();
      
      return null;
    }

    function getAllAnimalOptions() {
      var rows = state.data.collection || [];
      var opts = [];
      rows.forEach(function(r) {
        var id = r["UNIQUE ID"] || "";
        var name = r["ANIMAL NAME"] || "";
        if (id) {
          var label = name ? name + " | " + id : id;
          opts.push(label);
        }
      });
      return opts;
    }

    // Filter the animal dropdown based on search input
    function filterAnimalDropdown(searchText) {
      var select = document.getElementById("animalSelect");
      if (!select) return;
      
      var search = searchText.toLowerCase();
      var options = select.options;
      
      for (var i = 0; i < options.length; i++) {
        var optionText = options[i].text.toLowerCase();
        if (search === "" || optionText.indexOf(search) >= 0) {
          options[i].style.display = "";
        } else {
          options[i].style.display = "none";
        }
      }
    }

    function getBreederOptions(sex) {
      var rows = state.data.collection || [];
      var opts = [];
      rows.forEach(function(r) {
        var st = (r.STATUS || "").toLowerCase();
        // Only include breeders and holdbacks as potential parents
        if (st !== "breeder" && st !== "holdback") return;
        var s = (r.SEX || "").toLowerCase();
        if (sex === "Female" && !s.startsWith("f")) return;
        if (sex === "Male" && !s.startsWith("m")) return;
        var id = r["UNIQUE ID"] || "";
        var name = r["ANIMAL NAME"] || "";
        if (id || name) {
          var label = name ? (id ? name + " | " + id : name) : id;
          opts.push(label);
        }
      });
      // Always return array so it shows as dropdown, even if empty
      return opts;
    }

    function getClutchOptions() {
      var rows = state.data.clutch || [];
      var opts = [];
      rows.forEach(function(r) {
        var id = r["CLUTCH ID"];
        var status = (r["STATUS"] || "").toLowerCase();
        // Only show clutches that are NOT hatched
        if (id && status !== "hatched") {
          opts.push(id);
        }
      });
      return opts.length ? opts : null;
    }

    function updateFormField(field, value) {
      state.formData[field] = value;
      
      // Re-render if STATUS changed (to show/hide sale fields)
      if (field === "STATUS") {
        renderModalForm(state.activeTab);
      }
      
      // Re-render if ACTIVITY changed (to show/hide conditional fields)
      if (field === "ACTIVITY") {
        renderModalForm(state.activeTab);
      }
      
      // Re-render if LAY DATE changed (to update estimated hatch date)
      if (field === "LAY DATE" && state.modalTab === "clutch") {
        renderModalForm(state.activeTab);
        // Also update CLUTCH ID preview if in add mode
        if (state.modalMode === "add") {
          document.getElementById("modalIdValue").textContent = generateClutchId(value);
        }
      }
    }

    function escapeHtml(s) {
      return String(s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    // Format a date value for HTML date input (needs YYYY-MM-DD)
    // Handles: Date objects, ISO strings, "MM/DD/YYYY", "YYYY-MM-DD", timestamps
    function formatDateForInput(val) {
      if (!val) return "";
      
      // If it's already in YYYY-MM-DD format, return as-is
      if (typeof val === "string" && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
        return val;
      }
      
      // If it's a Date object
      if (val instanceof Date && !isNaN(val.getTime())) {
        return val.toISOString().split('T')[0];
      }
      
      // If it's a string with timestamp (like "2022-01-01T08:00:00")
      if (typeof val === "string" && val.includes('T')) {
        return val.split('T')[0];
      }
      
      // If it's MM/DD/YYYY format
      if (typeof val === "string") {
        var parts = val.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
        if (parts) {
          var mm = parts[1].padStart(2, '0');
          var dd = parts[2].padStart(2, '0');
          var yyyy = parts[3];
          return yyyy + '-' + mm + '-' + dd;
        }
      }
      
      // Try to parse as date
      try {
        var d = new Date(val);
        if (!isNaN(d.getTime())) {
          return d.toISOString().split('T')[0];
        }
      } catch (e) {
        // Ignore parsing errors
      }
      
      // Return original value if we can't parse it
      return String(val);
    }
    
    // Format date as YYYY-MM-DD only (no timestamp)
    // formatDateOnly removed - dates pass through as-is to preserve original format
    function generateHatchlingId() {
      var year = new Date().getFullYear();
      var rows = state.data.collection || [];
      var max = 0;
      var re = /^H-(\d{4})-(\d{4})$/i;
      rows.forEach(function(r) {
        var id = r["UNIQUE ID"] || r["MANUAL OVERRIDE"] || "";
        var m = re.exec(id);
        if (m && m[1] === String(year)) {
          var n = parseInt(m[2], 10);
          if (n > max) max = n;
        }
      });
      return "H-" + year + "-" + String(max + 1).padStart(4, "0");
    }

    function generateBreederId() {
      var year = new Date().getFullYear();
      var rows = state.data.collection || [];
      var max = 0;
      var re = /^B-(\d{4})-(\d{4})$/i;
      rows.forEach(function(r) {
        var id = r["UNIQUE ID"] || r["MANUAL OVERRIDE"] || "";
        var m = re.exec(id);
        if (m && m[1] === String(year)) {
          var n = parseInt(m[2], 10);
          if (n > max) max = n;
        }
      });
      return "B-" + year + "-" + String(max + 1).padStart(4, "0");
    }

    function generateActivityId() {
      var year = new Date().getFullYear();
      var rows = state.data.activity || [];
      var max = 0;
      var re = /^A-(\d{4})-(\d{4})$/i;
      rows.forEach(function(r) {
        var id = r["ACTIVITY ID"] || "";
        var m = re.exec(id);
        if (m && m[1] === String(year)) {
          var n = parseInt(m[2], 10);
          if (n > max) max = n;
        }
      });
      return "A-" + year + "-" + String(max + 1).padStart(4, "0");
    }

    function generateClutchId(layDate) {
      var d = parseDate(layDate);
      var year = d ? d.getFullYear() : new Date().getFullYear();
      var rows = state.data.clutch || [];
      var count = 0;
      rows.forEach(function(r) {
        var ld = parseDate(r["LAY DATE"]);
        if (ld && ld.getFullYear() === year) count++;
      });
      return "CL-" + year + "-" + String(count + 1).padStart(4, "0");
    }

    function saveRecord() {
      var headers = state.headers[state.modalTab] || [];
      if (!headers.length) { document.getElementById("modalError").textContent = "No headers"; return; }

      // Auto-calculate EST. HATCH DATE for clutches
      if (state.modalTab === "clutch" && state.formData["LAY DATE"]) {
        var estHatchIdx = -1;
        for (var i = 0; i < headers.length; i++) {
          var hUpper = headers[i].toUpperCase();
          if (hUpper === "EST. HATCH DATE" || hUpper === "EST HATCH DATE" || hUpper === "ESTIMATED HATCH DATE") {
            estHatchIdx = i;
            break;
          }
        }
        if (estHatchIdx >= 0) {
          state.formData[headers[estHatchIdx]] = calculateEstHatchDate(state.formData["LAY DATE"]);
        }
      }

      var sheetName = SHEET_TABS[state.modalTab];
      var savedTab = state.modalTab;
      var isAdd = state.modalMode === "add";
      
      // CRITICAL: List ALL columns that have formulas - NEVER send data to these
      // These are generated/calculated by formulas in the Google Sheet
      // NOTE: Activity tab uses UNIQUE ID as a reference field (not a formula), so allow it there
      var formulaColumns = [
        // Collection sheet formula columns
        "QR CODE",          // Column Q - formula generates QR
        "(RESERVED)",       // Column M - reserved
        // Clutch sheet formula columns  
        "DAYS TILL HATCH",  // Column I - formula calculates
        "DAYS TIL HATCH",   // Alternate spelling
        "DAYS TO HATCH",    // Alternate spelling
        // Internal fields
        "__rowIndex",
        "__raw"
      ];
      
      // UNIQUE ID and CLUTCH ID are formulas in Collection/Clutch sheets, but NOT in Activity
      if (state.modalTab !== "activity") {
        formulaColumns.push("UNIQUE ID");
        formulaColumns.push("CLUTCH ID");
      }
      
      var cleanData = {};
      
      for (var key in state.formData) {
        // Skip formula columns entirely - check both exact and uppercase
        var isFormula = false;
        for (var f = 0; f < formulaColumns.length; f++) {
          if (key === formulaColumns[f] || key.toUpperCase() === formulaColumns[f].toUpperCase()) {
            isFormula = true;
            break;
          }
        }
        if (isFormula) continue;
        
        // Skip columns that look like Sheet IDs (long alphanumeric, 20+ chars)
        if (key.length > 20 && /^[A-Za-z0-9_\-]+$/.test(key)) continue;
        
        // Skip any column starting with # that might be a broken formula reference
        if (key.startsWith("#")) continue;
        
        // Get the value - pass through as-is, NO parsing or formatting
        var val = state.formData[key];
        
        cleanData[key] = val;
      }
      
      var savedFormData = Object.assign({}, cleanData);

      document.getElementById("saveBtn").textContent = "Saving...";
      document.getElementById("saveBtn").disabled = true;

      var promise;
      if (isAdd) {
        promise = apiCall('saveRecord', {
          tab: sheetName,
          data: cleanData
        });
      } else {
        promise = apiCall('updateRecord', {
          tab: sheetName,
          rowIndex: state.editRowIndex,
          data: cleanData
        });
      }

      promise.then(function(response) {
        if (response.success) {
          // Optimistic UI: Add to local data immediately
          if (isAdd) {
            var newRow = Object.assign({ __rowIndex: state.data[savedTab].length }, savedFormData);
            state.data[savedTab].push(newRow);
          }
          
          setStatus("Saved!");
          closeModal();
          renderCurrentView(); // Render immediately with local data
          
          // Then refresh from server in background
          loadDataQuietly();
        } else {
          document.getElementById("modalError").textContent = response.error || "Save failed";
        }
      }).catch(function(e) {
        document.getElementById("modalError").textContent = e.message || "Save failed";
      }).finally(function() {
        document.getElementById("saveBtn").textContent = "Save";
        document.getElementById("saveBtn").disabled = false;
      });
    }
    
    // Silent data refresh (no loading message)
    function loadDataQuietly() {
      apiCall('getData', {})
        .then(function(response) {
          if (response.success) {
            var data = response.data;
            state.headers = {
              collection: data.collection ? data.collection.headers : [],
              clutch: data.clutch ? data.clutch.headers : [],
              activity: data.activity ? data.activity.headers : []
            };
            state.data = {
              collection: data.collection ? data.collection.rows : [],
              clutch: data.clutch ? data.clutch.rows : [],
              activity: data.activity ? data.activity.rows : []
            };
            renderCurrentView();
          }
        })
        .catch(function() {
          // Silently fail - we already have optimistic data
        });
    }

    function colLetter(n) {
      var s = "";
      n++;
      while (n > 0) {
        var m = (n - 1) % 26;
        s = String.fromCharCode(65 + m) + s;
        n = Math.floor((n - 1) / 26);
      }
      return s;
    }

    // ============ HATCH MODAL ============
    function openHatchModal(clutchRow) {
      state.hatchClutchRow = clutchRow;
      state.hatchDate = new Date().toISOString().split("T")[0];
      state.hatchCount = 1;
      state.hatchDrafts = [];

      var clutchId = clutchRow["CLUTCH ID"] || "Unknown";
      document.getElementById("hatchClutchId").textContent = "Clutch: " + clutchId;

      var html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">';
      html += '<div><label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Hatch Date</label>';
      html += '<input type="date" id="hatchDateInput" value="' + state.hatchDate + '" onchange="state.hatchDate=this.value" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 mono"></div>';
      html += '<div><label class="block text-xs font-semibold text-slate-600 uppercase mb-1"># of Hatchlings</label>';
      html += '<input type="number" id="hatchCountInput" value="1" min="1" max="20" onchange="state.hatchCount=parseInt(this.value)||1" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50"></div>';
      html += '</div>';
      html += '<div id="hatchDraftsArea"></div>';

      document.getElementById("hatchModalBody").innerHTML = html;
      document.getElementById("hatchModal").classList.remove("hidden");
    }

    function closeHatchModal() {
      document.getElementById("hatchModal").classList.add("hidden");
      document.getElementById("hatchModalError").textContent = "";
      state.hatchClutchRow = null;
      state.hatchDrafts = [];
    }

    function markHatchedOnly() {
      if (!state.hatchClutchRow) return;
      
      var headers = state.headers.clutch || [];
      var statusIdx = headers.indexOf("STATUS");
      var hatchDateIdx = headers.indexOf("HATCH DATE");
      if (statusIdx < 0) { document.getElementById("hatchModalError").textContent = "No STATUS column"; return; }

      var updateData = { "STATUS": "Hatched" };
      if (hatchDateIdx >= 0) {
        updateData["HATCH DATE"] = state.hatchDate;
      }

      document.getElementById("hatchOnlyBtn").textContent = "Saving...";
      document.getElementById("hatchOnlyBtn").disabled = true;

      apiCall('updateRecord', {
        tab: SHEET_TABS.clutch,
        rowIndex: state.hatchClutchRow.__rowIndex,
        data: updateData
      }).then(function(response) {
        if (response.success) {
          setStatus("Clutch marked as hatched!");
          closeHatchModal();
          loadData();
        } else {
          document.getElementById("hatchModalError").textContent = "Failed: " + response.error;
        }
      }).catch(function(e) {
        document.getElementById("hatchModalError").textContent = "Failed: " + e.message;
      }).finally(function() {
        document.getElementById("hatchOnlyBtn").textContent = "Mark Hatched Only";
        document.getElementById("hatchOnlyBtn").disabled = false;
      });
    }

    function hatchAndCreateHatchlings() {
      if (!state.hatchClutchRow) return;
      var count = parseInt(document.getElementById("hatchCountInput").value) || 1;
      var hatchDate = document.getElementById("hatchDateInput").value;
      
      if (!hatchDate) {
        document.getElementById("hatchModalError").textContent = "Please enter a hatch date";
        return;
      }
      
      // Generate hatchling drafts
      var year = new Date().getFullYear();
      var baseNum = getMaxHatchlingNum(year);
      var clutchId = state.hatchClutchRow["CLUTCH ID"] || "";
      var sire = state.hatchClutchRow["SIRE"] || "";
      var dam = state.hatchClutchRow["DAM"] || "";

      state.hatchDrafts = [];
      for (var i = 1; i <= count; i++) {
        var id = "H-" + year + "-" + String(baseNum + i).padStart(4, "0");
        state.hatchDrafts.push({
          id: id,
          clutchId: clutchId,
          sire: sire,
          dam: dam,
          hatchDate: hatchDate,
          sex: "Unknown",
          animalName: "",
          geneticSummary: "",
          status: "Unlisted",
          notes: ""
        });
      }
      
      // Render the hatchling entry forms
      renderHatchlingForms();
    }
    
    function renderHatchlingForms() {
      var html = '<div class="mb-4 bg-gray-100 border border-gray-300 rounded-xl px-4 py-3">';
      html += '<div class="text-sm text-gray-700">Enter details for each hatchling. Click "Save All Hatchlings" when done.</div>';
      html += '</div>';
      
      html += '<div class="space-y-4 max-h-96 overflow-auto">';
      
      state.hatchDrafts.forEach(function(draft, idx) {
        html += '<div class="bg-slate-50 rounded-xl p-4 border border-slate-200">';
        html += '<div class="flex items-center justify-between mb-3">';
        html += '<div class="font-bold text-slate-800 mono">' + draft.id + '</div>';
        html += '<button onclick="removeHatchDraft(' + idx + ')" class="text-red-500 hover:text-red-700 text-sm">x Remove</button>';
        html += '</div>';
        
        html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-3">';
        
        // Sex dropdown
        html += '<div>';
        html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Sex</label>';
        html += '<select onchange="updateHatchDraft(' + idx + ', \'sex\', this.value)" class="w-full px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-sm">';
        html += '<option value="Unknown"' + (draft.sex === "Unknown" ? " selected" : "") + '>Unknown</option>';
        html += '<option value="Female"' + (draft.sex === "Female" ? " selected" : "") + '>Female</option>';
        html += '<option value="Male"' + (draft.sex === "Male" ? " selected" : "") + '>Male</option>';
        html += '</select>';
        html += '</div>';
        
        // Animal Name
        html += '<div>';
        html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Name (optional)</label>';
        html += '<input type="text" value="' + escapeHtml(draft.animalName) + '" onchange="updateHatchDraft(' + idx + ', \'animalName\', this.value)" class="w-full px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-sm">';
        html += '</div>';
        
        // Status
        html += '<div>';
        html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Status</label>';
        html += '<select onchange="updateHatchDraft(' + idx + ', \'status\', this.value)" class="w-full px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-sm">';
        html += '<option value="Unlisted"' + (draft.status === "Unlisted" ? " selected" : "") + '>Unlisted</option>';
        html += '<option value="Listed"' + (draft.status === "Listed" ? " selected" : "") + '>Listed</option>';
        html += '<option value="Holdback"' + (draft.status === "Holdback" ? " selected" : "") + '>Holdback</option>';
        html += '</select>';
        html += '</div>';
        
        // Genetic Summary - full width
        html += '<div class="col-span-2 md:col-span-3">';
        html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Genetic Summary</label>';
        html += '<input type="text" value="' + escapeHtml(draft.geneticSummary) + '" onchange="updateHatchDraft(' + idx + ', \'geneticSummary\', this.value)" class="w-full px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-sm" placeholder="e.g. Pastel Het Clown">';
        html += '</div>';
        
        // Notes - full width
        html += '<div class="col-span-2 md:col-span-3">';
        html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Notes (optional)</label>';
        html += '<input type="text" value="' + escapeHtml(draft.notes) + '" onchange="updateHatchDraft(' + idx + ', \'notes\', this.value)" class="w-full px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-sm">';
        html += '</div>';
        
        html += '</div>'; // grid
        html += '</div>'; // card
      });
      
      html += '</div>'; // space-y container
      
      // Add another hatchling button
      html += '<div class="mt-4">';
      html += '<button onclick="addAnotherHatchDraft()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200">+ Add Another Hatchling</button>';
      html += '</div>';
      
      document.getElementById("hatchModalBody").innerHTML = html;
      
      // Update button text
      document.getElementById("hatchAndCreateBtn").textContent = "Save All Hatchlings (" + state.hatchDrafts.length + ")";
      document.getElementById("hatchAndCreateBtn").onclick = saveAllHatchlings;
    }
    
    function updateHatchDraft(idx, field, value) {
      if (state.hatchDrafts[idx]) {
        state.hatchDrafts[idx][field] = value;
      }
    }
    
    function removeHatchDraft(idx) {
      state.hatchDrafts.splice(idx, 1);
      if (state.hatchDrafts.length === 0) {
        // Reset to initial view
        openHatchModal(state.hatchClutchRow);
      } else {
        renderHatchlingForms();
      }
    }
    
    function addAnotherHatchDraft() {
      var year = new Date().getFullYear();
      var baseNum = getMaxHatchlingNum(year) + state.hatchDrafts.length;
      var id = "H-" + year + "-" + String(baseNum + 1).padStart(4, "0");
      var clutchId = state.hatchClutchRow["CLUTCH ID"] || "";
      var sire = state.hatchClutchRow["SIRE"] || "";
      var dam = state.hatchClutchRow["DAM"] || "";
      var hatchDate = document.getElementById("hatchDateInput") ? document.getElementById("hatchDateInput").value : state.hatchDate;
      
      state.hatchDrafts.push({
        id: id,
        clutchId: clutchId,
        sire: sire,
        dam: dam,
        hatchDate: hatchDate,
        sex: "Unknown",
        animalName: "",
        geneticSummary: "",
        status: "Unlisted",
        notes: ""
      });
      
      renderHatchlingForms();
    }
    
    function saveAllHatchlings() {
      if (!state.hatchClutchRow || !state.hatchDrafts.length) return;
      
      var headers = state.headers.collection || [];
      var clutchHeaders = state.headers.clutch || [];
      var hatchDate = state.hatchDrafts[0] ? state.hatchDrafts[0].hatchDate : "";

      document.getElementById("hatchAndCreateBtn").textContent = "Saving...";
      document.getElementById("hatchAndCreateBtn").disabled = true;

      // First update the clutch status
      var clutchUpdate = { "STATUS": "Hatched" };
      if (clutchHeaders.indexOf("HATCH DATE") >= 0 && hatchDate) {
        clutchUpdate["HATCH DATE"] = hatchDate;
      }
      var numHatchedIdx = -1;
      for (var i = 0; i < clutchHeaders.length; i++) {
        if (clutchHeaders[i].toUpperCase() === "# HATCHED") {
          numHatchedIdx = i;
          clutchUpdate[clutchHeaders[i]] = String(state.hatchDrafts.length);
          break;
        }
      }

      apiCall('updateRecord', {
        tab: SHEET_TABS.clutch,
        rowIndex: state.hatchClutchRow.__rowIndex,
        data: clutchUpdate
      }).then(function(response) {
        if (!response.success) {
          throw new Error(response.error || "Failed to update clutch");
        }
        // Now save each hatchling
        var promises = state.hatchDrafts.map(function(draft) {
          var hatchlingData = {};
          headers.forEach(function(h) {
            var hUpper = h.toUpperCase();
            if (hUpper === "UNIQUE ID" || hUpper === "MANUAL OVERRIDE") hatchlingData[h] = draft.id;
            else if (hUpper === "CLUTCH ID") hatchlingData[h] = draft.clutchId;
            else if (hUpper === "SIRE") hatchlingData[h] = draft.sire;
            else if (hUpper === "DAM") hatchlingData[h] = draft.dam;
            else if (hUpper === "HATCH DATE" || hUpper === "DATE OF BIRTH") hatchlingData[h] = draft.hatchDate;
            else if (hUpper === "STATUS") hatchlingData[h] = draft.status;
            else if (hUpper === "SEX") hatchlingData[h] = draft.sex;
            else if (hUpper === "ANIMAL NAME") hatchlingData[h] = draft.animalName;
            else if (hUpper === "GENETIC SUMMARY") hatchlingData[h] = draft.geneticSummary;
            else if (hUpper === "NOTES") hatchlingData[h] = draft.notes;
            else if (hUpper === "SPECIES") hatchlingData[h] = "Ball Python";
            else if (hUpper === "BREEDER SOURCE") hatchlingData[h] = "Produced In House";
            else hatchlingData[h] = "";
          });
          return apiCall('saveRecord', {
            tab: SHEET_TABS.collection,
            data: hatchlingData
          });
        });
        return Promise.all(promises);
      }).then(function() {
        setStatus("Created " + state.hatchDrafts.length + " hatchlings!");
        closeHatchModal();
        loadData();
      }).catch(function(e) {
        document.getElementById("hatchModalError").textContent = "Failed: " + e.message;
      }).finally(function() {
        document.getElementById("hatchAndCreateBtn").textContent = "Save All Hatchlings";
        document.getElementById("hatchAndCreateBtn").disabled = false;
      });
    }

    function getMaxHatchlingNum(year) {
      var rows = state.data.collection || [];
      var max = 0;
      var re = /^H-(\d{4})-(\d{4})$/i;
      rows.forEach(function(r) {
        var id = r["UNIQUE ID"] || r["MANUAL OVERRIDE"] || "";
        var m = re.exec(id);
        if (m && m[1] === String(year)) {
          var n = parseInt(m[2], 10);
          if (n > max) max = n;
        }
      });
      return max;
    }

    // ============ SALE MODAL ============
    function openSaleModal(animalRow) {
      state.saleAnimalRow = animalRow;
      var today = new Date().toISOString().split("T")[0];
      state.saleForm = {
        soldDate: today,
        soldPrice: "",
        shippingFee: "",
        buyerName: "",
        buyerEmail: "",
        saleSource: "MorphMarket",
        paymentStatus: "Paid",
        shipDate: ""
      };

      var uid = animalRow["UNIQUE ID"] || "Unknown";
      document.getElementById("saleAnimalId").textContent = uid;

      var html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
      html += formField("Sold Date", "date", "soldDate", state.saleForm.soldDate);
      html += formField("Sold Price", "number", "soldPrice", "");
      html += formField("Shipping Fee", "number", "shippingFee", "");
      html += formField("Buyer Name", "text", "buyerName", "");
      html += formField("Buyer Email", "email", "buyerEmail", "");
      html += formSelect("Sale Source", "saleSource", FIELD_OPTIONS.SALE_SOURCE, "MorphMarket");
      html += formSelect("Payment Status", "paymentStatus", FIELD_OPTIONS.PAYMENT_STATUS, "Paid");
      html += formField("Ship Date", "date", "shipDate", "");
      html += '</div>';

      document.getElementById("saleModalBody").innerHTML = html;
      document.getElementById("saleModal").classList.remove("hidden");
    }

    function formField(label, type, key, val) {
      return '<div><label class="block text-xs font-semibold text-slate-600 uppercase mb-1">' + label + '</label>' +
             '<input type="' + type + '" value="' + (val || "") + '" onchange="state.saleForm.' + key + '=this.value" ' +
             'class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 mono text-sm"></div>';
    }

    function formSelect(label, key, opts, selected) {
      var html = '<div><label class="block text-xs font-semibold text-slate-600 uppercase mb-1">' + label + '</label>';
      html += '<select onchange="state.saleForm.' + key + '=this.value" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
      opts.forEach(function(o) {
        var sel = (o === selected) ? " selected" : "";
        html += '<option value="' + o + '"' + sel + '>' + o + '</option>';
      });
      html += '</select></div>';
      return html;
    }

    function closeSaleModal() {
      document.getElementById("saleModal").classList.add("hidden");
      document.getElementById("saleModalError").textContent = "";
      state.saleAnimalRow = null;
    }

    function saveSale() {
      if (!state.saleAnimalRow) return;
      
      var f = state.saleForm;
      if (!f.soldDate) { document.getElementById("saleModalError").textContent = "Sold date required"; return; }
      if (!f.soldPrice) { document.getElementById("saleModalError").textContent = "Sold price required"; return; }
      if (!f.buyerName) { document.getElementById("saleModalError").textContent = "Buyer name required"; return; }

      // Calculate TOTAL PAID
      var total = (parseFloat(f.soldPrice) || 0) + (parseFloat(f.shippingFee) || 0);

      var updateData = {
        "STATUS": "Sold",
        "SOLD PRICE": f.soldPrice,
        "DATE SOLD": f.soldDate,
        "BUYER NAME": f.buyerName,
        "BUYER EMAIL": f.buyerEmail,
        "SHIPPING FEE": f.shippingFee,
        "SHIP DATE": f.shipDate,
        "TOTAL PAID": String(total)
      };

      document.getElementById("saveSaleBtn").textContent = "Saving...";
      document.getElementById("saveSaleBtn").disabled = true;

      apiCall('updateRecord', {
        tab: SHEET_TABS.collection,
        rowIndex: state.saleAnimalRow.__rowIndex,
        data: updateData
      }).then(function(response) {
        if (response.success) {
          setStatus("Sale recorded!");
          closeSaleModal();
          loadData();
        } else {
          document.getElementById("saleModalError").textContent = "Failed: " + response.error;
        }
      }).catch(function(e) {
        document.getElementById("saleModalError").textContent = "Failed: " + e.message;
      }).finally(function() {
        document.getElementById("saveSaleBtn").textContent = "Save Sale";
        document.getElementById("saveSaleBtn").disabled = false;
      });
    }

    // ============ HOLDBACK FUNCTION ============
    function markAsHoldback(row) {
      if (!state.isLoggedIn) {
        setStatus("Not logged in", true);
        return;
      }
      
      setStatus("Updating to Holdback...");
      
      apiCall('updateRecord', {
        tab: SHEET_TABS.collection,
        rowIndex: row.__rowIndex,
        data: { "STATUS": "Holdback" }
      }).then(function(response) {
        if (response.success) {
          setStatus("Marked as Holdback!");
          loadData();
        } else {
          setStatus("Failed: " + response.error, true);
        }
      }).catch(function(e) {
        setStatus("Failed: " + e.message, true);
      });
    }
    // ============ TOOLS ============
    function exportCSV(sheetKey) {
      var headers = state.headers[sheetKey] || [];
      var rows = state.data[sheetKey] || [];
      if (!headers.length) { alert("No data to export"); return; }

      var lines = [headers.join(",")];
      rows.forEach(function(r) {
        var vals = headers.map(function(h) {
          var v = String(r[h] || "").replace(/"/g, '""');
          return '"' + v + '"';
        });
        lines.push(vals.join(","));
      });

      var blob = new Blob([lines.join("\n")], { type: "text/csv" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = sheetKey + "_export_" + new Date().toISOString().split("T")[0] + ".csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function showDataHealth() {
      var rows = state.data.collection || [];
      var clutchRows = state.data.clutch || [];
      var missingSex = 0, listedNoSex = 0;
      
      // Check for missing sex
      rows.forEach(function(r) {
        var sex = (r.SEX || "").trim();
        var status = (r.STATUS || "").toLowerCase();
        if (!sex) missingSex++;
        if ((status === "listed" || status === "for sale") && !sex) listedNoSex++;
      });
      
      // Check for duplicate UNIQUE IDs
      var uniqueIds = {};
      var duplicateUniqueIds = [];
      rows.forEach(function(r) {
        var id = (r["UNIQUE ID"] || "").trim();
        if (id) {
          if (uniqueIds[id]) {
            if (duplicateUniqueIds.indexOf(id) < 0) {
              duplicateUniqueIds.push(id);
            }
          } else {
            uniqueIds[id] = true;
          }
        }
      });
      
      // Check for duplicate CLUTCH IDs
      var clutchIds = {};
      var duplicateClutchIds = [];
      clutchRows.forEach(function(r) {
        var id = (r["CLUTCH ID"] || "").trim();
        if (id) {
          if (clutchIds[id]) {
            if (duplicateClutchIds.indexOf(id) < 0) {
              duplicateClutchIds.push(id);
            }
          } else {
            clutchIds[id] = true;
          }
        }
      });
      
      var report = "DATA HEALTH CHECK\n";
      report += "==================\n\n";
      report += "COLLECTION:\n";
      report += "  Total animals: " + rows.length + "\n";
      report += "  Missing sex: " + missingSex + "\n";
      report += "  Listed without sex: " + listedNoSex + "\n";
      
      if (duplicateUniqueIds.length > 0) {
        report += "\n  WARNING - Duplicate UNIQUE IDs found:\n";
        duplicateUniqueIds.forEach(function(id) {
          report += "    - " + id + "\n";
        });
      } else {
        report += "  Duplicate UNIQUE IDs: None (good!)\n";
      }
      
      report += "\nCLUTCHES:\n";
      report += "  Total clutches: " + clutchRows.length + "\n";
      
      if (duplicateClutchIds.length > 0) {
        report += "\n  WARNING - Duplicate CLUTCH IDs found:\n";
        duplicateClutchIds.forEach(function(id) {
          report += "    - " + id + "\n";
        });
      } else {
        report += "  Duplicate CLUTCH IDs: None (good!)\n";
      }

      alert(report);
    }

    function openAddForCurrentTab() {
      // Map activeTab to the correct add form type
      var formMap = {
        "collection": "collection",
        "clutches": "clutch",
        "hatchlings": "hatchling",
        "sales": "hatchling",
        "activity": "activity"
      };
      var formType = formMap[state.activeTab] || "collection";
      openAddModal(formType);
    }

    function openChangelogModal() {
      var html = '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center p-4 overflow-auto" style="z-index: 9999;" onclick="if(event.target===this)closeChangelogModal()">';
      html += '<div class="bg-white rounded-2xl w-full max-w-2xl my-8 shadow-2xl">';
      html += '<div class="p-6 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white rounded-t-2xl">';
      html += '<h2 class="text-xl font-bold text-gray-900">What\'s New - v' + VERSION + '</h2>';
      html += '<button onclick="closeChangelogModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>';
      html += '</div>';
      html += '<div class="p-6 max-h-[70vh] overflow-y-auto">';
      
      // Changelog content
      html += '<div class="space-y-6">';
      
      html += '<div><h3 class="font-bold text-gray-800 mb-2">Login & Security</h3>';
      html += '<ul class="text-sm text-gray-600 space-y-1">';
      html += '<li>- Email + Access Code Login - Simple, secure login</li>';
      html += '<li>- Auto-login - Remembers your credentials</li>';
      html += '<li>- Per-customer Google Sheets - Your data stays private</li>';
      html += '</ul></div>';
      
      html += '<div><h3 class="font-bold text-gray-800 mb-2">Dashboard</h3>';
      html += '<ul class="text-sm text-gray-600 space-y-1">';
      html += '<li>- At-a-glance stats for breeders, clutches, hatchlings, sales</li>';
      html += '<li>- Year-over-year sales comparison</li>';
      html += '<li>- Smart alerts - Overdue clutches, unshipped sales, needs sexing, and more</li>';
      html += '</ul></div>';
      
      html += '<div><h3 class="font-bold text-gray-800 mb-2">Collection Management</h3>';
      html += '<ul class="text-sm text-gray-600 space-y-1">';
      html += '<li>- Full animal profiles with genetics, status, DOB</li>';
      html += '<li>- Clickable gene tags for filtering</li>';
      html += '<li>- Maturity auto-calculation from DOB</li>';
      html += '<li>- QR codes for each animal</li>';
      html += '</ul></div>';
      
      html += '<div><h3 class="font-bold text-gray-800 mb-2">Clutch Management</h3>';
      html += '<ul class="text-sm text-gray-600 space-y-1">';
      html += '<li>- Track sire, dam, lay date, egg counts</li>';
      html += '<li>- Auto-calculated estimated hatch date</li>';
      html += '<li>- Overdue clutch alerts</li>';
      html += '<li>- Batch hatchling creation from clutch</li>';
      html += '</ul></div>';
      
      html += '<div><h3 class="font-bold text-gray-800 mb-2">Sales & Hatchlings</h3>';
      html += '<ul class="text-sm text-gray-600 space-y-1">';
      html += '<li>- Dedicated views for hatchlings and sales</li>';
      html += '<li>- Quick sell and holdback actions</li>';
      html += '<li>- Payment and shipping tracking</li>';
      html += '<li>- Revenue calculation by year</li>';
      html += '<li>- PDF Invoice generation with multi-animal support</li>';
      html += '</ul></div>';
      
      html += '<div><h3 class="font-bold text-gray-800 mb-2">Import & Export</h3>';
      html += '<ul class="text-sm text-gray-600 space-y-1">';
      html += '<li>- MorphMarket CSV import with field mapping</li>';
      html += '<li>- Smart duplicate detection (updates instead of duplicates)</li>';
      html += '<li>- Export collection or clutches to CSV</li>';
      html += '</ul></div>';
      
      html += '<div><h3 class="font-bold text-gray-800 mb-2">QR Code System</h3>';
      html += '<ul class="text-sm text-gray-600 space-y-1">';
      html += '<li>- Auto-generated QR codes for every animal</li>';
      html += '<li>- Print QR labels (small, medium, large)</li>';
      html += '<li>- Scan QR to quickly log activity</li>';
      html += '</ul></div>';
      
      html += '<div><h3 class="font-bold text-gray-800 mb-2">Archive & Activity</h3>';
      html += '<ul class="text-sm text-gray-600 space-y-1">';
      html += '<li>- Soft delete - items go to Archive, can be restored</li>';
      html += '<li>- Activity log for feeding, sheds, weights, pairings</li>';
      html += '</ul></div>';
      
      html += '<div><h3 class="font-bold text-gray-800 mb-2">Mobile Friendly</h3>';
      html += '<ul class="text-sm text-gray-600 space-y-1">';
      html += '<li>- Responsive design for phone, tablet, desktop</li>';
      html += '<li>- Slide-out mobile menu</li>';
      html += '<li>- Touch-friendly buttons</li>';
      html += '</ul></div>';
      
      html += '</div>'; // space-y-6
      html += '</div>'; // p-6 overflow
      html += '</div></div>';
      
      var modal = document.createElement('div');
      modal.id = 'changelogModal';
      modal.innerHTML = html;
      document.body.appendChild(modal);
    }

    function closeChangelogModal() {
      var modal = document.getElementById('changelogModal');
      if (modal) modal.remove();
    }

    function openSettingsModal() {
      console.log("openSettingsModal called");
      console.log("state.settings:", state.settings);
      
      // Remove any existing settings modal first
      var existingModal = document.getElementById('settingsModal');
      if (existingModal) existingModal.remove();
      
      var html = '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="z-index: 9999;" onclick="if(event.target===this)closeSettingsModal()">';
      html += '<div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-2xl">';
      html += '<div class="p-6">';
      html += '<div class="flex justify-between items-center mb-6">';
      html += '<h2 class="text-xl font-bold text-gray-900">Settings</h2>';
      html += '<button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>';
      html += '</div>';
      
      // Settings fields
      var settingsFields = [
        { key: "BUSINESS NAME", label: "Business Name", placeholder: "Your breeding business name" },
        { key: "OWNER NAME", label: "Owner Name", placeholder: "Your name" },
        { key: "LOGO URL", label: "Logo URL", placeholder: "https://..." },
        { key: "EMAIL", label: "Email", placeholder: "contact@yourbusiness.com" },
        { key: "PHONE", label: "Phone", placeholder: "(555) 123-4567" },
        { key: "CITY, STATE, ZIP", label: "Location", placeholder: "City, State ZIP" },
        { key: "WEBSITE", label: "Website", placeholder: "https://..." },
        { key: "INSTAGRAM", label: "Instagram", placeholder: "@yourhandle" },
        { key: "DEFAULT SPECIES", label: "Default Species", placeholder: "Ball Pythons" },
        { key: "INCUBATION DAYS", label: "Default Incubation Days", placeholder: "55" },
        { key: "DEFAULT TAX RATE", label: "Default Tax Rate (%)", placeholder: "0" },
        { key: "INVOICE TERMS", label: "Invoice Terms / Health Guarantee", placeholder: "Live arrival guarantee. Health guarantee valid 7 days from delivery." }
      ];
      
      html += '<div class="space-y-4">';
      settingsFields.forEach(function(field) {
        var value = state.settings[field.key] || "";
        html += '<div>';
        html += '<label class="block text-sm font-medium text-gray-700 mb-1">' + field.label + '</label>';
        html += '<input type="text" id="setting_' + field.key.replace(/[^a-zA-Z0-9]/g, '_') + '" value="' + escapeHtml(value) + '" placeholder="' + field.placeholder + '" class="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm">';
        html += '</div>';
      });
      html += '</div>';
      
      html += '<div class="mt-6 flex gap-3">';
      html += '<button onclick="saveSettings()" class="flex-1 px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black text-sm">Save Settings</button>';
      html += '<button onclick="closeSettingsModal()" class="px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-xl hover:bg-gray-200 text-sm">Cancel</button>';
      html += '</div>';
      
      html += '</div></div></div>';
      
      var modal = document.createElement('div');
      modal.id = 'settingsModal';
      modal.innerHTML = html;
      document.body.appendChild(modal);
    }

    function closeSettingsModal() {
      var modal = document.getElementById('settingsModal');
      if (modal) modal.remove();
    }

    function saveSettings() {
      var settingsFields = [
        "BUSINESS NAME", "OWNER NAME", "LOGO URL", "EMAIL", "PHONE", 
        "CITY, STATE, ZIP", "WEBSITE", "INSTAGRAM", "DEFAULT SPECIES", "INCUBATION DAYS",
        "DEFAULT TAX RATE", "INVOICE TERMS"
      ];
      
      var updates = [];
      settingsFields.forEach(function(field) {
        var inputId = 'setting_' + field.replace(/[^a-zA-Z0-9]/g, '_');
        var input = document.getElementById(inputId);
        if (input) {
          var newValue = input.value.trim();
          var oldValue = state.settings[field] || "";
          if (newValue !== oldValue) {
            updates.push({ field: field, value: newValue });
            state.settings[field] = newValue;
          }
        }
      });
      
      if (updates.length === 0) {
        closeSettingsModal();
        return;
      }
      
      setStatus("Saving settings...");
      
      // Save each setting to the Settings sheet
      var savePromises = updates.map(function(update) {
        return apiCall('saveRecord', { 
          tab: 'Settings', 
          data: { "FIELD": update.field, "VALUE": update.value }
        });
      });
      
      Promise.all(savePromises)
        .then(function() {
          setStatus("Settings saved!");
          updateUIWithSettings();
          closeSettingsModal();
        })
        .catch(function(error) {
          setStatus("Error saving settings: " + error.message, true);
        });
    }

    // ============ ARCHIVE ============
    function renderArchiveView() {
      var archiveData = state.data.archive || [];
      console.log("Archive data:", archiveData);
      console.log("Archive data length:", archiveData.length);
      console.log("Archive headers:", state.headers.archive);
      var html = '';
      
      if (archiveData.length === 0) {
        html = '<div class="text-center py-12 text-gray-500">';
        html += '<div class="text-4xl mb-4"></div>';
        html += '<p>No archived records yet.</p>';
        html += '<p class="text-sm mt-2">When you delete animals or clutches, they will appear here.</p>';
        html += '</div>';
      } else {
        // Filter into animals and clutches - check for both exact match and case-insensitive
        var archivedAnimals = archiveData.filter(function(r) { 
          var archiveType = (r["ARCHIVE TYPE"] || "").toLowerCase().trim();
          return archiveType === "collection" || archiveType === ""; 
        });
        var archivedClutches = archiveData.filter(function(r) { 
          var archiveType = (r["ARCHIVE TYPE"] || "").toLowerCase().trim();
          return archiveType === "clutch"; 
        });
        
        // If no ARCHIVE TYPE is set, show all as animals
        if (archivedAnimals.length === 0 && archivedClutches.length === 0 && archiveData.length > 0) {
          archivedAnimals = archiveData;
        }
        
        // Archived Animals
        if (archivedAnimals.length > 0) {
          html += '<div class="mb-8">';
          html += '<div class="text-xs uppercase tracking-wider text-gray-500 font-semibold mb-3">Archived Animals (' + archivedAnimals.length + ')</div>';
          html += '<div class="border border-gray-200 rounded-xl overflow-hidden">';
          html += '<table class="min-w-full text-sm">';
          html += '<thead class="bg-gray-50"><tr>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Name</th>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">ID</th>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Archived</th>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Action</th>';
          html += '</tr></thead>';
          html += '<tbody class="divide-y divide-gray-100">';
          
          archivedAnimals.forEach(function(animal, index) {
            html += '<tr class="' + (index % 2 === 0 ? 'bg-white' : 'bg-gray-50') + '">';
            html += '<td class="px-3 py-2 font-medium">' + escapeHtml(animal["ANIMAL NAME"] || "Unnamed") + '</td>';
            html += '<td class="px-3 py-2 mono text-xs">' + escapeHtml(animal["UNIQUE ID"] || animal["MANUAL OVERRIDE"] || "") + '</td>';
            html += '<td class="px-3 py-2 text-gray-500 text-xs">' + (animal["DATE ARCHIVED"] || "") + '</td>';
            html += '<td class="px-3 py-2"><button onclick="restoreFromArchive(' + animal.__rowIndex + ', \'Collection\')" class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-medium hover:bg-green-200">Restore</button></td>';
            html += '</tr>';
          });
          
          html += '</tbody></table></div></div>';
        }
        
        // Archived Clutches
        if (archivedClutches.length > 0) {
          html += '<div class="mb-8">';
          html += '<div class="text-xs uppercase tracking-wider text-gray-500 font-semibold mb-3">Archived Clutches (' + archivedClutches.length + ')</div>';
          html += '<div class="border border-gray-200 rounded-xl overflow-hidden">';
          html += '<table class="min-w-full text-sm">';
          html += '<thead class="bg-gray-50"><tr>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Clutch ID</th>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Pairing</th>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Archived</th>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Action</th>';
          html += '</tr></thead>';
          html += '<tbody class="divide-y divide-gray-100">';
          
          archivedClutches.forEach(function(clutch, index) {
            html += '<tr class="' + (index % 2 === 0 ? 'bg-white' : 'bg-gray-50') + '">';
            html += '<td class="px-3 py-2 mono text-xs font-medium">' + escapeHtml(clutch["CLUTCH ID"] || "") + '</td>';
            html += '<td class="px-3 py-2">' + escapeHtml((clutch["SIRE"] || "") + " x " + (clutch["DAM"] || "")) + '</td>';
            html += '<td class="px-3 py-2 text-gray-500 text-xs">' + (clutch["DATE ARCHIVED"] || "") + '</td>';
            html += '<td class="px-3 py-2"><button onclick="restoreFromArchive(' + clutch.__rowIndex + ', \'Clutch\')" class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-medium hover:bg-green-200">Restore</button></td>';
            html += '</tr>';
          });
          
          html += '</tbody></table></div></div>';
        }
      }
      
      document.getElementById("dashboardView").innerHTML = html;
      document.getElementById("dashboardView").classList.remove("hidden");
    }

    function archiveRecord(rowIndex, sourceTab) {
      // Get source data based on tab
      var sourceData;
      if (sourceTab === "Collection") {
        sourceData = state.data.collection;
      } else if (sourceTab === "Clutch") {
        sourceData = state.data.clutch;
      } else {
        setStatus("Unknown source tab: " + sourceTab, true);
        return;
      }
      
      // Find the record
      var record = null;
      for (var i = 0; i < sourceData.length; i++) {
        if (sourceData[i].__rowIndex === rowIndex) {
          record = sourceData[i];
          break;
        }
      }
      
      if (!record) {
        setStatus("Record not found", true);
        return;
      }
      
      var recordName = record["ANIMAL NAME"] || record["CLUTCH ID"] || "this record";
      
      if (!confirm("Move \"" + recordName + "\" to Archive?\n\nYou can restore it later from the Archive tab.")) {
        return;
      }
      
      setStatus("Archiving...");
      
      // Create clean archive data
      var archiveData = {};
      var keys = Object.keys(record);
      for (var j = 0; j < keys.length; j++) {
        var key = keys[j];
        if (key !== "__rowIndex" && key !== "__raw") {
          archiveData[key] = record[key];
        }
      }
      archiveData["ARCHIVE TYPE"] = sourceTab;
      archiveData["DATE ARCHIVED"] = new Date().toISOString().split('T')[0];
      
      // Save to Archive tab, then delete from original
      apiCall('saveRecord', { tab: 'Archive', data: archiveData })
        .then(function(response) {
          if (response.success) {
            return apiCall('deleteRecord', { tab: sourceTab, rowIndex: rowIndex });
          } else {
            throw new Error(response.error || "Failed to archive");
          }
        })
        .then(function(response) {
          if (response.success) {
            setStatus("Moved to Archive");
            loadData();
          } else {
            throw new Error(response.error || "Failed to delete original");
          }
        })
        .catch(function(error) {
          setStatus("Error: " + error.message, true);
        });
    }

    function deleteActivityRecord(rowIndex) {
      // Find the record
      var record = null;
      for (var i = 0; i < state.data.activity.length; i++) {
        if (state.data.activity[i].__rowIndex === rowIndex) {
          record = state.data.activity[i];
          break;
        }
      }
      
      if (!record) {
        setStatus("Record not found", true);
        return;
      }
      
      var recordDesc = (record["DATE"] || "") + " - " + (record["ACTIVITY"] || "") + " for " + (record["UNIQUE ID"] || "unknown");
      
      if (!confirm("Delete this activity?\n\n" + recordDesc + "\n\nThis cannot be undone.")) {
        return;
      }
      
      setStatus("Deleting...");
      
      apiCall('deleteRecord', { tab: 'Activity', rowIndex: rowIndex })
        .then(function(response) {
          if (response.success) {
            setStatus("Activity deleted");
            loadData();
          } else {
            throw new Error(response.error || "Failed to delete");
          }
        })
        .catch(function(error) {
          setStatus("Error: " + error.message, true);
        });
    }

    function restoreFromArchive(archiveRowIndex, originalTab) {
      var record = state.data.archive.find(function(r) { return r.__rowIndex === archiveRowIndex; });
      
      if (!record) {
        setStatus("Record not found", true);
        return;
      }
      
      var recordName = record["ANIMAL NAME"] || record["CLUTCH ID"] || "this record";
      
      if (!confirm("Restore \"" + recordName + "\" from Archive?")) {
        return;
      }
      
      setStatus("Restoring...");
      
      // Remove archive metadata
      var restoreData = Object.assign({}, record);
      delete restoreData["ARCHIVE TYPE"];
      delete restoreData["DATE ARCHIVED"];
      delete restoreData.__rowIndex;
      
      // First, save to original tab
      apiCall('saveRecord', { tab: originalTab, data: restoreData })
        .then(function(response) {
          if (response.success) {
            // Then delete from Archive
            return apiCall('deleteRecord', { tab: 'Archive', rowIndex: archiveRowIndex });
          } else {
            throw new Error(response.error || "Failed to restore");
          }
        })
        .then(function(response) {
          if (response.success) {
            setStatus("Restored from Archive");
            loadData(); // Refresh all data
          } else {
            throw new Error(response.error || "Failed to remove from archive");
          }
        })
        .catch(function(error) {
          setStatus("Error: " + error.message, true);
        });
    }

    // ============ QR CODE GENERATOR ============
    function openQRGenerator() {
      if (!state.isLoggedIn) {
        setStatus("Please log in first", true);
        return;
      }
      document.getElementById("qrModal").classList.remove("hidden");
      updateQRPreview();
    }

    function closeQRModal() {
      document.getElementById("qrModal").classList.add("hidden");
    }

    function updateQRPreview() {
      var filter = document.getElementById("qrAnimalSelect").value;
      var size = document.getElementById("qrSizeSelect").value;
      var preview = document.getElementById("qrPreview");
      
      // Filter animals - include all with any ID
      var animals = state.data.collection.filter(function(r) {
        var id = (r["UNIQUE ID"] || r["MANUAL OVERRIDE"] || "").trim();
        var status = (r.STATUS || "").toLowerCase().trim();
        if (!id) return false;
        
        if (filter === "breeders") {
          return status === "breeder" || status === "on loan";
        } else if (filter === "hatchlings") {
          return status === "listed" || status === "unlisted" || status === "holdback" || status === "for sale";
        }
        return true; // all
      });
      
      if (animals.length === 0) {
        preview.innerHTML = '<p class="text-gray-500 text-sm">No animals found matching filter. Make sure animals have a STATUS set.</p>';
        return;
      }
      
      // Size settings
      var sizes = {
        small: { box: 100, qr: 60, font: 9 },
        medium: { box: 140, qr: 100, font: 11 },
        large: { box: 180, qr: 140, font: 13 }
      };
      var s = sizes[size];
      
      var html = '<div id="qrPrintArea" class="flex flex-wrap gap-2">';
      
      animals.forEach(function(animal) {
        var animalId = animal["UNIQUE ID"] || animal["MANUAL OVERRIDE"] || "";
        var animalName = animal["ANIMAL NAME"] || "";
        var scanUrl = "https://app.therackapp.io?code=" + encodeURIComponent(state.sheetId) + "&animal=" + encodeURIComponent(animalId);
        var qrImageUrl = "https://api.qrserver.com/v1/create-qr-code/?size=" + s.qr + "x" + s.qr + "&data=" + encodeURIComponent(scanUrl);
        
        html += '<div class="qr-label bg-white border border-gray-300 rounded p-2 text-center" style="width:' + s.box + 'px;">';
        html += '<img src="' + qrImageUrl + '" alt="QR" style="width:' + s.qr + 'px; height:' + s.qr + 'px; margin: 0 auto; display: block;" />';
        html += '<div class="font-bold truncate" style="font-size:' + s.font + 'px; margin-top: 4px;">' + escapeHtml(animalName) + '</div>';
        html += '<div class="text-gray-500 mono truncate" style="font-size:' + (s.font - 2) + 'px;">' + escapeHtml(animalId) + '</div>';
        html += '</div>';
      });
      
      html += '</div>';
      preview.innerHTML = html;
    }

    function printQRCodes() {
      var printContent = document.getElementById("qrPrintArea").innerHTML;
      var printWindow = window.open('', '_blank');
      printWindow.document.write('<html><head><title>QR Codes - The Rack</title>');
      printWindow.document.write('<style>');
      printWindow.document.write('body { font-family: Inter, system-ui, sans-serif; margin: 20px; }');
      printWindow.document.write('.flex { display: flex; flex-wrap: wrap; gap: 8px; }');
      printWindow.document.write('.qr-label { background: white; border: 1px solid #ccc; border-radius: 4px; padding: 8px; text-align: center; page-break-inside: avoid; }');
      printWindow.document.write('.mx-auto { margin-left: auto; margin-right: auto; display: block; }');
      printWindow.document.write('.font-bold { font-weight: bold; }');
      printWindow.document.write('.text-gray-500 { color: #6b7280; }');
      printWindow.document.write('.mono { font-family: monospace; }');
      printWindow.document.write('.truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }');
      printWindow.document.write('</style></head><body>');
      printWindow.document.write(printContent);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    }

    // ============ MORPHMARKET IMPORT ============
    var importData = [];

    function openImportModal() {
      if (!state.isLoggedIn) {
        setStatus("Please log in first", true);
        return;
      }
      resetImport();
      document.getElementById("importModal").classList.remove("hidden");
    }

    function closeImportModal() {
      document.getElementById("importModal").classList.add("hidden");
      resetImport();
    }

    function resetImport() {
      importData = [];
      document.getElementById("importStep1").classList.remove("hidden");
      document.getElementById("importStep2").classList.add("hidden");
      document.getElementById("importStep3").classList.add("hidden");
      document.getElementById("importStep4").classList.add("hidden");
      document.getElementById("importFileInput").value = "";
    }

    function handleImportFile(event) {
      var file = event.target.files[0];
      if (!file) return;

      var reader = new FileReader();
      reader.onload = function(e) {
        var text = e.target.result;
        parseImportCSV(text);
      };
      reader.readAsText(file);
    }

    function parseImportCSV(text) {
      // Use a robust CSV parser that handles:
      // 1. Multi-line fields in quotes
      // 2. Commas inside quoted fields
      // 3. Escaped quotes ("" inside fields)
      
      var allRows = [];
      var currentField = "";
      var currentRow = [];
      var inQuotes = false;
      
      for (var i = 0; i < text.length; i++) {
        var char = text[i];
        var nextChar = text[i + 1] || "";
        
        if (inQuotes) {
          if (char === '"' && nextChar === '"') {
            // Escaped quote - add one quote and skip next
            currentField += '"';
            i++;
          } else if (char === '"') {
            // End of quoted field
            inQuotes = false;
          } else {
            // Regular character inside quotes (including newlines)
            currentField += char;
          }
        } else {
          if (char === '"') {
            // Start of quoted field
            inQuotes = true;
          } else if (char === ',') {
            // Field separator
            currentRow.push(currentField.trim());
            currentField = "";
          } else if (char === '\r' || char === '\n') {
            // Row separator
            if (char === '\r' && nextChar === '\n') i++; // Skip \r\n pair
            if (currentField || currentRow.length > 0) {
              currentRow.push(currentField.trim());
              if (currentRow.length > 1 || currentRow[0]) {
                allRows.push(currentRow);
              }
              currentRow = [];
              currentField = "";
            }
          } else {
            currentField += char;
          }
        }
      }
      // Don't forget last field/row
      if (currentField || currentRow.length > 0) {
        currentRow.push(currentField.trim());
        if (currentRow.length > 1 || currentRow[0]) {
          allRows.push(currentRow);
        }
      }
      
      if (allRows.length < 2) {
        setStatus("CSV file appears to be empty", true);
        return;
      }

      // First row is headers
      var headers = allRows[0];
      console.log("CSV Import Debug:");
      console.log("Total rows found:", allRows.length);
      console.log("Headers count:", headers.length);
      console.log("Headers:", headers.slice(30, 35)); // Show columns around Last_Update
      
      // Find column indices
      var cols = {
        category: headers.indexOf('Category*'),
        title: headers.indexOf('Title*'),
        animalId: headers.indexOf('Animal_Id*'),
        sex: headers.indexOf('Sex'),
        dob: headers.indexOf('Dob'),
        weight: headers.indexOf('Weight'),
        traits: headers.indexOf('Traits'),
        state: headers.indexOf('State'),
        price: headers.indexOf('Price'),
        photoUrls: headers.indexOf('Photo_Urls'),
        desc: headers.indexOf('Desc'),
        origin: headers.indexOf('Origin'),
        sires: headers.indexOf('Sires**'),
        dams: headers.indexOf('Dams**'),
        privateNotes: headers.indexOf('Private_Notes'),
        groupId: headers.indexOf('Group_Id'),
        lastUpdate: headers.indexOf('Last_Update**')
      };
      
      console.log("Last_Update** index:", cols.lastUpdate);

      importData = [];

      // Parse each row (starting at 1 to skip header)
      for (var i = 1; i < allRows.length; i++) {
        var row = allRows[i];
        if (row.length < 5) continue;
        
        // Debug first row
        if (i === 1) {
          console.log("First data row column count:", row.length);
          console.log("State value:", row[cols.state]);
          console.log("Last_Update value:", row[cols.lastUpdate]);
        }

        var mmState = (row[cols.state] || "").toLowerCase();
        var status = "Breeder";
        if (mmState === "for sale") status = "Listed";
        else if (mmState === "sold") status = "Sold";

        var price = parseFloat(row[cols.price]) || 0;
        var purchasePrice = "";
        var listPrice = "";
        var soldPrice = "";
        var soldDate = "";

        if (status === "Sold") {
          soldPrice = price;
          // Use Last_Update as sold date (format: "2026/01/04 18:10:54 -0500")
          var lastUpdate = row[cols.lastUpdate] || "";
          if (lastUpdate) {
            // Parse the date part (before the time)
            var datePart = lastUpdate.split(' ')[0];
            if (datePart) {
              // Convert from YYYY/MM/DD to MM/DD/YYYY
              var parts = datePart.split('/');
              if (parts.length === 3) {
                soldDate = parts[1] + '/' + parts[2] + '/' + parts[0];
              } else {
                soldDate = datePart;
              }
            }
          }
        } else if (status === "Listed") {
          listPrice = price;
        } else {
          purchasePrice = price;
        }

        // Parse sex
        var sex = (row[cols.sex] || "").toLowerCase();
        if (sex === "female" || sex === "f") sex = "Female";
        else if (sex === "male" || sex === "m") sex = "Male";
        else sex = "Unknown";

        // Parse DOB - MorphMarket uses various formats
        // If it's just a year (4 digits), prepend 01/01/
        var dob = (row[cols.dob] || "").trim();
        if (dob && /^\d{4}$/.test(dob)) {
          dob = "01/01/" + dob;
        }
        
        // Get first photo URL only
        var photoUrls = row[cols.photoUrls] || "";
        var firstPhoto = photoUrls.split(' ')[0] || "";

        // Extract sire/dam names (format: "Name (M)(#ID)")
        var sireRaw = row[cols.sires] || "";
        var damRaw = row[cols.dams] || "";
        var sire = sireRaw.split(' (')[0] || "";
        var dam = damRaw.split(' (')[0] || "";

        // Combine notes
        var notes = row[cols.desc] || "";
        var privateNotes = row[cols.privateNotes] || "";
        if (privateNotes) {
          notes = notes ? notes + "\n\n" + privateNotes : privateNotes;
        }

        importData.push({
          "ANIMAL NAME": row[cols.title] || "",
          "MANUAL OVERRIDE": row[cols.animalId] || "",
          "SPECIES": row[cols.category] || "",
          "SEX": sex,
          "DATE OF BIRTH": dob,
          "WT PURCHASE (G)": row[cols.weight] || "",
          "GENETIC SUMMARY": row[cols.traits] || "",
          "STATUS": status,
          "PURCHASE PRICE": purchasePrice,
          "LIST PRICE": listPrice,
          "SOLD PRICE": soldPrice,
          "DATE SOLD": soldDate,
          "NOTES": notes,
          "BREEDER SOURCE": row[cols.origin] || "",
          "SIRE": sire,
          "DAM": dam,
          "CLUTCH ID": row[cols.groupId] || ""
        });
      }

      if (importData.length === 0) {
        setStatus("No valid animals found in CSV", true);
        return;
      }

      // Show preview
      showImportPreview();
    }

    function parseCSVLine(line) {
      var result = [];
      var current = "";
      var inQuotes = false;
      
      for (var i = 0; i < line.length; i++) {
        var char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = "";
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      
      return result;
    }

    function showImportPreview() {
      document.getElementById("importStep1").classList.add("hidden");
      document.getElementById("importStep2").classList.remove("hidden");

      var tbody = document.getElementById("importPreviewBody");
      var html = "";
      var newCount = 0;
      var updateCount = 0;

      importData.forEach(function(animal, index) {
        // Check if this is an update or new
        var manualId = animal["MANUAL OVERRIDE"];
        var isUpdate = false;
        
        if (manualId) {
          isUpdate = state.data.collection.some(function(r) {
            return r["MANUAL OVERRIDE"] === manualId;
          });
        }

        if (isUpdate) {
          updateCount++;
        } else {
          newCount++;
        }

        var actionBadge = isUpdate 
          ? '<span class="px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800">Update</span>'
          : '<span class="px-2 py-1 rounded text-xs bg-green-100 text-green-800">New</span>';

        html += '<tr class="' + (index % 2 === 0 ? 'bg-white' : 'bg-gray-50') + '">';
        html += '<td class="px-3 py-2">' + actionBadge + '</td>';
        html += '<td class="px-3 py-2 font-medium">' + escapeHtml(animal["ANIMAL NAME"]) + '</td>';
        html += '<td class="px-3 py-2 mono text-xs">' + escapeHtml(animal["MANUAL OVERRIDE"]) + '</td>';
        html += '<td class="px-3 py-2">' + animal["SEX"] + '</td>';
        html += '<td class="px-3 py-2"><span class="px-2 py-1 rounded text-xs ' + getStatusColor(animal["STATUS"]) + '">' + animal["STATUS"] + '</span></td>';
        html += '<td class="px-3 py-2 text-xs max-w-xs truncate">' + escapeHtml(animal["GENETIC SUMMARY"]) + '</td>';
        html += '</tr>';
      });

      document.getElementById("importCount").textContent = newCount + " new, " + updateCount + " updates";
      tbody.innerHTML = html;
    }

    function getStatusColor(status) {
      switch(status) {
        case "Listed": return "bg-green-100 text-green-800";
        case "Sold": return "bg-blue-100 text-blue-800";
        case "Breeder": return "bg-purple-100 text-purple-800";
        default: return "bg-gray-100 text-gray-800";
      }
    }

    function executeImport() {
      document.getElementById("importStep2").classList.add("hidden");
      document.getElementById("importStep3").classList.remove("hidden");

      var total = importData.length;
      var completed = 0;
      var errors = 0;
      var updated = 0;
      var created = 0;

      function importNext() {
        if (completed >= total) {
          // Done
          document.getElementById("importStep3").classList.add("hidden");
          document.getElementById("importStep4").classList.remove("hidden");
          document.getElementById("importResult").textContent = 
            "Import complete: " + created + " new, " + updated + " updated." + 
            (errors > 0 ? " " + errors + " failed." : "");
          return;
        }

        var animal = importData[completed];
        document.getElementById("importProgress").textContent = 
          "Importing " + (completed + 1) + " of " + total + "...";

        // Check for existing animal by MANUAL OVERRIDE
        var manualId = animal["MANUAL OVERRIDE"];
        var existingRow = null;
        
        if (manualId) {
          existingRow = state.data.collection.find(function(r) {
            return r["MANUAL OVERRIDE"] === manualId;
          });
        }

        if (existingRow && existingRow.__rowIndex !== undefined) {
          // Update existing row
          apiCall('updateRecord', { tab: 'Collection', rowIndex: existingRow.__rowIndex, data: animal })
            .then(function(response) {
              if (response.success) {
                updated++;
                // Update local data
                Object.assign(existingRow, animal);
              } else {
                errors++;
                console.error("Failed to update:", animal["ANIMAL NAME"], response.error);
              }
            })
            .catch(function(error) {
              errors++;
              console.error("Error updating:", animal["ANIMAL NAME"], error);
            })
            .finally(function() {
              completed++;
              setTimeout(importNext, 100);
            });
        } else {
          // Create new row
          apiCall('saveRecord', { tab: 'Collection', data: animal })
            .then(function(response) {
              if (response.success) {
                created++;
              } else {
                errors++;
                console.error("Failed to import:", animal["ANIMAL NAME"], response.error);
              }
            })
            .catch(function(error) {
              errors++;
              console.error("Error importing:", animal["ANIMAL NAME"], error);
            })
            .finally(function() {
              completed++;
              setTimeout(importNext, 100);
            });
        }
      }

      importNext();
    }

    // ============ INVOICE FUNCTIONS ============
    function openInvoiceModal(row) {
      if (!state.isLoggedIn) {
        setStatus("Please log in first", true);
        return;
      }
      
      // Generate invoice number
      var counter = parseInt(state.settings["INVOICE COUNTER"]) || 0;
      counter++;
      var year = new Date().getFullYear();
      var invoiceNum = "INV-" + year + "-" + String(counter).padStart(4, "0");
      
      // Initialize invoice state
      state.invoice = {
        number: invoiceNum,
        counter: counter,
        date: new Date().toISOString().split("T")[0],
        dueDate: "",
        animals: [row],
        buyerName: row["BUYER NAME"] || "",
        buyerEmail: row["BUYER EMAIL"] || "",
        buyerAddress: row["BUYER ADDRESS"] || "",
        shipping: parseFloat(row["SHIPPING FEE"]) || 0,
        taxRate: parseFloat(state.settings["DEFAULT TAX RATE"]) || 0,
        deposit: parseFloat(row["TOTAL PAID"]) || 0,
        notes: ""
      };
      
      // Calculate due date (7 days from now)
      var dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + 7);
      state.invoice.dueDate = dueDate.toISOString().split("T")[0];
      
      document.getElementById("invoiceNumber").textContent = invoiceNum;
      renderInvoiceModal();
      document.getElementById("invoiceModal").classList.remove("hidden");
    }
    
    function closeInvoiceModal() {
      document.getElementById("invoiceModal").classList.add("hidden");
      document.getElementById("invoiceModalError").textContent = "";
    }
    
    function renderInvoiceModal() {
      var inv = state.invoice;
      var html = '';
      
      // Invoice Info Row
      html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">';
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-gray-600 uppercase mb-1">Invoice Date</label>';
      html += '<input type="date" id="invoiceDate" value="' + inv.date + '" onchange="state.invoice.date=this.value" class="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm">';
      html += '</div>';
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-gray-600 uppercase mb-1">Due Date</label>';
      html += '<input type="date" id="invoiceDueDate" value="' + inv.dueDate + '" onchange="state.invoice.dueDate=this.value" class="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm">';
      html += '</div>';
      html += '<div></div>';
      html += '</div>';
      
      // Buyer Info
      html += '<div class="bg-gray-50 rounded-xl p-4 mb-6">';
      html += '<div class="text-xs font-semibold text-gray-600 uppercase mb-3">Bill To</div>';
      html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
      html += '<div>';
      html += '<label class="block text-xs text-gray-500 mb-1">Name</label>';
      html += '<input type="text" id="invoiceBuyerName" value="' + escapeHtml(inv.buyerName) + '" onchange="state.invoice.buyerName=this.value" class="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm" placeholder="Buyer name">';
      html += '</div>';
      html += '<div>';
      html += '<label class="block text-xs text-gray-500 mb-1">Email</label>';
      html += '<input type="email" id="invoiceBuyerEmail" value="' + escapeHtml(inv.buyerEmail) + '" onchange="state.invoice.buyerEmail=this.value" class="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm" placeholder="buyer@email.com">';
      html += '</div>';
      html += '<div class="md:col-span-2">';
      html += '<label class="block text-xs text-gray-500 mb-1">Address</label>';
      html += '<input type="text" id="invoiceBuyerAddress" value="' + escapeHtml(inv.buyerAddress) + '" onchange="state.invoice.buyerAddress=this.value" class="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm" placeholder="Street, City, State ZIP">';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      // Animals List
      html += '<div class="mb-6">';
      html += '<div class="flex items-center justify-between mb-3">';
      html += '<div class="text-xs font-semibold text-gray-600 uppercase">Line Items</div>';
      html += '<button onclick="showAddAnimalDropdown()" class="text-sm text-gray-600 hover:text-gray-900">+ Add Another Animal</button>';
      html += '</div>';
      
      html += '<div class="border border-gray-200 rounded-xl overflow-hidden">';
      html += '<table class="w-full text-sm">';
      html += '<thead class="bg-gray-100">';
      html += '<tr>';
      html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Animal</th>';
      html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Description</th>';
      html += '<th class="px-3 py-2 text-right text-xs font-semibold text-gray-600 uppercase">Price</th>';
      html += '<th class="px-3 py-2 text-center text-xs font-semibold text-gray-600 uppercase w-16">Remove</th>';
      html += '</tr>';
      html += '</thead>';
      html += '<tbody>';
      
      inv.animals.forEach(function(animal, idx) {
        var animalId = animal["UNIQUE ID"] || animal["MANUAL OVERRIDE"] || "";
        var animalName = animal["ANIMAL NAME"] || "";
        var species = animal["SPECIES"] || "";
        var sex = animal["SEX"] || "";
        var genetics = animal["GENETIC SUMMARY"] || "";
        var price = parseFloat(animal["SOLD PRICE"]) || 0;
        
        html += '<tr class="border-t border-gray-100">';
        html += '<td class="px-3 py-3">';
        html += '<div class="font-medium text-gray-900">' + escapeHtml(animalId) + '</div>';
        html += '<div class="text-gray-500 text-xs">' + escapeHtml(animalName) + '</div>';
        html += '</td>';
        html += '<td class="px-3 py-3">';
        html += '<div class="text-gray-700">' + escapeHtml(species) + ' - ' + escapeHtml(sex) + '</div>';
        html += '<div class="text-gray-500 text-xs">' + escapeHtml(genetics) + '</div>';
        html += '</td>';
        html += '<td class="px-3 py-3 text-right font-medium">$' + price.toFixed(2) + '</td>';
        html += '<td class="px-3 py-3 text-center">';
        if (inv.animals.length > 1) {
          html += '<button onclick="removeInvoiceAnimal(' + idx + ')" class="text-red-500 hover:text-red-700">X</button>';
        } else {
          html += '<span class="text-gray-300">-</span>';
        }
        html += '</td>';
        html += '</tr>';
      });
      
      html += '</tbody>';
      html += '</table>';
      html += '</div>';
      
      // Add Animal Dropdown (hidden by default)
      html += '<div id="addAnimalDropdown" class="hidden mt-3 p-3 bg-gray-50 rounded-xl border border-gray-200">';
      html += '<label class="block text-xs text-gray-500 mb-1">Select animal to add:</label>';
      html += '<select id="addAnimalSelect" class="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm">';
      html += '<option value="">Choose an animal...</option>';
      
      // Filter to same buyer (by name or email) and exclude already added
      var addedIds = inv.animals.map(function(a) { return a["UNIQUE ID"] || a["MANUAL OVERRIDE"]; });
      var sameBuyerAnimals = state.data.collection.filter(function(r) {
        var st = (r.STATUS || "").toLowerCase();
        if (st !== "sold" && st !== "on hold") return false;
        var rid = r["UNIQUE ID"] || r["MANUAL OVERRIDE"];
        if (addedIds.indexOf(rid) >= 0) return false;
        // Match by buyer name or email
        var buyerMatch = (r["BUYER NAME"] && r["BUYER NAME"] === inv.buyerName) ||
                         (r["BUYER EMAIL"] && r["BUYER EMAIL"] === inv.buyerEmail);
        return buyerMatch;
      });
      
      if (sameBuyerAnimals.length === 0) {
        html += '<option value="" disabled>No other animals for this buyer</option>';
      } else {
        sameBuyerAnimals.forEach(function(r) {
          var rid = r["UNIQUE ID"] || r["MANUAL OVERRIDE"];
          var rname = r["ANIMAL NAME"] || "";
          var rprice = parseFloat(r["SOLD PRICE"]) || 0;
          html += '<option value="' + escapeHtml(rid) + '">' + escapeHtml(rid) + ' - ' + escapeHtml(rname) + ' ($' + rprice.toFixed(2) + ')</option>';
        });
      }
      
      html += '</select>';
      html += '<div class="mt-2 flex gap-2">';
      html += '<button onclick="addSelectedAnimal()" class="px-3 py-1 bg-gray-900 text-white text-sm rounded-lg">Add</button>';
      html += '<button onclick="hideAddAnimalDropdown()" class="px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded-lg">Cancel</button>';
      html += '</div>';
      html += '</div>';
      
      html += '</div>';
      
      // Totals Section
      var subtotal = 0;
      inv.animals.forEach(function(a) {
        subtotal += parseFloat(a["SOLD PRICE"]) || 0;
      });
      var shipping = parseFloat(inv.shipping) || 0;
      var taxRate = parseFloat(inv.taxRate) || 0;
      var taxAmount = (subtotal + shipping) * (taxRate / 100);
      var total = subtotal + shipping + taxAmount;
      var deposit = parseFloat(inv.deposit) || 0;
      var balanceDue = total - deposit;
      
      html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">';
      
      // Left column - editable fields
      html += '<div class="space-y-3">';
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-gray-600 uppercase mb-1">Shipping</label>';
      html += '<input type="number" step="0.01" id="invoiceShipping" value="' + shipping + '" onchange="updateInvoiceShipping(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm" placeholder="0.00">';
      html += '</div>';
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-gray-600 uppercase mb-1">Tax Rate (%)</label>';
      html += '<input type="number" step="0.01" id="invoiceTaxRate" value="' + taxRate + '" onchange="updateInvoiceTaxRate(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm" placeholder="0">';
      html += '</div>';
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-gray-600 uppercase mb-1">Deposit/Amount Paid</label>';
      html += '<input type="number" step="0.01" id="invoiceDeposit" value="' + deposit + '" onchange="updateInvoiceDeposit(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm" placeholder="0.00">';
      html += '</div>';
      html += '</div>';
      
      // Right column - calculated totals
      html += '<div class="bg-gray-50 rounded-xl p-4">';
      html += '<div class="flex justify-between py-2 border-b border-gray-200">';
      html += '<span class="text-gray-600">Subtotal</span>';
      html += '<span class="font-medium">$' + subtotal.toFixed(2) + '</span>';
      html += '</div>';
      html += '<div class="flex justify-between py-2 border-b border-gray-200">';
      html += '<span class="text-gray-600">Shipping</span>';
      html += '<span class="font-medium">$' + shipping.toFixed(2) + '</span>';
      html += '</div>';
      html += '<div class="flex justify-between py-2 border-b border-gray-200">';
      html += '<span class="text-gray-600">Tax (' + taxRate + '%)</span>';
      html += '<span class="font-medium">$' + taxAmount.toFixed(2) + '</span>';
      html += '</div>';
      html += '<div class="flex justify-between py-2 border-b border-gray-200">';
      html += '<span class="text-gray-600 font-semibold">Total</span>';
      html += '<span class="font-bold">$' + total.toFixed(2) + '</span>';
      html += '</div>';
      if (deposit > 0) {
        html += '<div class="flex justify-between py-2 border-b border-gray-200">';
        html += '<span class="text-gray-600">Deposit Received</span>';
        html += '<span class="font-medium text-green-600">-$' + deposit.toFixed(2) + '</span>';
        html += '</div>';
      }
      html += '<div class="flex justify-between py-3 bg-gray-200 -mx-4 -mb-4 px-4 rounded-b-xl">';
      html += '<span class="text-gray-900 font-bold">Amount Due</span>';
      html += '<span class="font-bold text-lg">$' + balanceDue.toFixed(2) + '</span>';
      html += '</div>';
      html += '</div>';
      
      html += '</div>';
      
      // Notes
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-gray-600 uppercase mb-1">Notes (optional)</label>';
      html += '<textarea id="invoiceNotes" onchange="state.invoice.notes=this.value" class="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm" rows="2" placeholder="Additional notes for this invoice...">' + escapeHtml(inv.notes) + '</textarea>';
      html += '</div>';
      
      document.getElementById("invoiceModalBody").innerHTML = html;
    }
    
    function showAddAnimalDropdown() {
      document.getElementById("addAnimalDropdown").classList.remove("hidden");
    }
    
    function hideAddAnimalDropdown() {
      document.getElementById("addAnimalDropdown").classList.add("hidden");
    }
    
    function addSelectedAnimal() {
      var select = document.getElementById("addAnimalSelect");
      var selectedId = select.value;
      if (!selectedId) return;
      
      var animal = state.data.collection.find(function(r) {
        var rid = r["UNIQUE ID"] || r["MANUAL OVERRIDE"];
        return rid === selectedId;
      });
      
      if (animal) {
        state.invoice.animals.push(animal);
        // Update shipping to sum
        state.invoice.shipping += parseFloat(animal["SHIPPING FEE"]) || 0;
        renderInvoiceModal();
      }
    }
    
    function removeInvoiceAnimal(idx) {
      if (state.invoice.animals.length > 1) {
        var removed = state.invoice.animals.splice(idx, 1)[0];
        // Subtract shipping
        state.invoice.shipping -= parseFloat(removed["SHIPPING FEE"]) || 0;
        if (state.invoice.shipping < 0) state.invoice.shipping = 0;
        renderInvoiceModal();
      }
    }
    
    function updateInvoiceShipping(val) {
      state.invoice.shipping = parseFloat(val) || 0;
      renderInvoiceModal();
    }
    
    function updateInvoiceTaxRate(val) {
      state.invoice.taxRate = parseFloat(val) || 0;
      renderInvoiceModal();
    }
    
    function updateInvoiceDeposit(val) {
      state.invoice.deposit = parseFloat(val) || 0;
      renderInvoiceModal();
    }
    
    function generateInvoiceHTML() {
      var inv = state.invoice;
      var settings = state.settings;
      
      // Calculate totals
      var subtotal = 0;
      inv.animals.forEach(function(a) {
        subtotal += parseFloat(a["SOLD PRICE"]) || 0;
      });
      var shipping = parseFloat(inv.shipping) || 0;
      var taxRate = parseFloat(inv.taxRate) || 0;
      var taxAmount = (subtotal + shipping) * (taxRate / 100);
      var total = subtotal + shipping + taxAmount;
      var deposit = parseFloat(inv.deposit) || 0;
      var balanceDue = total - deposit;
      
      var html = '';
      html += '<div class="invoice-preview" style="background: white; padding: 40px; max-width: 800px; margin: 0 auto; font-family: Inter, system-ui, sans-serif; font-size: 14px; line-height: 1.5;">';
      
      // Header with gray bar
      html += '<div style="background: #f3f4f6; padding: 20px; margin: -40px -40px 30px -40px;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: flex-start;">';
      html += '<div style="font-size: 32px; font-weight: 800; color: #111; letter-spacing: -1px;">INVOICE</div>';
      html += '<div style="text-align: right;">';
      html += '<table style="font-size: 12px; border-collapse: collapse;">';
      html += '<tr><td style="padding: 2px 10px; color: #666; font-weight: 600;">INVOICE #</td><td style="padding: 2px 10px; color: #666; font-weight: 600;">INVOICE DATE</td><td style="padding: 2px 10px; color: #666; font-weight: 600;">DUE DATE</td></tr>';
      html += '<tr><td style="padding: 2px 10px; color: #111;">' + inv.number + '</td><td style="padding: 2px 10px; color: #111;">' + formatDateDisplay(inv.date) + '</td><td style="padding: 2px 10px; color: #111;">' + formatDateDisplay(inv.dueDate) + '</td></tr>';
      html += '</table>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      // Seller and Buyer Info
      html += '<div style="display: flex; justify-content: space-between; margin-bottom: 30px;">';
      
      // Seller (left)
      html += '<div style="max-width: 45%;">';
      if (settings["LOGO URL"]) {
        html += '<img src="' + escapeHtml(settings["LOGO URL"]) + '" style="max-height: 50px; margin-bottom: 10px;" alt="Logo">';
      }
      html += '<div style="font-weight: 700; color: #111;">' + escapeHtml(settings["BUSINESS NAME"] || "Your Business Name") + '</div>';
      var address = [];
      if (settings["CITY"]) address.push(settings["CITY"]);
      if (settings["STATE"]) address.push(settings["STATE"]);
      if (settings["ZIP"]) address.push(settings["ZIP"]);
      if (address.length > 0) {
        html += '<div style="color: #666;">' + escapeHtml(address.join(", ")) + '</div>';
      }
      if (settings["EMAIL"]) html += '<div style="color: #666;">' + escapeHtml(settings["EMAIL"]) + '</div>';
      if (settings["PHONE"]) html += '<div style="color: #666;">' + escapeHtml(settings["PHONE"]) + '</div>';
      html += '</div>';
      
      // Buyer (right)
      html += '<div style="text-align: right; max-width: 45%;">';
      html += '<div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 5px;">BILL TO:</div>';
      html += '<div style="font-weight: 700; color: #111;">' + escapeHtml(inv.buyerName || "Customer Name") + '</div>';
      if (inv.buyerAddress) html += '<div style="color: #666;">' + escapeHtml(inv.buyerAddress) + '</div>';
      if (inv.buyerEmail) html += '<div style="color: #666;">' + escapeHtml(inv.buyerEmail) + '</div>';
      html += '</div>';
      
      html += '</div>';
      
      // Line Items Table
      html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
      html += '<thead>';
      html += '<tr style="background: #f9fafb;">';
      html += '<th style="padding: 10px 12px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; border-bottom: 1px solid #e5e7eb;">Animal ID / Description</th>';
      html += '<th style="padding: 10px 12px; text-align: center; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; border-bottom: 1px solid #e5e7eb;">Qty</th>';
      html += '<th style="padding: 10px 12px; text-align: right; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; border-bottom: 1px solid #e5e7eb;">Price</th>';
      html += '<th style="padding: 10px 12px; text-align: right; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; border-bottom: 1px solid #e5e7eb;">Total</th>';
      html += '</tr>';
      html += '</thead>';
      html += '<tbody>';
      
      inv.animals.forEach(function(animal) {
        var animalId = animal["UNIQUE ID"] || animal["MANUAL OVERRIDE"] || "";
        var animalName = animal["ANIMAL NAME"] || "";
        var species = animal["SPECIES"] || "";
        var sex = animal["SEX"] || "";
        var genetics = animal["GENETIC SUMMARY"] || "";
        var price = parseFloat(animal["SOLD PRICE"]) || 0;
        
        html += '<tr>';
        html += '<td style="padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: top;">';
        html += '<div style="font-weight: 600; color: #111;">' + escapeHtml(animalId) + '</div>';
        if (animalName) html += '<div style="color: #666;">' + escapeHtml(animalName) + '</div>';
        html += '<div style="color: #888; font-size: 12px;">' + escapeHtml(species) + ' - ' + escapeHtml(sex) + '</div>';
        if (genetics) html += '<div style="color: #888; font-size: 12px;">' + escapeHtml(genetics) + '</div>';
        html += '</td>';
        html += '<td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; vertical-align: top;">1</td>';
        html += '<td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: right; vertical-align: top;">$' + price.toFixed(2) + '</td>';
        html += '<td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: right; vertical-align: top; font-weight: 500;">$' + price.toFixed(2) + '</td>';
        html += '</tr>';
      });
      
      html += '</tbody>';
      html += '</table>';
      
      // Totals Section
      html += '<div style="display: flex; justify-content: flex-end;">';
      html += '<div style="width: 280px;">';
      
      html += '<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">';
      html += '<span style="color: #666;">SUBTOTAL</span>';
      html += '<span style="color: #111;">$' + subtotal.toFixed(2) + '</span>';
      html += '</div>';
      
      if (shipping > 0) {
        html += '<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">';
        html += '<span style="color: #666;">SHIPPING</span>';
        html += '<span style="color: #111;">$' + shipping.toFixed(2) + '</span>';
        html += '</div>';
      }
      
      if (taxRate > 0) {
        html += '<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">';
        html += '<span style="color: #666;">TAX ' + taxRate + '%</span>';
        html += '<span style="color: #111;">$' + taxAmount.toFixed(2) + '</span>';
        html += '</div>';
      }
      
      if (deposit > 0) {
        html += '<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">';
        html += '<span style="color: #666;">DEPOSIT</span>';
        html += '<span style="color: #111;">-$' + deposit.toFixed(2) + '</span>';
        html += '</div>';
      }
      
      html += '<div style="display: flex; justify-content: space-between; padding: 12px; background: #e5e7eb; margin-top: 10px;">';
      html += '<span style="font-weight: 700; color: #111;">AMOUNT DUE</span>';
      html += '<span style="font-weight: 700; font-size: 18px; color: #111;">$' + balanceDue.toFixed(2) + '</span>';
      html += '</div>';
      
      html += '</div>';
      html += '</div>';
      
      // Terms / Footer
      var terms = settings["INVOICE TERMS"] || "";
      if (terms || inv.notes) {
        html += '<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #666;">';
        if (terms) html += '<div>' + escapeHtml(terms) + '</div>';
        if (inv.notes) html += '<div style="margin-top: 10px;"><strong>Notes:</strong> ' + escapeHtml(inv.notes) + '</div>';
        html += '</div>';
      }
      
      html += '</div>';
      
      return html;
    }
    
    function formatDateDisplay(dateStr) {
      if (!dateStr) return "";
      var d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return (d.getMonth() + 1) + "/" + d.getDate() + "/" + d.getFullYear();
    }
    
    function previewInvoice() {
      var html = generateInvoiceHTML();
      document.getElementById("invoicePrintArea").innerHTML = html;
      document.getElementById("invoicePreviewModal").classList.remove("hidden");
    }
    
    function closeInvoicePreview() {
      document.getElementById("invoicePreviewModal").classList.add("hidden");
    }
    
    function printInvoice() {
      previewInvoice();
      setTimeout(function() {
        window.print();
      }, 300);
    }
    
    function printInvoiceFromPreview() {
      window.print();
    }
    
    function downloadInvoicePDF() {
      var jsPDF = window.jspdf.jsPDF;
      var doc = new jsPDF('p', 'pt', 'letter');
      
      var inv = state.invoice;
      var settings = state.settings;
      
      // Calculate totals
      var subtotal = 0;
      inv.animals.forEach(function(a) {
        subtotal += parseFloat(a["SOLD PRICE"]) || 0;
      });
      var shipping = parseFloat(inv.shipping) || 0;
      var taxRate = parseFloat(inv.taxRate) || 0;
      var taxAmount = (subtotal + shipping) * (taxRate / 100);
      var total = subtotal + shipping + taxAmount;
      var deposit = parseFloat(inv.deposit) || 0;
      var balanceDue = total - deposit;
      
      var pageWidth = 612;
      var margin = 50;
      var y = 50;
      
      // Header background
      doc.setFillColor(243, 244, 246);
      doc.rect(0, 0, pageWidth, 80, 'F');
      
      // INVOICE title
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(28);
      doc.setTextColor(17, 17, 17);
      doc.text('INVOICE', margin, 50);
      
      // Invoice details (right side)
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(102, 102, 102);
      doc.text('INVOICE #', 400, 30);
      doc.text('INVOICE DATE', 470, 30);
      doc.text('DUE DATE', 540, 30);
      
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(17, 17, 17);
      doc.text(inv.number, 400, 45);
      doc.text(formatDateDisplay(inv.date), 470, 45);
      doc.text(formatDateDisplay(inv.dueDate), 540, 45);
      
      y = 110;
      
      // Seller info
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.text(settings["BUSINESS NAME"] || "Your Business Name", margin, y);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(102, 102, 102);
      y += 15;
      var address = [];
      if (settings["CITY"]) address.push(settings["CITY"]);
      if (settings["STATE"]) address.push(settings["STATE"]);
      if (settings["ZIP"]) address.push(settings["ZIP"]);
      if (address.length > 0) {
        doc.text(address.join(", "), margin, y);
        y += 12;
      }
      if (settings["EMAIL"]) {
        doc.text(settings["EMAIL"], margin, y);
        y += 12;
      }
      if (settings["PHONE"]) {
        doc.text(settings["PHONE"], margin, y);
      }
      
      // Buyer info (right side)
      var buyerY = 110;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(9);
      doc.setTextColor(153, 153, 153);
      doc.text('BILL TO:', pageWidth - margin - 150, buyerY - 10);
      
      doc.setTextColor(17, 17, 17);
      doc.setFontSize(11);
      doc.text(inv.buyerName || "Customer Name", pageWidth - margin - 150, buyerY + 5);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(102, 102, 102);
      if (inv.buyerAddress) {
        doc.text(inv.buyerAddress, pageWidth - margin - 150, buyerY + 20);
      }
      if (inv.buyerEmail) {
        doc.text(inv.buyerEmail, pageWidth - margin - 150, buyerY + 35);
      }
      
      // Line items table
      y = 180;
      
      // Table header
      doc.setFillColor(249, 250, 251);
      doc.rect(margin, y, pageWidth - (margin * 2), 25, 'F');
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(9);
      doc.setTextColor(107, 114, 128);
      doc.text('ANIMAL ID / DESCRIPTION', margin + 10, y + 16);
      doc.text('QTY', 380, y + 16);
      doc.text('PRICE', 430, y + 16);
      doc.text('TOTAL', 510, y + 16);
      
      y += 30;
      
      // Table rows
      inv.animals.forEach(function(animal) {
        var animalId = animal["UNIQUE ID"] || animal["MANUAL OVERRIDE"] || "";
        var animalName = animal["ANIMAL NAME"] || "";
        var species = animal["SPECIES"] || "";
        var sex = animal["SEX"] || "";
        var genetics = animal["GENETIC SUMMARY"] || "";
        var price = parseFloat(animal["SOLD PRICE"]) || 0;
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(17, 17, 17);
        doc.text(animalId, margin + 10, y + 12);
        
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(102, 102, 102);
        if (animalName) {
          doc.text(animalName, margin + 10, y + 24);
        }
        doc.setFontSize(9);
        doc.text(species + ' - ' + sex, margin + 10, y + 36);
        if (genetics) {
          var maxWidth = 250;
          var geneticsLines = doc.splitTextToSize(genetics, maxWidth);
          doc.text(geneticsLines, margin + 10, y + 48);
        }
        
        doc.setTextColor(17, 17, 17);
        doc.setFontSize(10);
        doc.text('1', 388, y + 12);
        doc.text('$' + price.toFixed(2), 430, y + 12);
        doc.setFont('helvetica', 'bold');
        doc.text('$' + price.toFixed(2), 510, y + 12);
        
        // Row line
        doc.setDrawColor(229, 231, 235);
        doc.line(margin, y + 55, pageWidth - margin, y + 55);
        
        y += 60;
      });
      
      // Totals
      y += 20;
      var totalsX = 400;
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(102, 102, 102);
      doc.text('SUBTOTAL', totalsX, y);
      doc.setTextColor(17, 17, 17);
      doc.text('$' + subtotal.toFixed(2), 530, y);
      
      if (shipping > 0) {
        y += 18;
        doc.setTextColor(102, 102, 102);
        doc.text('SHIPPING', totalsX, y);
        doc.setTextColor(17, 17, 17);
        doc.text('$' + shipping.toFixed(2), 530, y);
      }
      
      if (taxRate > 0) {
        y += 18;
        doc.setTextColor(102, 102, 102);
        doc.text('TAX ' + taxRate + '%', totalsX, y);
        doc.setTextColor(17, 17, 17);
        doc.text('$' + taxAmount.toFixed(2), 530, y);
      }
      
      if (deposit > 0) {
        y += 18;
        doc.setTextColor(102, 102, 102);
        doc.text('DEPOSIT', totalsX, y);
        doc.setTextColor(17, 17, 17);
        doc.text('-$' + deposit.toFixed(2), 530, y);
      }
      
      // Amount due box
      y += 25;
      doc.setFillColor(229, 231, 235);
      doc.rect(totalsX - 10, y - 12, pageWidth - margin - totalsX + 10, 30, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.setTextColor(17, 17, 17);
      doc.text('AMOUNT DUE', totalsX, y + 5);
      doc.setFontSize(14);
      doc.text('$' + balanceDue.toFixed(2), pageWidth - margin - 10, y + 5, { align: 'right' });
      
      // Terms footer
      var terms = settings["INVOICE TERMS"] || "";
      if (terms || inv.notes) {
        y += 60;
        doc.setDrawColor(229, 231, 235);
        doc.line(margin, y, pageWidth - margin, y);
        y += 15;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(102, 102, 102);
        if (terms) {
          var termsLines = doc.splitTextToSize(terms, pageWidth - (margin * 2));
          doc.text(termsLines, margin, y);
          y += termsLines.length * 12;
        }
        if (inv.notes) {
          doc.text('Notes: ' + inv.notes, margin, y + 5);
        }
      }
      
      // Save
      doc.save('Invoice_' + inv.number + '.pdf');
    }

    // ============ START ============
    init();
  </script>

  <!-- Footer -->
  <footer class="mt-8 py-6 border-t border-gray-200 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-500">
      <div class="mb-2">
        <a href="https://therackapp.io/policies/privacy-policy" target="_blank" class="hover:text-gray-700 hover:underline">Privacy Policy</a>
        <span class="mx-2">|</span>
        <a href="https://therackapp.io/policies/terms-of-service" target="_blank" class="hover:text-gray-700 hover:underline">Terms of Service</a>
      </div>
      <div>
        (c) 2026 The Rack App | DBA Soul Serpents, LLC. All rights reserved.
      </div>
    </div>
  </footer>
</body>
</html
