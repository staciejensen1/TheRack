<!DOCTYPE html>
<!--
  THE RACK - Reptile Breeding Program Management
  Version: 2.10.0
  Last Updated: 2026-01-07
  
  Changelog:
  - 2.10.0: Filter dropdowns (Sex, Status, Species), clickable gene tags, maturity auto-calc, monochrome status badges
  - 2.9.1: Fixed Edit button on all table views, added fallback headers
  - 2.9.0: Delete button on all table views, stats cards restored, Settings tab integration
  - 2.8.9: Fixed QR codes to be square in tables
  - 2.8.8: Removed stats cards from table pages (dashboard only), fixed QR print to use image API
  - 2.8.7: Fixed Print QR Codes to use image-based QR codes (api.qrserver.com)
  - 2.8.6: Fixed stats cards to use correct property names from calculateStats
  - 2.8.5: Fixed MorphMarket import mapping (GENETIC SUMMARY, WT PURCHASE, BREEDER SOURCE)
  - 2.8.4: Added QR code column to Collection and Hatchlings tables
  - 2.8.0: Archive feature - delete moves to Archive tab, can restore from Archive view
  - 2.7.0: MorphMarket CSV import with field mapping
  - 2.6.0: QR code generation and scanning for quick activity logging
  - 2.5.0: Mobile-friendly redesign with hamburger menu
  - 2.4.0: Added last year sales comparison on dashboard
  - 2.0.0: Apps Script API backend
  - 1.0.0: Initial release
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Rack - Breeding Program Management</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    * { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .mono { font-family: ui-monospace, monospace; }
    .modal-backdrop { backdrop-filter: blur(4px); }
    .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    
    /* QR Print Styles */
    @media print {
      body * { visibility: hidden; }
      #qrPrintArea, #qrPrintArea * { visibility: visible; }
      #qrPrintArea { position: absolute; left: 0; top: 0; }
    }
    .qr-label { page-break-inside: avoid; }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen">
  
  <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">
    <!-- Header -->
    <header class="bg-white rounded-2xl p-4 md:p-6 shadow-sm mb-4 md:mb-6 border border-gray-200">
      <div class="flex items-center justify-between gap-4">
        <!-- Hamburger + Logo -->
        <div class="flex items-center gap-3">
          <!-- Hamburger Menu Button (mobile only) -->
          <button id="menuBtn" onclick="toggleMobileMenu()" class="md:hidden p-2 -ml-2 text-gray-700 hover:bg-gray-100 rounded-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
          
          <!-- Logo SVG -->
          <svg viewBox="0 0 320 60" class="h-10 md:h-14" xmlns="http://www.w3.org/2000/svg">
            <g transform="translate(30, 25)">
              <path d="M-16 -14 L-8 -14 L0 -6 L-8 2 L0 10 L-8 18 L-16 18" 
                    stroke="#000" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M16 -14 L8 -14 L0 -6 L8 2 L0 10 L8 18 L16 18" 
                    stroke="#000" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="-16" cy="-14" r="2" fill="#000"/>
              <circle cx="16" cy="-14" r="2" fill="#000"/>
            </g>
            <text x="62" y="32" fill="#000" font-family="Inter, system-ui, sans-serif" font-weight="800" font-size="26" letter-spacing="-1">THE RACK</text>
            <text x="62" y="48" fill="#888" font-family="Inter, system-ui, sans-serif" font-weight="500" font-size="8" letter-spacing="2">RACK IT. TRACK IT. RUN IT.</text>
          </svg>
          <span id="versionTag" class="text-xs text-gray-400 hidden md:inline">v2.4.1</span>
        </div>

        <!-- Desktop: Login/Connected -->
        <div class="hidden md:flex flex-wrap items-center gap-2 md:gap-3">
          <!-- Login Form (shown when not logged in) -->
          <div id="loginGroup" class="flex flex-wrap items-center gap-2">
            <input
              type="email"
              id="emailInput"
              placeholder="Email (from purchase)"
              class="px-3 py-2 border border-gray-300 rounded-xl bg-gray-50 text-sm w-48 focus:border-gray-500 focus:ring-1 focus:ring-gray-500"
            />
            <input
              type="text"
              id="accessCodeInput"
              placeholder="Access Code"
              class="px-3 py-2 border border-gray-300 rounded-xl bg-gray-50 mono text-sm w-48 focus:border-gray-500 focus:ring-1 focus:ring-gray-500"
            />
            <button id="loginBtn" class="px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black text-sm">
              Log In
            </button>
          </div>

          <!-- Connected Status (shown when logged in) -->
          <div id="connectedGroup" class="flex items-center gap-2 hidden">
            <span id="userEmail" class="text-sm text-gray-600"></span>
            <button id="syncBtn" onclick="loadData()" class="px-3 py-2 bg-gray-100 text-gray-700 font-medium rounded-xl hover:bg-gray-200 text-sm" title="Sync data">
              üîÑ Sync
            </button>
            <button id="signOutBtn" class="px-3 py-2 bg-gray-200 text-gray-700 font-medium rounded-xl hover:bg-gray-300 text-sm">
              Sign out
            </button>
          </div>
        </div>

        <!-- Mobile: Sync button only when logged in -->
        <div id="mobileSyncBtn" class="md:hidden hidden">
          <button onclick="loadData()" class="p-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200" title="Sync">
            üîÑ
          </button>
        </div>
      </div>

      <!-- Mobile Login Form -->
      <div id="mobileLoginGroup" class="md:hidden mt-4 hidden">
        <div class="flex flex-col gap-2">
          <input
            type="email"
            id="mobileEmailInput"
            placeholder="Email (from purchase)"
            class="px-3 py-2 border border-gray-300 rounded-xl bg-gray-50 text-sm focus:border-gray-500 focus:ring-1 focus:ring-gray-500"
          />
          <input
            type="text"
            id="mobileAccessCodeInput"
            placeholder="Access Code"
            class="px-3 py-2 border border-gray-300 rounded-xl bg-gray-50 mono text-sm focus:border-gray-500 focus:ring-1 focus:ring-gray-500"
          />
          <button id="mobileLoginBtn" class="px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black text-sm">
            Log In
          </button>
        </div>
      </div>

      <div class="mt-3 flex items-center gap-4 text-sm">
        <span id="statusText" class="text-gray-500">Starting up...</span>
      </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div id="mobileMenuOverlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" onclick="toggleMobileMenu()"></div>
    
    <!-- Mobile Slide-out Menu -->
    <aside id="mobileMenu" class="fixed top-0 left-0 h-full w-72 bg-white shadow-2xl z-50 transform -translate-x-full transition-transform duration-300 md:hidden overflow-y-auto">
      <div class="p-4">
        <div class="flex items-center justify-between mb-6">
          <span class="font-bold text-gray-900">Menu</span>
          <button onclick="toggleMobileMenu()" class="p-2 text-gray-500 hover:bg-gray-100 rounded-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Mobile User Info -->
        <div id="mobileUserInfo" class="mb-6 p-3 bg-gray-50 rounded-xl hidden">
          <div id="mobileUserEmail" class="text-sm text-gray-600 truncate"></div>
          <button onclick="handleSignOut(); toggleMobileMenu();" class="mt-2 text-sm text-red-600 hover:text-red-700">Sign out</button>
        </div>

        <!-- Navigation -->
        <div class="mb-6">
          <div class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Navigation</div>
          <nav id="mobileNavTabs" class="flex flex-col gap-1"></nav>
        </div>

        <!-- Quick Add -->
        <div class="mb-6">
          <div class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Quick Add</div>
          <div class="flex flex-col gap-1">
            <button onclick="openAddModal('collection'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Breeder</button>
            <button onclick="openAddModal('clutch'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Clutch</button>
            <button onclick="openAddModal('hatchling'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Hatchling</button>
            <button onclick="openAddModal('activity'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Activity</button>
          </div>
        </div>

        <!-- Tools -->
        <div class="pt-4 border-t border-gray-100">
          <div class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Tools</div>
          <div class="flex flex-col gap-1">
            <button onclick="openImportModal(); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Import from MorphMarket</button>
            <button onclick="exportCSV('collection'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Export Collection</button>
            <button onclick="exportCSV('clutch'); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Export Clutches</button>
            <button onclick="showDataHealth(); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Data Health</button>
            <button onclick="openQRGenerator(); toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Print QR Codes</button>
          </div>
        </div>

        <!-- Support -->
        <div class="mt-6 pt-4 border-t border-gray-100">
          <a href="https://docs.google.com/forms/d/e/1FAIpQLSc1cdNzPiLLteHIIUMD83yUc4BLZ1JL8hmpuwsiYUGMcPHBaQ/viewform" target="_blank" onclick="toggleMobileMenu();" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg block">
            Submit Support Ticket
          </a>
        </div>
      </div>
    </aside>

    <div class="flex flex-col md:flex-row gap-6">
      <!-- Desktop Sidebar -->
      <aside class="hidden md:block w-56 shrink-0">
        <div class="bg-white rounded-2xl p-4 shadow-sm sticky top-6 border border-gray-200">
          <!-- Quick Add -->
          <div class="mb-6">
            <div class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Quick Add</div>
            <div class="flex flex-col gap-1">
              <button onclick="openAddModal('collection')" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Breeder</button>
              <button onclick="openAddModal('clutch')" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Clutch</button>
              <button onclick="openAddModal('hatchling')" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Hatchling</button>
              <button onclick="openAddModal('activity')" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-left">+ Activity</button>
            </div>
          </div>
          
          <!-- Navigation -->
          <div class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Navigation</div>
          <nav id="navTabs" class="flex flex-col gap-1">
          </nav>

          <!-- Tools -->
          <div class="mt-6 pt-4 border-t border-gray-100">
            <div class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Tools</div>
            <div class="flex flex-col gap-1">
              <button onclick="openImportModal()" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Import from MorphMarket</button>
              <button onclick="exportCSV('collection')" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Export Collection</button>
              <button onclick="exportCSV('clutch')" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Export Clutches</button>
              <button onclick="openQRGenerator()" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Print QR Codes</button>
              <button onclick="showDataHealth()" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg text-left">Data Health</button>
            </div>
          </div>

          <!-- Support -->
          <div class="mt-6 pt-4 border-t border-gray-100">
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSc1cdNzPiLLteHIIUMD83yUc4BLZ1JL8hmpuwsiYUGMcPHBaQ/viewform" target="_blank" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg block">
              Submit Support Ticket
            </a>
          </div>
        </div>
      </aside>

      <!-- Main content -->
      <main class="flex-1 min-w-0">
        <!-- Mobile Quick Add Bar -->
        <div class="md:hidden bg-white rounded-2xl p-3 shadow-sm border border-gray-200 mb-4">
          <div class="flex items-center justify-between gap-2 overflow-x-auto">
            <button onclick="openAddModal('collection')" class="flex-shrink-0 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-200">+ Breeder</button>
            <button onclick="openAddModal('clutch')" class="flex-shrink-0 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-200">+ Clutch</button>
            <button onclick="openAddModal('hatchling')" class="flex-shrink-0 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-200">+ Hatchling</button>
            <button onclick="openAddModal('activity')" class="flex-shrink-0 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-200">+ Activity</button>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-4 md:p-6 shadow-sm border border-gray-200">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <button id="backBtn" onclick="goBack()" class="px-3 py-2 bg-gray-100 text-gray-700 font-medium rounded-xl hover:bg-gray-200 text-sm hidden">
                ‚Üê Back
              </button>
              <h2 id="pageTitle" class="text-xl font-bold text-gray-900 capitalize">Dashboard</h2>
            </div>
            <button id="addBtn" onclick="openAddModal(state.activeTab)" class="px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black hidden text-sm">
              + Add New
            </button>
          </div>
          
          <!-- Dashboard -->
          <div id="dashboardView"></div>

          <!-- Stats Cards (shown on table pages) -->
          <div id="tableStatsView" class="hidden mb-4"></div>

          <!-- Filter Bar (shown on table pages) -->
          <div id="filterBar" class="hidden mb-4 flex flex-wrap gap-2 items-center">
            <select id="filterSex" onchange="applyFilter('sex', this.value)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
              <option value="">All Sex</option>
              <option value="Female">Female</option>
              <option value="Male">Male</option>
              <option value="Unknown">Unknown</option>
            </select>
            <select id="filterStatus" onchange="applyFilter('status', this.value)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
              <option value="">All Status</option>
              <option value="Breeder">Breeder</option>
              <option value="Listed">Listed</option>
              <option value="Unlisted">Unlisted</option>
              <option value="Holdback">Holdback</option>
              <option value="On Hold">On Hold</option>
              <option value="Sold">Sold</option>
              <option value="On Loan">On Loan</option>
            </select>
            <select id="filterSpecies" onchange="applyFilter('species', this.value)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
              <option value="">All Species</option>
            </select>
            <span id="geneFilterDisplay" class="hidden px-3 py-1 bg-gray-100 border border-gray-300 rounded-full text-sm flex items-center gap-2">
              <span id="geneFilterText"></span>
              <button onclick="clearGeneFilter()" class="text-gray-500 hover:text-gray-700">&times;</button>
            </span>
            <button id="clearFiltersBtn" onclick="clearAllFilters()" class="hidden px-3 py-2 text-gray-500 hover:text-gray-700 text-sm">
              Clear Filters
            </button>
          </div>

          <!-- Data table -->
          <div id="tableView" class="overflow-x-auto hidden">
            <table class="min-w-full text-sm">
              <thead id="tableHead">
                <tr class="border-b border-gray-200"></tr>
              </thead>
              <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- QR Code Generator Modal -->
  <div id="qrModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden z-50 overflow-auto">
    <div class="min-h-screen flex items-start justify-center p-4">
      <div class="w-full max-w-4xl my-8 bg-white rounded-2xl shadow-2xl">
        <div class="p-4 md:p-6 border-b border-slate-200 flex items-center justify-between">
          <h3 class="text-xl font-bold text-slate-900">Print QR Codes</h3>
          <button onclick="closeQRModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <div class="p-4 md:p-6">
          <!-- Options -->
          <div class="mb-6 flex flex-wrap gap-4 items-center">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Select Animals</label>
              <select id="qrAnimalSelect" onchange="updateQRPreview()" class="px-3 py-2 border border-gray-300 rounded-xl text-sm">
                <option value="all">All Animals</option>
                <option value="breeders">Breeders Only</option>
                <option value="hatchlings">Hatchlings Only</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Label Size</label>
              <select id="qrSizeSelect" onchange="updateQRPreview()" class="px-3 py-2 border border-gray-300 rounded-xl text-sm">
                <option value="small">Small (1" x 1")</option>
                <option value="medium" selected>Medium (1.5" x 1.5")</option>
                <option value="large">Large (2" x 2")</option>
              </select>
            </div>
            <button onclick="printQRCodes()" class="px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black text-sm">
              Print
            </button>
          </div>
          
          <!-- Preview -->
          <div id="qrPreview" class="border border-gray-200 rounded-xl p-4 bg-gray-50 max-h-96 overflow-auto">
            <p class="text-gray-500 text-sm">Loading preview...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden z-50 overflow-auto">
    <div class="min-h-screen flex items-start justify-center p-4">
      <div class="w-full max-w-4xl my-8 bg-white rounded-2xl shadow-2xl">
        <div class="p-4 md:p-6 border-b border-slate-200 flex items-center justify-between">
          <h3 class="text-xl font-bold text-slate-900">Import from MorphMarket</h3>
          <button onclick="closeImportModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <div class="p-4 md:p-6">
          <!-- Step 1: Upload -->
          <div id="importStep1">
            <div class="mb-4">
              <p class="text-gray-600 mb-4">Upload your MorphMarket CSV export file. Go to MorphMarket &gt; My Store &gt; Inventory &gt; Export to download your file.</p>
              <label class="block">
                <span class="sr-only">Choose CSV file</span>
                <input type="file" id="importFileInput" accept=".csv" onchange="handleImportFile(event)" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-gray-900 file:text-white hover:file:bg-black cursor-pointer"/>
              </label>
            </div>
          </div>
          
          <!-- Step 2: Preview -->
          <div id="importStep2" class="hidden">
            <div class="mb-4 flex items-center justify-between">
              <div>
                <span id="importCount" class="font-bold text-gray-900">0</span>
                <span class="text-gray-600">animals to import</span>
              </div>
              <div class="flex gap-2">
                <button onclick="resetImport()" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-xl hover:bg-gray-300 text-sm">
                  Back
                </button>
                <button onclick="executeImport()" id="importBtn" class="px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black text-sm">
                  Import All
                </button>
              </div>
            </div>
            
            <!-- Preview Table -->
            <div class="border border-gray-200 rounded-xl overflow-hidden">
              <div class="max-h-96 overflow-auto">
                <table class="min-w-full text-sm">
                  <thead class="bg-gray-50 sticky top-0">
                    <tr>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Action</th>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Name</th>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Manual ID</th>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Sex</th>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Status</th>
                      <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Genes</th>
                    </tr>
                  </thead>
                  <tbody id="importPreviewBody" class="divide-y divide-gray-100">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Step 3: Progress -->
          <div id="importStep3" class="hidden">
            <div class="text-center py-8">
              <div class="mb-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-gray-900"></div>
              </div>
              <p id="importProgress" class="text-gray-600 font-medium">Importing...</p>
              <p class="text-gray-400 text-sm mt-2">Please be patient - this may take a few minutes for large imports.</p>
              <p class="text-gray-400 text-sm">Do not close this window.</p>
            </div>
          </div>
          
          <!-- Step 4: Complete -->
          <div id="importStep4" class="hidden">
            <div class="text-center py-8">
              <div class="text-4xl mb-4">Done!</div>
              <p id="importResult" class="text-gray-600 mb-4">Successfully imported 0 animals.</p>
              <button onclick="closeImportModal(); loadData();" class="px-4 py-2 bg-gray-900 text-white font-bold rounded-xl hover:bg-black text-sm">
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="modal" class="fixed inset-0 bg-black/50 modal-backdrop hidden z-50 overflow-auto">
    <div class="min-h-screen flex items-start justify-center p-4">
      <div class="w-full max-w-2xl my-8 bg-white rounded-2xl shadow-2xl">
        <div class="p-4 md:p-6 border-b border-slate-200 flex items-center justify-between">
          <h3 id="modalTitle" class="text-xl font-bold text-slate-900">Add New</h3>
          <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <!-- Read-only ID display -->
        <div id="modalIdDisplay" class="hidden px-4 md:px-6 pt-4">
          <div class="bg-slate-100 rounded-xl px-4 py-3">
            <div class="text-xs text-slate-500 uppercase">Unique ID</div>
            <div id="modalIdValue" class="font-bold mono text-lg"></div>
            <div class="text-xs text-slate-400">Auto-generated (read-only)</div>
          </div>
        </div>

        <div id="modalBody" class="p-4 md:p-6 max-h-[60vh] overflow-auto"></div>

        <div class="p-4 md:p-6 border-t border-slate-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
          <span id="modalError" class="text-red-600 text-sm"></span>
          <div class="flex gap-3">
            <button onclick="closeModal()" class="px-5 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200">
              Cancel
            </button>
            <button id="saveBtn" onclick="saveRecord()" class="px-5 py-2.5 bg-gray-900 text-white font-bold rounded-xl hover:bg-black">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hatch Modal -->
  <div id="hatchModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden z-50 overflow-auto">
    <div class="min-h-screen flex items-start justify-center p-4">
      <div class="w-full max-w-4xl my-8 bg-white rounded-2xl shadow-2xl">
        <div class="p-4 md:p-6 border-b border-slate-200 flex items-center justify-between">
          <div>
            <h3 class="text-xl font-bold text-slate-900">Hatch Clutch</h3>
            <p id="hatchClutchId" class="text-sm text-slate-500"></p>
          </div>
          <button onclick="closeHatchModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <div id="hatchModalBody" class="p-4 md:p-6"></div>

        <div class="p-4 md:p-6 border-t border-slate-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
          <span id="hatchModalError" class="text-red-600 text-sm"></span>
          <div class="flex flex-wrap gap-3">
            <button onclick="closeHatchModal()" class="px-5 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200">
              Cancel
            </button>
            <button id="hatchOnlyBtn" onclick="markHatchedOnly()" class="px-5 py-2.5 bg-gray-600 text-white font-bold rounded-xl hover:bg-gray-700">
              Mark Hatched Only
            </button>
            <button id="hatchAndCreateBtn" onclick="hatchAndCreateHatchlings()" class="px-5 py-2.5 bg-gray-900 text-white font-bold rounded-xl hover:bg-black">
              Hatch & Create Hatchlings
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sale Modal -->
  <div id="saleModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden z-50 overflow-auto">
    <div class="min-h-screen flex items-start justify-center p-4">
      <div class="w-full max-w-lg my-8 bg-white rounded-2xl shadow-2xl">
        <div class="p-4 md:p-6 border-b border-slate-200 flex items-center justify-between">
          <div>
            <h3 class="text-xl font-bold text-slate-900">Record Sale</h3>
            <p id="saleAnimalId" class="text-sm text-slate-500 mono"></p>
          </div>
          <button onclick="closeSaleModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        
        <div id="saleModalBody" class="p-4 md:p-6"></div>

        <div class="p-4 md:p-6 border-t border-slate-200 flex justify-between items-center">
          <span id="saleModalError" class="text-red-600 text-sm"></span>
          <div class="flex gap-3">
            <button onclick="closeSaleModal()" class="px-5 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200">
              Cancel
            </button>
            <button id="saveSaleBtn" onclick="saveSale()" class="px-5 py-2.5 bg-gray-900 text-white font-bold rounded-xl hover:bg-black">
              Save Sale
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============ CONFIGURATION ============
    var VERSION = "2.10.0";
    var API_URL = "https://script.google.com/macros/s/AKfycby2kLix-oIdZxtWqqMJxaNUZvbUKF1O33BphEVV5ZfADxO1cjJXrDMHhPeRZF1t32rH/exec";
    
    var SHEET_TABS = {
      collection: "Collection",
      clutch: "Clutch", 
      activity: "Activity",
      archive: "Archive",
      settings: "Settings"
    };

    var FIELD_OPTIONS = {
      SEX: ["Female", "Male", "Unknown"],
      STATUS: ["Breeder", "Holdback", "Listed", "Unlisted", "On Hold", "Sold", "Deceased", "Retired", "On Loan"],
      CLUTCH_STATUS: ["Incubating", "Hatched", "Failed"],
      ACTIVITY: ["Took Meal", "Refused Meal", "Weight", "Shed", "Note", "Health Hold", "Paired", "Lock", "Follicle Size", "Ovulation", "Pre Lay Shed", "Laid", "Sold"],
      SALE_SOURCE: ["MorphMarket", "Instagram", "Facebook", "Repeat Buyer", "Local Show", "Website", "Other"],
      PAYMENT_STATUS: ["Deposit", "Paid", "Refunded"]
    };

    // ============ STATE ============
    var state = {
      email: localStorage.getItem("therack_email") || "",
      sheetId: localStorage.getItem("therack_sheet_id") || "",
      isLoggedIn: false,
      isLoading: false,
      activeTab: "dashboard",
      data: { collection: [], clutch: [], activity: [], archive: [], settings: {} },
      headers: { collection: [], clutch: [], activity: [], archive: [] },
      settings: {},
      modalMode: "add",
      modalTab: null,
      editRowIndex: null,
      formData: {},
      hatchClutchRow: null,
      hatchDate: "",
      hatchCount: 1,
      hatchDrafts: [],
      saleAnimalRow: null,
      saleForm: {},
      // QR scan pending action
      qrPending: null,
      // Table filters
      filters: {
        sex: "",
        status: "",
        species: "",
        gene: ""
      }
    };

    // ============ INITIALIZATION ============
    function init() {
      // Set version
      document.getElementById("versionTag").textContent = "v" + VERSION;
      
      // Check for QR code parameters in URL
      var urlParams = new URLSearchParams(window.location.search);
      var qrCode = urlParams.get('code');
      var qrAnimal = urlParams.get('animal');
      
      if (qrCode && qrAnimal) {
        // Clear URL params without reload
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Check if already logged into this account
        if (state.sheetId === qrCode && state.email) {
          state.isLoggedIn = true;
          state.qrPending = { animal: qrAnimal };
          updateUI();
          setStatus("QR scanned! Loading data...");
          loadData(); // Will trigger QR action after load
        } else {
          // Need to log in - save pending action
          state.qrPending = { code: qrCode, animal: qrAnimal };
          updateUI();
          setStatus("QR scanned for " + qrAnimal + ". Please log in to record activity.");
        }
      } else if (state.email && state.sheetId) {
        // Normal login check
        state.isLoggedIn = true;
        updateUI();
        setStatus("Welcome back! Loading your data...");
        loadData();
      } else {
        updateUI();
        setStatus("Enter your email and access code to log in.");
      }

      document.getElementById("loginBtn").addEventListener("click", handleLogin);
      document.getElementById("mobileLoginBtn").addEventListener("click", handleMobileLogin);
      document.getElementById("signOutBtn").addEventListener("click", handleSignOut);

      renderNavTabs();
    }

    // ============ MOBILE MENU ============
    function toggleMobileMenu() {
      var menu = document.getElementById("mobileMenu");
      var overlay = document.getElementById("mobileMenuOverlay");
      var isOpen = !menu.classList.contains("-translate-x-full");
      
      if (isOpen) {
        menu.classList.add("-translate-x-full");
        overlay.classList.add("hidden");
        document.body.style.overflow = "";
      } else {
        menu.classList.remove("-translate-x-full");
        overlay.classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }
    }

    function handleMobileLogin() {
      var email = document.getElementById("mobileEmailInput").value.trim().toLowerCase();
      var code = document.getElementById("mobileAccessCodeInput").value.trim();

      if (!email) {
        setStatus("Please enter your email", true);
        return;
      }
      if (!code) {
        setStatus("Please enter your access code", true);
        return;
      }

      setStatus("Logging in...");
      document.getElementById("mobileLoginBtn").textContent = "Logging in...";
      document.getElementById("mobileLoginBtn").disabled = true;

      // If QR pending, use that code
      if (state.qrPending && state.qrPending.code) {
        code = state.qrPending.code;
      }

      var url = API_URL + "?action=login&email=" + encodeURIComponent(email) + "&code=" + encodeURIComponent(code);
      
      fetch(url)
        .then(function(response) { return response.json(); })
        .then(function(data) {
          if (data.success) {
            state.email = email;
            state.sheetId = data.sheetId;
            state.isLoggedIn = true;

            localStorage.setItem("therack_email", email);
            localStorage.setItem("therack_sheet_id", data.sheetId);

            // Preserve QR animal for after load
            if (state.qrPending && state.qrPending.animal) {
              state.qrPending = { animal: state.qrPending.animal };
            }

            setStatus("Logged in! Loading your data...");
            updateUI();
            loadData();
          } else {
            setStatus(data.error || "Invalid email or access code", true);
          }
        })
        .catch(function(error) {
          setStatus("Login failed: " + error.message, true);
        })
        .finally(function() {
          document.getElementById("mobileLoginBtn").textContent = "Log In";
          document.getElementById("mobileLoginBtn").disabled = false;
        });
    }

    // ============ API HELPER ============
    function apiCall(action, params) {
      var url = API_URL + "?action=" + action;
      url += "&email=" + encodeURIComponent(state.email);
      url += "&code=" + encodeURIComponent(state.sheetId);
      
      for (var key in params) {
        if (params[key] !== undefined) {
          var value = typeof params[key] === 'object' ? JSON.stringify(params[key]) : params[key];
          url += "&" + key + "=" + encodeURIComponent(value);
        }
      }
      
      return fetch(url).then(function(response) { 
        return response.json(); 
      });
    }

    // ============ LOGIN ============
    function handleLogin() {
      var email = document.getElementById("emailInput").value.trim().toLowerCase();
      var code = document.getElementById("accessCodeInput").value.trim();

      if (!email) {
        setStatus("Please enter your email", true);
        return;
      }
      if (!code) {
        setStatus("Please enter your access code", true);
        return;
      }

      setStatus("Logging in...");
      document.getElementById("loginBtn").textContent = "Logging in...";
      document.getElementById("loginBtn").disabled = true;

      // If QR pending, use that code
      if (state.qrPending && state.qrPending.code) {
        code = state.qrPending.code;
      }

      // Validate email + code combo
      var url = API_URL + "?action=login&email=" + encodeURIComponent(email) + "&code=" + encodeURIComponent(code);
      
      fetch(url)
        .then(function(response) { return response.json(); })
        .then(function(data) {
          if (data.success) {
            // Login successful
            state.email = email;
            state.sheetId = data.sheetId;
            state.isLoggedIn = true;

            // Save to localStorage for auto-login
            localStorage.setItem("therack_email", email);
            localStorage.setItem("therack_sheet_id", data.sheetId);

            // Preserve QR animal for after load
            if (state.qrPending && state.qrPending.animal) {
              state.qrPending = { animal: state.qrPending.animal };
            }

            setStatus("Logged in! Loading your data...");
            updateUI();
            loadData();
          } else {
            setStatus(data.error || "Invalid email or access code", true);
          }
        })
        .catch(function(error) {
          setStatus("Error: " + error.message, true);
        })
        .finally(function() {
          document.getElementById("loginBtn").textContent = "Log In";
          document.getElementById("loginBtn").disabled = false;
        });
    }

    function handleSignOut() {
      state.isLoggedIn = false;
      state.email = "";
      state.sheetId = "";
      state.data = { collection: [], clutch: [], activity: [], archive: [] };
      state.headers = { collection: [], clutch: [], activity: [], archive: [] };

      localStorage.removeItem("therack_email");
      localStorage.removeItem("therack_sheet_id");

      document.getElementById("emailInput").value = "";
      document.getElementById("accessCodeInput").value = "";
      document.getElementById("mobileEmailInput").value = "";
      document.getElementById("mobileAccessCodeInput").value = "";

      updateUI();
      renderCurrentView();
      setStatus("Signed out. Enter your email and access code to log in.");
    }

    function updateUI() {
      var loginGroup = document.getElementById("loginGroup");
      var connectedGroup = document.getElementById("connectedGroup");
      var mobileLoginGroup = document.getElementById("mobileLoginGroup");
      var mobileSyncBtn = document.getElementById("mobileSyncBtn");
      var mobileUserInfo = document.getElementById("mobileUserInfo");

      if (state.isLoggedIn) {
        loginGroup.classList.add("hidden");
        connectedGroup.classList.remove("hidden");
        mobileLoginGroup.classList.add("hidden");
        mobileSyncBtn.classList.remove("hidden");
        mobileUserInfo.classList.remove("hidden");
        document.getElementById("userEmail").textContent = state.email;
        document.getElementById("mobileUserEmail").textContent = state.email;
      } else {
        loginGroup.classList.remove("hidden");
        connectedGroup.classList.add("hidden");
        mobileLoginGroup.classList.remove("hidden");
        mobileSyncBtn.classList.add("hidden");
        mobileUserInfo.classList.add("hidden");
      }
    }

    // ============ DATA LOADING ============
    function loadData() {
      if (!state.isLoggedIn) { 
        setStatus("Please log in first.", true); 
        return; 
      }

      state.isLoading = true;
      setStatus("Loading data... this may take a few seconds. No worries, we're just getting everything ready for the day!");

      apiCall('getData', {})
        .then(function(response) {
          if (response.success) {
            var data = response.data;
            
            state.headers = {
              collection: data.collection ? data.collection.headers : [],
              clutch: data.clutch ? data.clutch.headers : [],
              activity: data.activity ? data.activity.headers : [],
              archive: data.archive ? data.archive.headers : []
            };
            
            state.data = {
              collection: data.collection ? data.collection.rows : [],
              clutch: data.clutch ? data.clutch.rows : [],
              activity: data.activity ? data.activity.rows : [],
              archive: data.archive ? data.archive.rows : []
            };

            // Parse settings (key-value pairs)
            state.settings = {};
            if (data.settings && data.settings.rows) {
              data.settings.rows.forEach(function(row) {
                var field = row["FIELD"] || row["Field"] || "";
                var value = row["VALUE"] || row["Value"] || "";
                if (field) {
                  state.settings[field.toUpperCase()] = value;
                }
              });
            }

            // Count only non-empty rows for display
            var animalCount = state.data.collection.filter(function(r) {
              return (r.STATUS || "").trim() !== "" || (r["UNIQUE ID"] || "").trim() !== "";
            }).length;
            var clutchCount = state.data.clutch.filter(function(r) {
              return (r.STATUS || "").trim() !== "" || (r["CLUTCH ID"] || "").trim() !== "";
            }).length;
            var activityCount = state.data.activity.filter(function(r) {
              return (r.ACTIVITY || "").trim() !== "" || (r["UNIQUE ID"] || "").trim() !== "";
            }).length;

            setStatus("Loaded " + animalCount + " animals, " + 
                      clutchCount + " clutches, " + 
                      activityCount + " activities");
            
            // Update UI with settings
            updateUIWithSettings();
            renderCurrentView();
            
            // Check for pending QR action
            if (state.qrPending && state.qrPending.animal) {
              handleQRScan(state.qrPending.animal);
              state.qrPending = null;
            }
          } else {
            setStatus(response.error || "Failed to load data", true);
          }
        })
        .catch(function(error) {
          setStatus("Error loading data: " + error.message, true);
        })
        .finally(function() {
          state.isLoading = false;
        });
    }
    
    function updateUIWithSettings() {
      // Update business name in header if set
      var businessName = state.settings["BUSINESS NAME"];
      if (businessName) {
        var taglineEl = document.querySelector('.tagline-text');
        if (taglineEl) {
          taglineEl.textContent = businessName;
        }
      }
    }

    function setStatus(msg, isError) {
      var el = document.getElementById("statusText");
      el.textContent = msg;
      el.className = isError ? "text-red-600" : "text-slate-500";
    }

    // ============ QR CODE HANDLING ============
    function handleQRScan(animalId) {
      // Find the animal in collection
      var animal = state.data.collection.find(function(r) {
        return r["UNIQUE ID"] === animalId;
      });
      
      if (!animal) {
        setStatus("Animal " + animalId + " not found in your collection.", true);
        return;
      }
      
      // Open activity modal pre-filled for this animal
      openActivityForAnimal(animal);
    }

    function openActivityForAnimal(animal) {
      state.modalMode = "add";
      state.modalTab = "activity";
      state.editRowIndex = null;
      state.formData = {
        "DATE": new Date().toISOString().split('T')[0],
        "UNIQUE ID": animal["UNIQUE ID"]
      };
      
      renderActivityModalForQR(animal);
      document.getElementById("modal").classList.remove("hidden");
    }

    function renderActivityModalForQR(animal) {
      var animalName = animal["ANIMAL NAME"] || animal["UNIQUE ID"];
      var animalId = animal["UNIQUE ID"];
      
      document.getElementById("modalTitle").textContent = "Log Activity";
      
      var html = '<div class="space-y-4">';
      
      // Animal info banner
      html += '<div class="bg-gray-100 rounded-xl p-3 mb-4">';
      html += '<div class="font-bold text-gray-900">' + animalName + '</div>';
      html += '<div class="text-sm text-gray-500 mono">' + animalId + '</div>';
      html += '</div>';
      
      // Date (default today)
      html += '<div>';
      html += '<label class="block text-sm font-medium text-gray-700 mb-1">Date</label>';
      html += '<input type="date" id="field_DATE" value="' + state.formData["DATE"] + '" class="w-full px-3 py-2 border border-gray-300 rounded-xl">';
      html += '</div>';
      
      // Activity type - big buttons for quick tap
      html += '<div>';
      html += '<label class="block text-sm font-medium text-gray-700 mb-2">Activity</label>';
      html += '<div class="grid grid-cols-2 gap-2">';
      
      var quickActivities = ["Took Meal", "Refused Meal", "Shed", "Weight", "Note", "Health Hold"];
      quickActivities.forEach(function(act) {
        var selected = state.formData["ACTIVITY"] === act ? "bg-gray-900 text-white" : "bg-gray-100 text-gray-700 hover:bg-gray-200";
        html += '<button type="button" onclick="selectQRActivity(\'' + act + '\')" class="qr-activity-btn px-4 py-3 rounded-xl font-medium text-sm ' + selected + '">' + act + '</button>';
      });
      
      html += '</div>';
      html += '</div>';
      
      // Value field (for weight, notes, etc)
      html += '<div id="qrValueField" class="' + (state.formData["ACTIVITY"] === "Weight" || state.formData["ACTIVITY"] === "Note" ? "" : "hidden") + '">';
      html += '<label class="block text-sm font-medium text-gray-700 mb-1" id="qrValueLabel">Value</label>';
      html += '<input type="text" id="field_VALUE" value="' + (state.formData["VALUE"] || "") + '" class="w-full px-3 py-2 border border-gray-300 rounded-xl" placeholder="Enter value...">';
      html += '</div>';
      
      html += '</div>';
      
      document.getElementById("modalBody").innerHTML = html;
      
      // Update save button
      document.getElementById("saveRecordBtn").onclick = saveQRActivity;
    }

    function selectQRActivity(activity) {
      state.formData["ACTIVITY"] = activity;
      
      // Update button styles
      document.querySelectorAll('.qr-activity-btn').forEach(function(btn) {
        if (btn.textContent === activity) {
          btn.className = 'qr-activity-btn px-4 py-3 rounded-xl font-medium text-sm bg-gray-900 text-white';
        } else {
          btn.className = 'qr-activity-btn px-4 py-3 rounded-xl font-medium text-sm bg-gray-100 text-gray-700 hover:bg-gray-200';
        }
      });
      
      // Show/hide value field
      var valueField = document.getElementById('qrValueField');
      var valueLabel = document.getElementById('qrValueLabel');
      if (activity === "Weight") {
        valueField.classList.remove('hidden');
        valueLabel.textContent = "Weight (g)";
      } else if (activity === "Note" || activity === "Health Hold") {
        valueField.classList.remove('hidden');
        valueLabel.textContent = "Notes";
      } else {
        valueField.classList.add('hidden');
      }
    }

    function saveQRActivity() {
      var date = document.getElementById("field_DATE").value;
      var activity = state.formData["ACTIVITY"];
      var value = document.getElementById("field_VALUE") ? document.getElementById("field_VALUE").value : "";
      
      if (!activity) {
        setStatus("Please select an activity", true);
        return;
      }
      
      var record = {
        "DATE": date,
        "UNIQUE ID": state.formData["UNIQUE ID"],
        "ACTIVITY": activity,
        "VALUE": value
      };
      
      // Save to sheet
      setStatus("Saving...");
      document.getElementById("saveRecordBtn").disabled = true;
      
      apiCall('saveRecord', { tab: 'Activity', data: record })
        .then(function(response) {
          if (response.success) {
            // Add to local data
            record.__rowIndex = state.data.activity.length;
            state.data.activity.push(record);
            
            setStatus("Activity logged for " + state.formData["UNIQUE ID"]);
            closeModal();
            
            // Ask if they want to log another
            setTimeout(function() {
              if (confirm("Activity saved! Log another activity for this animal?")) {
                state.formData["ACTIVITY"] = "";
                state.formData["VALUE"] = "";
                var animal = state.data.collection.find(function(r) {
                  return r["UNIQUE ID"] === state.formData["UNIQUE ID"];
                });
                if (animal) openActivityForAnimal(animal);
              }
            }, 300);
          } else {
            setStatus(response.error || "Failed to save", true);
          }
        })
        .catch(function(error) {
          setStatus("Error: " + error.message, true);
        })
        .finally(function() {
          document.getElementById("saveRecordBtn").disabled = false;
        });
    }

    // ============ NAVIGATION ============
    var navHistory = [];

    function renderNavTabs() {
      var tabs = [
        { key: "dashboard", label: "Dashboard" },
        { key: "collection", label: "Collection" },
        { key: "clutches", label: "Incubator" },
        { key: "hatchlings", label: "Hatchlings" },
        { key: "sales", label: "Sales" },
        { key: "activity", label: "Activity" },
        { key: "archive", label: "Archive" }
      ];
      
      // Desktop nav
      var nav = document.getElementById("navTabs");
      nav.innerHTML = "";
      tabs.forEach(function(tab) {
        var btn = document.createElement("button");
        btn.textContent = tab.label;
        btn.className = "px-3 py-2 text-sm rounded-lg font-medium text-left " + 
          (state.activeTab === tab.key ? "bg-gray-900 text-white" : "text-gray-600 hover:bg-gray-100");
        btn.onclick = function() { navigateTo(tab.key); };
        nav.appendChild(btn);
      });

      // Mobile nav
      var mobileNav = document.getElementById("mobileNavTabs");
      mobileNav.innerHTML = "";
      tabs.forEach(function(tab) {
        var btn = document.createElement("button");
        btn.textContent = tab.label;
        btn.className = "px-3 py-2 text-sm rounded-lg font-medium text-left " + 
          (state.activeTab === tab.key ? "bg-gray-900 text-white" : "text-gray-600 hover:bg-gray-100");
        btn.onclick = function() { navigateTo(tab.key); toggleMobileMenu(); };
        mobileNav.appendChild(btn);
      });
    }

    function navigateTo(tab) {
      if (state.activeTab !== tab) {
        navHistory.push(state.activeTab);
        state.activeTab = tab;
        renderNavTabs();
        renderCurrentView();
      }
    }

    function goBack() {
      if (navHistory.length > 0) {
        state.activeTab = navHistory.pop();
        renderNavTabs();
        renderCurrentView();
      }
    }

    function renderCurrentView() {
      var titles = {
        dashboard: "Dashboard",
        collection: "Collection",
        clutches: "Incubator",
        hatchlings: "Hatchlings",
        sales: "Sales",
        activity: "Activity",
        archive: "Archive"
      };
      document.getElementById("pageTitle").textContent = titles[state.activeTab] || state.activeTab;
      var isDash = state.activeTab === "dashboard";
      var isArchive = state.activeTab === "archive";
      document.getElementById("dashboardView").classList.toggle("hidden", !isDash);
      document.getElementById("tableView").classList.toggle("hidden", isDash || isArchive);
      document.getElementById("addBtn").classList.toggle("hidden", isDash || isArchive);
      
      // Show/hide back button
      document.getElementById("backBtn").classList.toggle("hidden", navHistory.length === 0);
      
      if (isDash) renderDashboard();
      else if (isArchive) renderArchiveView();
      else renderTable();
    }

    // ============ DASHBOARD ============
    function renderDashboard() {
      var stats = calculateStats();
      var html = '';
      
      // Alerts Section (only show if there are alerts)
      var hasAlerts = stats.overdueClutches > 0 || stats.clutchesDueSoon > 0 || stats.unshipped > 0 || 
                      stats.needsSexing > 0 || stats.readyToList > 0 ||
                      stats.unpaidDeposits > 0 || stats.shippingSoon > 0;
      
      if (hasAlerts) {
        html += '<div class="mb-8">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-900 font-semibold mb-3">‚ö†Ô∏è Alerts</div>';
        html += '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">';
        
        // ü•ö Overdue Clutches (DARKEST - most urgent)
        if (stats.overdueClutches > 0) {
          html += '<div onclick="navigateTo(\'clutches\');" class="cursor-pointer bg-gradient-to-br from-gray-700 to-gray-800 border-2 border-gray-900 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-300">Overdue Clutches</div>';
          html += '<div class="text-2xl font-black text-white">' + stats.overdueClutches + '</div>';
          html += '</div>';
          html += '<div class="text-3xl">ü•ö</div>';
          html += '</div>';
          html += '</div>';
        }
        
        // ‚è∞ Clutches Due Soon (DARK)
        if (stats.clutchesDueSoon > 0) {
          html += '<div onclick="navigateTo(\'clutches\');" class="cursor-pointer bg-gradient-to-br from-gray-500 to-gray-600 border-2 border-gray-700 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-200">Due Within 7 Days</div>';
          html += '<div class="text-2xl font-black text-white">' + stats.clutchesDueSoon + '</div>';
          html += '</div>';
          html += '<div class="text-3xl">‚è∞</div>';
          html += '</div>';
          html += '</div>';
        }
        
        // üì¶ Unshipped Sales (MEDIUM-DARK)
        if (stats.unshipped > 0) {
          html += '<div onclick="navigateTo(\'sales\');" class="cursor-pointer bg-gradient-to-br from-gray-400 to-gray-500 border-2 border-gray-600 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-100">Unshipped Sales</div>';
          html += '<div class="text-2xl font-black text-white">' + stats.unshipped + '</div>';
          html += '</div>';
          html += '<div class="text-3xl">üì¶</div>';
          html += '</div>';
          html += '</div>';
        }
        
        // üìÖ Shipping Soon (MEDIUM)
        if (stats.shippingSoon > 0) {
          html += '<div onclick="navigateTo(\'sales\');" class="cursor-pointer bg-gradient-to-br from-gray-300 to-gray-400 border-2 border-gray-500 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-700">Shipping in 3 Days</div>';
          html += '<div class="text-2xl font-black text-gray-900">' + stats.shippingSoon + '</div>';
          html += '</div>';
          html += '<div class="text-3xl">üìÖ</div>';
          html += '</div>';
          html += '</div>';
        }
        
        // üíµ Unpaid Deposits (MEDIUM)
        if (stats.unpaidDeposits > 0) {
          html += '<div onclick="navigateTo(\'sales\');" class="cursor-pointer bg-gradient-to-br from-gray-300 to-gray-400 border-2 border-gray-500 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-700">Unpaid Deposits</div>';
          html += '<div class="text-2xl font-black text-gray-900">' + stats.unpaidDeposits + '</div>';
          html += '</div>';
          html += '<div class="text-3xl">üíµ</div>';
          html += '</div>';
          html += '</div>';
        }
        
        // ‚ùì Needs Sexing (LIGHT)
        if (stats.needsSexing > 0) {
          html += '<div onclick="navigateTo(\'hatchlings\');" class="cursor-pointer bg-gradient-to-br from-gray-200 to-gray-300 border-2 border-gray-400 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-600">Needs Sexing</div>';
          html += '<div class="text-2xl font-black text-gray-900">' + stats.needsSexing + '</div>';
          html += '</div>';
          html += '<div class="text-3xl">‚ùì</div>';
          html += '</div>';
          html += '</div>';
        }
        
        // üí∞ Ready to List (LIGHTEST)
        if (stats.readyToList > 0) {
          html += '<div onclick="navigateTo(\'hatchlings\');" class="cursor-pointer bg-gradient-to-br from-gray-100 to-gray-200 border-2 border-gray-300 rounded-2xl p-3 hover:shadow-lg transition-shadow">';
          html += '<div class="flex items-center justify-between">';
          html += '<div>';
          html += '<div class="text-xs uppercase tracking-wider text-gray-600">Ready to List</div>';
          html += '<div class="text-2xl font-black text-gray-900">' + stats.readyToList + '</div>';
          html += '</div>';
          html += '<div class="text-3xl">üí∞</div>';
          html += '</div>';
          html += '</div>';
        }
        
        html += '</div></div>';
      }
      
      // Breeders Section
      html += '<div class="mb-8"><div class="text-xs uppercase tracking-wider text-slate-500 font-semibold mb-3">Breeders</div>';
      html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
      html += statCard("Total Breeders", stats.totalBreeders, "slate", null, "state.activeTab=&#39;collection&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Males", stats.maleBreeders, "blue", Math.round(stats.malePct * 100) + "%", "state.activeTab=&#39;collection&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Females", stats.femaleBreeders, "pink", Math.round(stats.femalePct * 100) + "%", "state.activeTab=&#39;collection&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Holdbacks", stats.holdbacks, "amber", null, "state.activeTab=&#39;collection&#39;; renderNavTabs(); renderCurrentView();");
      html += '</div></div>';

      // Clutches Section
      html += '<div class="mb-8"><div class="text-xs uppercase tracking-wider text-slate-500 font-semibold mb-3">Clutches</div>';
      html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
      html += statCard("Incubating", stats.incubating, "green", null, "state.activeTab=&#39;clutches&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Hatched (Year)", stats.hatchedThisYear, "emerald", null, "state.activeTab=&#39;clutches&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Avg Days to Hatch", stats.avgDaysToHatch, "teal");
      html += statCard("Avg Fertile Eggs", stats.avgFertileEggs, "cyan");
      html += '</div></div>';

      // Hatchlings Section
      html += '<div class="mb-8"><div class="text-xs uppercase tracking-wider text-slate-500 font-semibold mb-3">Hatchlings</div>';
      html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
      html += statCard("Listed", stats.listed, "violet", null, "state.activeTab=&#39;hatchlings&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Unlisted", stats.unlisted, "slate", null, "state.activeTab=&#39;hatchlings&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Females", stats.hatchFemales, "pink", "Unknown: " + stats.hatchUnknown, "state.activeTab=&#39;hatchlings&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Males", stats.hatchMales, "blue", "Unknown: " + stats.hatchUnknown, "state.activeTab=&#39;hatchlings&#39;; renderNavTabs(); renderCurrentView();");
      html += '</div></div>';

      // Sales Section
      html += '<div class="mb-8"><div class="text-xs uppercase tracking-wider text-slate-500 font-semibold mb-3">Sales (This Year)</div>';
      html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
      html += statCard("Sold", stats.soldThisYear, "green", null, "state.activeTab=&#39;sales&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Revenue", stats.revenueDisplay, "emerald", null, "state.activeTab=&#39;sales&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("On Hold", stats.onHold, "orange", null, "state.activeTab=&#39;sales&#39;; renderNavTabs(); renderCurrentView();");
      html += statCard("Unshipped", stats.unshipped, "red", null, "state.activeTab=&#39;sales&#39;; renderNavTabs(); renderCurrentView();");
      html += '</div></div>';

      // Last Year Sales Section
      html += '<div class="mb-8"><div class="text-xs uppercase tracking-wider text-slate-400 font-semibold mb-3">Sales (Last Year)</div>';
      html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
      html += statCard("Sold", stats.soldLastYear, "slate", null, null);
      html += statCard("Revenue", stats.revenueLastYearDisplay, "slate", null, null);
      html += '</div></div>';

      document.getElementById("dashboardView").innerHTML = html;
    }

    function statCard(label, value, color, subtitle, onclick) {
      var colors = {
        slate: "from-gray-50 to-gray-100 text-gray-900",
        gray: "from-gray-50 to-gray-100 text-gray-900",
        charcoal: "from-gray-200 to-gray-300 text-gray-900",
        dark: "from-gray-300 to-gray-400 text-gray-900",
        blue: "from-gray-100 to-gray-200 text-gray-900",
        pink: "from-gray-100 to-gray-200 text-gray-900",
        amber: "from-gray-200 to-gray-300 text-gray-900",
        green: "from-gray-100 to-gray-200 text-gray-900",
        emerald: "from-gray-150 to-gray-250 text-gray-900",
        teal: "from-gray-100 to-gray-200 text-gray-900",
        cyan: "from-gray-50 to-gray-100 text-gray-900",
        violet: "from-gray-200 to-gray-300 text-gray-900",
        orange: "from-gray-150 to-gray-250 text-gray-900",
        red: "from-gray-300 to-gray-400 text-gray-900"
      };
      var sub = subtitle ? '<div class="text-xs opacity-60 mt-1">' + subtitle + '</div>' : '';
      var clickClass = onclick ? ' cursor-pointer hover:shadow-lg transition-shadow' : '';
      var clickAttr = onclick ? ' onclick="' + onclick + '"' : '';
      return '<div class="bg-gradient-to-br ' + colors[color] + ' rounded-2xl p-4 md:p-5 stat-card border border-gray-200' + clickClass + '"' + clickAttr + '>' +
             '<div class="text-xs uppercase tracking-wider opacity-70">' + label + '</div>' +
             '<div class="text-2xl md:text-4xl font-black mt-1">' + value + '</div>' + sub + '</div>';
    }

    function calculateStats() {
      // Filter out empty rows (rows without a STATUS or UNIQUE ID)
      var rows = state.data.collection.filter(function(r) {
        return (r.STATUS || "").trim() !== "" || (r["UNIQUE ID"] || "").trim() !== "";
      });
      var clutchRows = state.data.clutch.filter(function(r) {
        return (r.STATUS || "").trim() !== "" || (r["CLUTCH ID"] || "").trim() !== "";
      });
      var year = new Date().getFullYear();
      var today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Date for "due soon" (7 days from now)
      var sevenDaysOut = new Date(today);
      sevenDaysOut.setDate(sevenDaysOut.getDate() + 7);
      
      // Date for "ready to list" (30 days ago)
      var thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      // Date for "shipping soon" (3 days from now)
      var threeDaysOut = new Date(today);
      threeDaysOut.setDate(threeDaysOut.getDate() + 3);
      
      var s = {
        totalBreeders: 0, maleBreeders: 0, femaleBreeders: 0, holdbacks: 0,
        incubating: 0, hatchedThisYear: 0, avgDaysToHatch: "‚Äî", avgFertileEggs: "‚Äî",
        listed: 0, unlisted: 0, hatchMales: 0, hatchFemales: 0, hatchUnknown: 0,
        soldThisYear: 0, revenue: 0, revenueDisplay: "$0", onHold: 0, unshipped: 0,
        // Last year stats
        soldLastYear: 0, revenueLastYear: 0, revenueLastYearDisplay: "$0",
        malePct: 0, femalePct: 0,
        // Alerts
        overdueClutches: 0, 
        clutchesDueSoon: 0,
        needsSexing: 0,
        readyToList: 0,
        unpaidDeposits: 0,
        shippingSoon: 0
      };
      
      var lastYear = year - 1;

      rows.forEach(function(r) {
        var st = (r.STATUS || "").toLowerCase().trim();
        var sex = (r.SEX || "").toLowerCase().trim();
        var dob = parseDate(r["DATE OF BIRTH"]);
        var paymentStatus = (r["PAYMENT STATUS"] || "").toLowerCase().trim();
        var shipDate = parseDate(r["SHIP DATE"]);
        
        // Breeders
        if (st === "breeder" || st === "on loan") {
          s.totalBreeders++;
          if (sex.startsWith("m")) s.maleBreeders++;
          if (sex.startsWith("f")) s.femaleBreeders++;
        }
        if (st === "holdback") s.holdbacks++;
        
        // Hatchlings (listed/unlisted)
        if (st === "listed" || st === "for sale") {
          s.listed++;
          countSex(sex, s, "hatch");
        }
        if (st === "unlisted") {
          s.unlisted++;
          countSex(sex, s, "hatch");
          // Needs sexing (unlisted with unknown sex)
          if (!sex || sex === "unknown") s.needsSexing++;
          // Ready to list (unlisted, 30+ days old)
          if (dob && dob <= thirtyDaysAgo) s.readyToList++;
        }
        
        // Sales
        if (st === "on hold" || st === "hold") {
          s.onHold++;
          // Check for unpaid deposits
          if (paymentStatus === "deposit") s.unpaidDeposits++;
          // Check shipping soon
          if (shipDate && shipDate >= today && shipDate <= threeDaysOut) s.shippingSoon++;
        }
        if (st === "sold") {
          var soldDate = parseDate(r["DATE SOLD"]);
          var price = parseFloat(r["SOLD PRICE"]) || 0;
          if (soldDate && soldDate.getFullYear() === year) {
            s.soldThisYear++;
            s.revenue += price;
          }
          // Last year sales
          if (soldDate && soldDate.getFullYear() === lastYear) {
            s.soldLastYear++;
            s.revenueLastYear += price;
          }
          // Unshipped = ship date within next 7 days (or past due)
          if (shipDate && shipDate <= sevenDaysOut) {
            s.unshipped++;
          }
          // Check shipping soon for sold items too
          if (shipDate && shipDate >= today && shipDate <= threeDaysOut) s.shippingSoon++;
        }
      });

      // Breeder percentages
      if (s.totalBreeders > 0) {
        s.malePct = s.maleBreeders / s.totalBreeders;
        s.femalePct = s.femaleBreeders / s.totalBreeders;
      }

      // Clutch stats
      var daysSum = 0, daysCount = 0, fertileSum = 0, fertileCount = 0;
      clutchRows.forEach(function(r) {
        var st = (r.STATUS || "").toLowerCase().trim();
        if (st === "incubating") {
          s.incubating++;
          // Check if overdue or due soon
          var estHatchDate = r["EST. HATCH DATE"] || r["EST HATCH DATE"] || r["ESTIMATED HATCH DATE"] || "";
          if (estHatchDate) {
            var estDate = parseDate(estHatchDate);
            if (estDate) {
              if (estDate < today) {
                s.overdueClutches++;
              } else if (estDate >= today && estDate <= sevenDaysOut) {
                s.clutchesDueSoon++;
              }
            }
          }
        }
        if (st === "hatched") {
          var hatchDate = parseDate(r["HATCH DATE"]);
          if (hatchDate && hatchDate.getFullYear() === year) s.hatchedThisYear++;
          
          var layDate = parseDate(r["LAY DATE"]);
          if (hatchDate && layDate) {
            var days = Math.round((hatchDate - layDate) / 86400000);
            if (days > 0 && days < 100) { daysSum += days; daysCount++; }
          }
          
          var fertile = parseInt(r["# FERTILE"]) || 0;
          if (fertile > 0) { fertileSum += fertile; fertileCount++; }
        }
      });
      
      if (daysCount > 0) s.avgDaysToHatch = Math.round(daysSum / daysCount);
      if (fertileCount > 0) s.avgFertileEggs = Math.round(fertileSum / fertileCount);
      s.revenueDisplay = "$" + Math.round(s.revenue).toLocaleString();
      s.revenueLastYearDisplay = "$" + Math.round(s.revenueLastYear).toLocaleString();

      return s;
    }

    function countSex(sex, stats, prefix) {
      if (sex.startsWith("m")) stats[prefix + "Males"]++;
      else if (sex.startsWith("f")) stats[prefix + "Females"]++;
      else stats[prefix + "Unknown"]++;
    }

    function parseDate(v) {
      if (!v) return null;
      var d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }

    // ============ TABLE ============
    function renderTable() {
      var columns = getColumns();
      var rows = getFilteredRows();
      var showHatch = state.activeTab === "clutches";
      var showSale = state.activeTab === "hatchlings";

      // Render stats cards for this view
      renderTableStats();
      
      // Show/hide filter bar (only for collection-based views)
      var filterBar = document.getElementById("filterBar");
      var sheetKey = getSheetKey(state.activeTab);
      if (sheetKey === "collection" && state.activeTab !== "sales") {
        filterBar.classList.remove("hidden");
        populateSpeciesFilter();
      } else {
        filterBar.classList.add("hidden");
      }

      // Header
      var headerRow = document.getElementById("tableHead").querySelector("tr");
      headerRow.innerHTML = "";
      
      // Actions header FIRST
      var actionTh = document.createElement("th");
      actionTh.className = "px-3 py-3 text-left font-semibold text-slate-600 bg-slate-50 whitespace-nowrap text-sm sticky left-0 z-10";
      actionTh.textContent = "Actions";
      headerRow.appendChild(actionTh);
      
      columns.forEach(function(col) {
        var th = document.createElement("th");
        th.className = "px-3 py-3 text-left font-semibold text-slate-600 bg-slate-50 whitespace-nowrap text-sm";
        th.textContent = col;
        headerRow.appendChild(th);
      });

      // Body
      var tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      
      if (!rows.length) {
        var tr = document.createElement("tr");
        tr.innerHTML = '<td colspan="' + (columns.length + 1) + '" class="px-4 py-12 text-center text-slate-500">No data</td>';
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(function(row) {
        var tr = document.createElement("tr");
        tr.className = "hover:bg-slate-50";
        
        // Check if this clutch is overdue (for Incubator view)
        var isOverdue = false;
        if (state.activeTab === "clutches") {
          var estHatchDate = row["EST. HATCH DATE"] || row["EST HATCH DATE"] || row["ESTIMATED HATCH DATE"] || "";
          var status = (row.STATUS || "").toLowerCase();
          if (estHatchDate && status === "incubating") {
            var estDate = parseDate(estHatchDate);
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            if (estDate && estDate < today) {
              isOverdue = true;
              tr.className = "hover:bg-gray-200 bg-gray-200";
            }
          }
        }
        
        // Actions FIRST (sticky left)
        var actionTd = document.createElement("td");
        actionTd.className = "px-3 py-3 whitespace-nowrap bg-white sticky left-0 z-10 border-r border-gray-100";
        
        var editBtn = document.createElement("button");
        editBtn.className = "px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs hover:bg-slate-200 mr-1";
        editBtn.textContent = "Edit";
        editBtn.onclick = function() { openEditModal(row); };
        actionTd.appendChild(editBtn);

        if (showHatch) {
          var hatchBtn = document.createElement("button");
          hatchBtn.className = "px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300 mr-1";
          hatchBtn.textContent = "Hatch";
          hatchBtn.onclick = function() { openHatchModal(row); };
          actionTd.appendChild(hatchBtn);
        }

        if (showSale) {
          var saleBtn = document.createElement("button");
          saleBtn.className = "px-2 py-1 bg-gray-300 text-gray-800 rounded text-xs hover:bg-gray-400 mr-1";
          saleBtn.textContent = "Sell";
          saleBtn.onclick = function() { openSaleModal(row); };
          actionTd.appendChild(saleBtn);
          
          var holdbackBtn = document.createElement("button");
          holdbackBtn.className = "px-2 py-1 bg-gray-400 text-white rounded text-xs hover:bg-gray-500 mr-1";
          holdbackBtn.textContent = "+ Holdback";
          holdbackBtn.onclick = function() { markAsHoldback(row); };
          actionTd.appendChild(holdbackBtn);
        }

        // Delete button for all views (archives to Archive tab)
        // Map view to source tab name
        var tabMapping = {
          "collection": "Collection",
          "clutches": "Clutch",
          "hatchlings": "Collection",
          "sales": "Collection",
          "activity": "Activity"
        };
        var sourceTab = tabMapping[state.activeTab];
        if (sourceTab && state.activeTab !== "activity") {
          var archiveBtn = document.createElement("button");
          archiveBtn.className = "px-2 py-1 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200";
          archiveBtn.textContent = "Delete";
          archiveBtn.onclick = (function(rowIndex, tab) {
            return function() { archiveRecord(rowIndex, tab); };
          })(row.__rowIndex, sourceTab);
          actionTd.appendChild(archiveBtn);
        }

        tr.appendChild(actionTd);
        
        // Data columns
        columns.forEach(function(col, colIdx) {
          var td = document.createElement("td");
          td.className = "px-3 py-3 text-slate-700 whitespace-nowrap text-sm";
          
          // Special handling for QR column
          if (col === "QR") {
            var animalId = row["UNIQUE ID"] || row["MANUAL OVERRIDE"] || "";
            if (animalId) {
              var qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=50x50&data=" + encodeURIComponent("https://app.therackapp.io?code=" + state.sheetId + "&animal=" + animalId);
              td.innerHTML = '<img src="' + qrUrl + '" alt="QR" style="width:40px; height:40px; min-width:40px; min-height:40px;" />';
            } else {
              td.textContent = "‚Äî";
            }
          }
          // MATURITY - auto-calculated from DOB
          else if (col === "MATURITY") {
            var maturity = calculateMaturity(row["DATE OF BIRTH"]);
            td.innerHTML = '<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium">' + maturity + '</span>';
          }
          // STATUS - monochrome badge
          else if (col === "STATUS") {
            var status = row[col] || "‚Äî";
            td.innerHTML = '<span class="px-2 py-1 bg-gray-200 text-gray-800 rounded text-xs font-medium">' + escapeHtml(status) + '</span>';
          }
          // GENETIC SUMMARY - clickable gene tags
          else if (col === "GENETIC SUMMARY") {
            var genes = row[col] || "";
            if (genes) {
              td.className = "px-3 py-3 text-slate-700 text-sm";
              td.innerHTML = renderGeneTags(genes);
            } else {
              td.textContent = "‚Äî";
            }
          }
          // Add warning icon to first data column if overdue
          else if (colIdx === 1 && isOverdue) {
            td.innerHTML = '<span class="text-gray-900 mr-1" title="Overdue - past estimated hatch date">‚ö†Ô∏è</span>' + escapeHtml(row[col] || "‚Äî");
          } else {
            td.textContent = row[col] || "‚Äî";
          }
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }
    
    function calculateMaturity(dob) {
      if (!dob) return "UNK";
      var birthDate = parseDate(dob);
      if (!birthDate) return "UNK";
      
      var today = new Date();
      var months = (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
      
      if (months < 6) return "HTCH";
      if (months < 18) return "SUB";
      return "ADULT";
    }
    
    function renderGeneTags(genes) {
      if (!genes) return "‚Äî";
      
      // Split by common delimiters and clean up
      var geneList = genes.split(/[\s,]+/).filter(function(g) { 
        return g.trim().length > 0; 
      });
      
      // Group consecutive words that might be one gene (e.g., "desert ghost" -> "Desert Ghost")
      var parsedGenes = [];
      var hetBuffer = "";
      
      for (var i = 0; i < geneList.length; i++) {
        var gene = geneList[i].trim();
        if (!gene) continue;
        
        // Check for het/possible het patterns
        if (gene.toLowerCase() === "het" || gene.toLowerCase() === "poss" || gene.toLowerCase() === "100%") {
          hetBuffer = gene;
          continue;
        }
        
        // If we have a het buffer, combine with next gene
        if (hetBuffer) {
          parsedGenes.push(hetBuffer + " " + gene);
          hetBuffer = "";
        } else {
          parsedGenes.push(gene);
        }
      }
      
      // Render as clickable tags (max 5 shown, then "+X more")
      var maxShow = 5;
      var html = '<div class="flex flex-wrap gap-1">';
      
      for (var j = 0; j < Math.min(parsedGenes.length, maxShow); j++) {
        var g = parsedGenes[j];
        html += '<span class="px-2 py-0.5 bg-gray-100 border border-gray-300 text-gray-700 rounded-full text-xs cursor-pointer hover:bg-gray-200" onclick="filterByGene(\'' + escapeHtml(g).replace(/'/g, "\\'") + '\')">' + escapeHtml(g) + '</span>';
      }
      
      if (parsedGenes.length > maxShow) {
        html += '<span class="px-2 py-0.5 text-gray-500 text-xs">+' + (parsedGenes.length - maxShow) + ' more</span>';
      }
      
      html += '</div>';
      return html;
    }
    
    function filterByGene(gene) {
      state.filters.gene = gene;
      document.getElementById("geneFilterText").textContent = gene;
      document.getElementById("geneFilterDisplay").classList.remove("hidden");
      document.getElementById("clearFiltersBtn").classList.remove("hidden");
      renderTable();
    }
    
    function clearGeneFilter() {
      state.filters.gene = "";
      document.getElementById("geneFilterDisplay").classList.add("hidden");
      updateClearFiltersVisibility();
      renderTable();
    }
    
    function applyFilter(filterType, value) {
      state.filters[filterType] = value;
      updateClearFiltersVisibility();
      renderTable();
    }
    
    function clearAllFilters() {
      state.filters = { sex: "", status: "", species: "", gene: "" };
      document.getElementById("filterSex").value = "";
      document.getElementById("filterStatus").value = "";
      document.getElementById("filterSpecies").value = "";
      document.getElementById("geneFilterDisplay").classList.add("hidden");
      document.getElementById("clearFiltersBtn").classList.add("hidden");
      renderTable();
    }
    
    function updateClearFiltersVisibility() {
      var hasFilters = state.filters.sex || state.filters.status || state.filters.species || state.filters.gene;
      document.getElementById("clearFiltersBtn").classList.toggle("hidden", !hasFilters);
    }
    
    function populateSpeciesFilter() {
      var species = {};
      state.data.collection.forEach(function(r) {
        var sp = (r.SPECIES || "").trim();
        if (sp) species[sp] = true;
      });
      
      var select = document.getElementById("filterSpecies");
      select.innerHTML = '<option value="">All Species</option>';
      Object.keys(species).sort().forEach(function(sp) {
        select.innerHTML += '<option value="' + escapeHtml(sp) + '">' + escapeHtml(sp) + '</option>';
      });
    }

    function renderTableStats() {
      var statsView = document.getElementById("tableStatsView");
      var stats = calculateStats();
      var html = '';
      
      // Count on loan separately
      var onLoanCount = 0;
      state.data.collection.forEach(function(r) {
        if ((r.STATUS || "").toLowerCase().trim() === "on loan") onLoanCount++;
      });
      
      // Count clutch stats
      var hatchedCount = 0;
      var failedCount = 0;
      var totalEggs = 0;
      state.data.clutch.forEach(function(r) {
        var st = (r.STATUS || "").toLowerCase().trim();
        if (st === "hatched") hatchedCount++;
        if (st === "failed") failedCount++;
        var fertile = parseInt(r["# FERTILE"]) || 0;
        totalEggs += fertile;
      });
      
      if (state.activeTab === "collection") {
        html += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Breeders</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.totalBreeders + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Males</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.maleBreeders + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Females</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.femaleBreeders + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">On Loan</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + onLoanCount + '</div>';
        html += '</div>';
        html += '</div>';
        statsView.innerHTML = html;
        statsView.classList.remove("hidden");
        
      } else if (state.activeTab === "clutches") {
        html += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Incubating</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.incubating + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Hatched</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + hatchedCount + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Failed</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + failedCount + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Total Eggs</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + totalEggs + '</div>';
        html += '</div>';
        html += '</div>';
        statsView.innerHTML = html;
        statsView.classList.remove("hidden");
        
      } else if (state.activeTab === "hatchlings") {
        html += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">';
        html += '<div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-3 border border-green-200">';
        html += '<div class="text-xs uppercase tracking-wider text-green-600">Listed</div>';
        html += '<div class="text-2xl font-black text-green-700">' + stats.listed + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Unlisted</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.unlisted + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border border-gray-200">';
        html += '<div class="text-xs uppercase tracking-wider text-gray-500">Holdbacks</div>';
        html += '<div class="text-2xl font-black text-gray-900">' + stats.holdbacks + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-3 border border-orange-200">';
        html += '<div class="text-xs uppercase tracking-wider text-orange-600">On Hold</div>';
        html += '<div class="text-2xl font-black text-orange-700">' + stats.onHold + '</div>';
        html += '</div>';
        html += '</div>';
        statsView.innerHTML = html;
        statsView.classList.remove("hidden");
        
      } else if (state.activeTab === "sales") {
        var year = new Date().getFullYear();
        html += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">';
        html += '<div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-3 border border-green-200">';
        html += '<div class="text-xs uppercase tracking-wider text-green-600">Sold (' + year + ')</div>';
        html += '<div class="text-2xl font-black text-green-700">' + stats.soldThisYear + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl p-3 border border-emerald-200">';
        html += '<div class="text-xs uppercase tracking-wider text-emerald-600">Revenue</div>';
        html += '<div class="text-2xl font-black text-emerald-700">' + stats.revenueDisplay + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-3 border border-orange-200">';
        html += '<div class="text-xs uppercase tracking-wider text-orange-600">On Hold</div>';
        html += '<div class="text-2xl font-black text-orange-700">' + stats.onHold + '</div>';
        html += '</div>';
        html += '<div class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-3 border border-red-200">';
        html += '<div class="text-xs uppercase tracking-wider text-red-600">Unshipped</div>';
        html += '<div class="text-2xl font-black text-red-700">' + stats.unshipped + '</div>';
        html += '</div>';
        html += '</div>';
        statsView.innerHTML = html;
        statsView.classList.remove("hidden");
        
      } else {
        statsView.classList.add("hidden");
        statsView.innerHTML = '';
      }
    }

    function getColumns() {
      var prefs = {
        collection: ["QR", "UNIQUE ID", "ANIMAL NAME", "SEX", "MATURITY", "GENETIC SUMMARY", "STATUS"],
        clutches: ["CLUTCH ID", "SIRE", "DAM", "LAY DATE", "# FERTILE", "STATUS"],
        hatchlings: ["QR", "UNIQUE ID", "CLUTCH ID", "SEX", "MATURITY", "GENETIC SUMMARY", "STATUS", "LIST PRICE"],
        sales: ["UNIQUE ID", "ANIMAL NAME", "STATUS", "SOLD PRICE", "DATE SOLD", "BUYER NAME"],
        activity: ["DATE", "UNIQUE ID", "ACTIVITY", "VALUE"]
      };
      var h = state.headers[getSheetKey(state.activeTab)] || [];
      var wanted = prefs[state.activeTab] || [];
      // QR and MATURITY are virtual columns, don't filter them out
      var virtualCols = ["QR", "MATURITY"];
      var result = wanted.filter(function(w) { return virtualCols.indexOf(w) >= 0 || h.indexOf(w) >= 0; });
      return result.length ? result : h.slice(0, 6);
    }

    function getFilteredRows() {
      var sheetKey = getSheetKey(state.activeTab);
      var rows = state.data[sheetKey] || [];
      
      return rows.filter(function(r) {
        var st = (r.STATUS || "").toLowerCase().trim();
        
        // Tab-specific base filter
        var passesBaseFilter = true;
        if (state.activeTab === "collection") {
          passesBaseFilter = st === "breeder" || st === "collection" || st === "holdback" || st === "on loan";
        } else if (state.activeTab === "clutches") {
          passesBaseFilter = st !== "hatched";
        } else if (state.activeTab === "hatchlings") {
          passesBaseFilter = st === "listed" || st === "unlisted" || st === "for sale";
        } else if (state.activeTab === "sales") {
          passesBaseFilter = st === "on hold" || st === "hold" || st === "sold";
        }
        
        if (!passesBaseFilter) return false;
        
        // Apply user filters (only for collection-based views)
        if (sheetKey === "collection") {
          // Sex filter
          if (state.filters.sex && (r.SEX || "").toLowerCase() !== state.filters.sex.toLowerCase()) {
            return false;
          }
          
          // Status filter
          if (state.filters.status && st !== state.filters.status.toLowerCase()) {
            return false;
          }
          
          // Species filter
          if (state.filters.species && (r.SPECIES || "") !== state.filters.species) {
            return false;
          }
          
          // Gene filter
          if (state.filters.gene) {
            var genes = (r["GENETIC SUMMARY"] || "").toLowerCase();
            if (genes.indexOf(state.filters.gene.toLowerCase()) === -1) {
              return false;
            }
          }
        }
        
        return true;
      });
    }

    function getSheetKey(tab) {
      if (tab === "clutches") return "clutch";
      if (tab === "hatchlings" || tab === "sales" || tab === "collection") return "collection";
      if (tab === "activity") return "activity";
      return "collection";
    }

    // ============ ADD/EDIT MODAL ============
    function openAddModal(tab) {
      if (!state.isLoggedIn) { setStatus("Log in first", true); return; }
      
      var sheetKey = getSheetKey(tab);
      if (tab === "hatchling") sheetKey = "collection";
      if (tab === "clutch") sheetKey = "clutch";
      if (tab === "activity") sheetKey = "activity";
      
      state.modalMode = "add";
      state.modalTab = sheetKey;
      state.editRowIndex = null;
      state.formData = {};
      
      // Defaults
      var today = new Date().toISOString().split("T")[0];
      if (tab === "collection") {
        state.formData.STATUS = "Breeder";
        state.formData.SEX = "Female";
        state.formData.SPECIES = "Ball Python";
        state.formType = "breeder";
      } else if (tab === "hatchling") {
        state.formData.STATUS = "Unlisted";
        state.formData.SEX = "Unknown";
        state.formData.SPECIES = "Ball Python";
        state.formData["BREEDER SOURCE"] = "Produced In House";
        state.formData["DATE OF BIRTH"] = today;
        state.formType = "hatchling";
      } else if (tab === "clutch") {
        state.formData.STATUS = "Incubating";
        state.formData["LAY DATE"] = today;
        state.formData.SEASON = String(new Date().getFullYear());
        state.formType = "clutch";
      } else if (tab === "activity") {
        state.formData.DATE = today;
        state.formData.ACTIVITY = "Note";
        state.formType = "activity";
      }

      var title = tab === "hatchling" ? "Hatchling" : (tab === "collection" ? "Breeder" : sheetKey.charAt(0).toUpperCase() + sheetKey.slice(1));
      document.getElementById("modalTitle").textContent = "Add " + title;
      
      // Show ID preview for new records (except Activity - that uses a lookup)
      var idDisplay = document.getElementById("modalIdDisplay");
      var idValue = document.getElementById("modalIdValue");
      
      if (tab === "hatchling") {
        idDisplay.classList.remove("hidden");
        idValue.textContent = generateHatchlingId();
      } else if (tab === "clutch") {
        idDisplay.classList.remove("hidden");
        idValue.textContent = generateClutchId(today);
      } else if (tab === "collection") {
        idDisplay.classList.remove("hidden");
        idValue.textContent = generateBreederId();
      } else {
        // Activity and others don't show the ID box
        idDisplay.classList.add("hidden");
      }

      renderModalForm(tab);
      document.getElementById("modal").classList.remove("hidden");
    }

    function openEditModal(row) {
      if (!state.isLoggedIn) { setStatus("Log in first", true); return; }
      
      // Map view tab to actual sheet tab
      var sheetKey = getSheetKey(state.activeTab);
      state.modalMode = "edit";
      state.modalTab = sheetKey;
      state.editRowIndex = row.__rowIndex;
      state.formData = Object.assign({}, row);
      state.formType = null; // Clear formType for edit mode

      document.getElementById("modalTitle").textContent = "Edit Record";
      
      // Show existing ID
      var idDisplay = document.getElementById("modalIdDisplay");
      var idValue = document.getElementById("modalIdValue");
      var uid = row["UNIQUE ID"] || row["CLUTCH ID"] || "";
      if (uid) {
        idDisplay.classList.remove("hidden");
        idValue.textContent = uid;
      } else {
        idDisplay.classList.add("hidden");
      }

      renderModalForm(sheetKey);
      document.getElementById("modal").classList.remove("hidden");
    }

    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
      document.getElementById("modalError").textContent = "";
    }

    function renderModalForm(tab) {
      var headers = state.headers[state.modalTab] || [];
      
      // Fallback headers for activity if none loaded
      if (state.modalTab === "activity" && headers.length === 0) {
        headers = ["DATE", "UNIQUE ID", "ACTIVITY", "VALUE", "SOLD DATE", "SOLD PRICE", "BUYER NAME", "BUYER EMAIL", "SALE SOURCE", "PAYMENT STATUS", "SHIP DATE", "SHIPPING FEE", "PAIRED WITH"];
      }
      
      // Fallback headers for collection if none loaded
      if (state.modalTab === "collection" && headers.length === 0) {
        headers = ["ANIMAL NAME", "SEX", "DATE OF BIRTH", "SPECIES", "GENETIC SUMMARY", "STATUS", "WT PURCHASE (G)", "PURCHASE PRICE", "BREEDER SOURCE", "MANUAL OVERRIDE", "NOTES", "CLUTCH ID", "SIRE", "DAM", "HATCH WEIGHT (G)", "HATCH DATE", "LIST PRICE", "SOLD PRICE", "DATE SOLD", "BUYER NAME", "BUYER EMAIL"];
      }
      
      // Fallback headers for clutch if none loaded
      if (state.modalTab === "clutch" && headers.length === 0) {
        headers = ["CLUTCH ID", "SIRE", "DAM", "LAY DATE", "# EGGS", "# FERTILE", "# SLUGS", "STATUS", "NOTES"];
      }
      
      // Skip UNIQUE ID and CLUTCH ID except for activity form where we need UNIQUE ID
      var skipFields = ["__rowIndex", "__raw"];
      if (state.modalTab !== "activity") {
        skipFields.push("UNIQUE ID");
        skipFields.push("CLUTCH ID");
      }
      
      // Fields to skip for clutch ADD form (these are set via Hatch modal)
      var clutchHatchFields = ["DAYS TO HATCH", "DAYS TIL HATCH", "DAYS TILL HATCH", "# HATCHED", "HATCH DATE", "EST. HATCH DATE", "EST HATCH DATE", "ESTIMATED HATCH DATE", "DAYS (LAY", "MANUAL ID"];
      
      // Fields to skip for breeder ADD form (hatchling/sale specific fields)
      var breederSkipFields = ["HATCH WEIGHT", "HATCH DATE", "LIST PRICE", "BUYER ADDRESS", "MANUAL ID", "MANUAL OVERRIDE", "CLUTCH ID", "DATE SOLD", "SOLD PRICE", "BUYER NAME", "BUYER EMAIL", "SHIP DATE", "TOTAL PAID", "SHIPPING FEE", "SALE SOURCE", "PAYMENT STATUS", "SIRE", "DAM"];
      
      // Fields to skip for hatchling ADD form
      var hatchlingSkipFields = ["ANIMAL NAME", "LIST PRICE", "BUYER ADDRESS", "DATE SOLD", "SOLD PRICE", "BUYER NAME", "BUYER EMAIL", "SHIP DATE", "TOTAL PAID", "SHIPPING FEE", "SALE SOURCE", "PAYMENT STATUS"];
      
      // Fields to show at the end for hatchling form
      var hatchlingEndFields = ["MANUAL OVERRIDE", "NOTES"];
      
      // Fields that are read-only on hatchling form (auto-filled from clutch)
      var hatchlingReadOnlyFields = ["SIRE", "DAM"];
      
      // Activity form - conditional fields based on ACTIVITY type
      var activityType = (state.formData.ACTIVITY || "").toLowerCase();
      var isSaleActivity = (activityType === "sold");
      var isPairingActivity = (activityType === "paired" || activityType === "lock");
      
      // Fields only shown for specific activities
      var activitySaleFields = ["SOLD DATE", "SOLD PRICE", "BUYER NAME", "BUYER EMAIL", "SALE SOURCE", "PAYMENT STATUS", "SHIP DATE", "SHIPPING FEE"];
      var activityPairingFields = ["PAIRED WITH"];
      
      // Determine which fields to show based on STATUS
      var status = (state.formData.STATUS || "").toLowerCase();
      var showSaleFields = (status === "on hold" || status === "sold");
      var saleFields = ["SOLD PRICE", "DATE SOLD", "BUYER NAME", "BUYER EMAIL", "SHIP DATE", "TOTAL PAID", "SHIPPING FEE"];
      
      // Check if this is a hatchling form - ONLY for hatchling, not clutch or anything else
      var isHatchlingForm = (state.formType === "hatchling" && state.modalMode === "add" && state.modalTab === "collection");

      var html = '';
      
      // Show estimated hatch date preview for clutch form
      if ((tab === "clutch" || state.modalTab === "clutch") && state.formData["LAY DATE"]) {
        var estHatch = calculateEstHatchDate(state.formData["LAY DATE"]);
        html += '<div class="mb-4 bg-gray-100 border border-gray-300 rounded-xl px-4 py-3">';
        html += '<div class="text-xs text-gray-600 uppercase font-semibold">Estimated Hatch Date (Lay Date + 59 days)</div>';
        html += '<div class="font-bold text-gray-800 text-lg">' + estHatch + '</div>';
        html += '</div>';
      }
      
      // Special rendering for hatchling form ONLY
      if (isHatchlingForm) {
        html += renderHatchlingForm(headers);
        document.getElementById("modalBody").innerHTML = html;
        return;
      }
      
      html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
      
      headers.forEach(function(h) {
        if (skipFields.indexOf(h) >= 0) return;
        if (h.includes("(RESERVED)")) return;
        
        // Collection form - hide sale fields unless status is on hold/sold
        if (state.modalTab === "collection" && saleFields.indexOf(h) >= 0 && !showSaleFields) return;
        
        // Skip hatchling/sale fields on breeder ADD form (status = Breeder)
        if (state.modalTab === "collection" && state.modalMode === "add") {
          var formStatus = (state.formData.STATUS || "").toLowerCase();
          if (formStatus === "breeder" || state.formType === "breeder") {
            var hUpper = h.toUpperCase();
            for (var i = 0; i < breederSkipFields.length; i++) {
              if (hUpper === breederSkipFields[i] || hUpper.indexOf(breederSkipFields[i]) >= 0) return;
            }
          }
        }
        
        // Skip hatch-related fields on clutch ADD form
        if (state.modalTab === "clutch" && state.modalMode === "add") {
          var hUpper = h.toUpperCase();
          for (var i = 0; i < clutchHatchFields.length; i++) {
            if (hUpper === clutchHatchFields[i] || hUpper.includes(clutchHatchFields[i])) return;
          }
        }
        
        // Activity form conditional fields
        if (state.modalTab === "activity") {
          // Skip sale fields unless activity is "Sold"
          if (activitySaleFields.indexOf(h) >= 0 && !isSaleActivity) return;
          // Skip pairing fields unless activity is "Paired" or "Lock"
          if (activityPairingFields.indexOf(h) >= 0 && !isPairingActivity) return;
          // Skip VALUE field if it's a sale (sale data goes in specific fields)
          if (h === "VALUE" && isSaleActivity) return;
        }
        
        var val = state.formData[h] || "";
        var input = "";
        var opts = getFieldOptions(h, state.modalTab);
        
        if (opts && opts.length > 0) {
          input = '<select onchange="updateFormField(\'' + h + '\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
          input += '<option value="">Select...</option>';
          opts.forEach(function(o) {
            var sel = (val && (val === o || val.toLowerCase() === o.toLowerCase())) ? " selected" : "";
            input += '<option value="' + escapeHtml(o) + '"' + sel + '>' + escapeHtml(o) + '</option>';
          });
          input += '</select>';
        } else if (Array.isArray(opts) && opts.length === 0) {
          // Empty dropdown - show text input with placeholder
          var placeholder = "";
          if (h.toUpperCase() === "DAM") placeholder = "No female breeders found";
          if (h.toUpperCase() === "SIRE") placeholder = "No male breeders found";
          if (h.toUpperCase() === "PAIRED WITH") placeholder = "No animals found";
          if (h.toUpperCase() === "UNIQUE ID") placeholder = "No animals found - load data first";
          input = '<input type="text" value="' + escapeHtml(val) + '" onchange="updateFormField(\'' + h + '\', this.value)" placeholder="' + placeholder + '" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
        } else if (h.toUpperCase().includes("DATE")) {
          var isRequired = (h.toUpperCase() === "DATE OF BIRTH" && state.formType === "breeder");
          var requiredAttr = isRequired ? ' required' : '';
          input = '<input type="date" value="' + val + '" onchange="updateFormField(\'' + h + '\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 mono text-sm"' + requiredAttr + '>';
        } else if (h.toUpperCase().includes("PRICE") || h.toUpperCase().includes("WEIGHT") || h.toUpperCase().includes("FEE") || h.startsWith("#")) {
          input = '<input type="number" step="any" value="' + val + '" onchange="updateFormField(\'' + h + '\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 mono text-sm">';
        } else if (h.toUpperCase().includes("NOTES")) {
          input = '<textarea onchange="updateFormField(\'' + h + '\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm" rows="2">' + escapeHtml(val) + '</textarea>';
        } else if (h.toUpperCase().includes("EMAIL")) {
          input = '<input type="email" value="' + escapeHtml(val) + '" onchange="updateFormField(\'' + h + '\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
        } else {
          input = '<input type="text" value="' + escapeHtml(val) + '" onchange="updateFormField(\'' + h + '\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
        }

        // UI-friendly label overrides
        var displayLabel = h;
        if (h.toUpperCase() === "MANUAL OVERRIDE") {
          displayLabel = "Custom Unique ID (optional)";
        }
        
        // Add required indicator for certain fields
        var requiredMark = '';
        if (h.toUpperCase() === "DATE OF BIRTH" && state.formType === "breeder") {
          requiredMark = ' <span class="text-red-500">*</span>';
        }

        html += '<div><label class="block text-xs font-semibold text-slate-600 uppercase mb-1">' + displayLabel + requiredMark + '</label>' + input + '</div>';
      });

      html += '</div>';
      document.getElementById("modalBody").innerHTML = html;
    }

    function calculateEstHatchDate(layDateStr) {
      if (!layDateStr) return "‚Äî";
      var d = parseDate(layDateStr);
      if (!d) return "‚Äî";
      d.setDate(d.getDate() + 59);
      return d.toISOString().split("T")[0];
    }
    
    function renderHatchlingForm(headers) {
      var html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
      
      // 1. CLUTCH ID dropdown (first - required)
      var clutchOpts = getClutchOptions() || [];
      var clutchVal = state.formData["CLUTCH ID"] || "";
      html += '<div class="md:col-span-2">';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Clutch ID <span class="text-red-500">*</span></label>';
      html += '<select onchange="updateHatchlingClutch(this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
      html += '<option value="">Select Clutch...</option>';
      clutchOpts.forEach(function(o) {
        var sel = (clutchVal === o) ? " selected" : "";
        html += '<option value="' + escapeHtml(o) + '"' + sel + '>' + escapeHtml(o) + '</option>';
      });
      html += '</select>';
      html += '</div>';
      
      // 2. DAM and SIRE (read-only, auto-filled from clutch)
      var damVal = state.formData["DAM"] || "";
      var sireVal = state.formData["SIRE"] || "";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Dam (from clutch)</label>';
      html += '<div class="w-full px-3 py-2 rounded-xl border border-slate-100 bg-slate-100 text-sm text-slate-600">' + (damVal || "‚Äî") + '</div>';
      html += '</div>';
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Sire (from clutch)</label>';
      html += '<div class="w-full px-3 py-2 rounded-xl border border-slate-100 bg-slate-100 text-sm text-slate-600">' + (sireVal || "‚Äî") + '</div>';
      html += '</div>';
      
      // 3. DATE OF BIRTH (required) - displays as "Hatch Date" but saves to DATE OF BIRTH column
      var dobVal = state.formData["DATE OF BIRTH"] || "";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Hatch Date <span class="text-red-500">*</span></label>';
      html += '<input type="date" value="' + dobVal + '" onchange="updateFormField(\'DATE OF BIRTH\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 mono text-sm" required>';
      html += '</div>';
      
      // 4. SEX
      var sexVal = state.formData["SEX"] || "Unknown";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Sex</label>';
      html += '<select onchange="updateFormField(\'SEX\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
      ["Unknown", "Female", "Male"].forEach(function(o) {
        var sel = (sexVal === o) ? " selected" : "";
        html += '<option value="' + o + '"' + sel + '>' + o + '</option>';
      });
      html += '</select>';
      html += '</div>';
      
      // 5. STATUS
      var statusVal = state.formData["STATUS"] || "Unlisted";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Status</label>';
      html += '<select onchange="updateFormField(\'STATUS\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
      ["Unlisted", "Listed", "Holdback"].forEach(function(o) {
        var sel = (statusVal === o) ? " selected" : "";
        html += '<option value="' + o + '"' + sel + '>' + o + '</option>';
      });
      html += '</select>';
      html += '</div>';
      
      // 6. HATCH WEIGHT
      if (headers.indexOf("HATCH WEIGHT (G)") >= 0) {
        var weightVal = state.formData["HATCH WEIGHT (G)"] || "";
        html += '<div>';
        html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Hatch Weight (g)</label>';
        html += '<input type="number" step="any" value="' + weightVal + '" onchange="updateFormField(\'HATCH WEIGHT (G)\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 mono text-sm">';
        html += '</div>';
      }
      
      // 7. SPECIES
      var speciesVal = state.formData["SPECIES"] || "Ball Python";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Species</label>';
      html += '<input type="text" value="' + escapeHtml(speciesVal) + '" onchange="updateFormField(\'SPECIES\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
      html += '</div>';
      
      // 8. GENETIC SUMMARY
      var geneticsVal = state.formData["GENETIC SUMMARY"] || "";
      html += '<div class="md:col-span-2">';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Genetic Summary</label>';
      html += '<input type="text" value="' + escapeHtml(geneticsVal) + '" onchange="updateFormField(\'GENETIC SUMMARY\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm" placeholder="e.g. Pastel Het Clown">';
      html += '</div>';
      
      // 9. BREEDER SOURCE
      var sourceVal = state.formData["BREEDER SOURCE"] || "Produced In House";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Breeder Source</label>';
      html += '<input type="text" value="' + escapeHtml(sourceVal) + '" onchange="updateFormField(\'BREEDER SOURCE\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
      html += '</div>';
      
      // Empty spacer for alignment
      html += '<div></div>';
      
      // 10. Custom Unique ID (optional) - at end
      var manualVal = state.formData["MANUAL OVERRIDE"] || "";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Custom Unique ID (optional)</label>';
      html += '<input type="text" value="' + escapeHtml(manualVal) + '" onchange="updateFormField(\'MANUAL OVERRIDE\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm" placeholder="Your own ID system">';
      html += '</div>';
      
      // 11. NOTES - at end
      var notesVal = state.formData["NOTES"] || "";
      html += '<div>';
      html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Notes</label>';
      html += '<textarea onchange="updateFormField(\'NOTES\', this.value)" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm" rows="2">' + escapeHtml(notesVal) + '</textarea>';
      html += '</div>';
      
      html += '</div>';
      return html;
    }
    
    function updateHatchlingClutch(clutchId) {
      state.formData["CLUTCH ID"] = clutchId;
      
      // Look up the clutch to get DAM and SIRE
      var clutchRows = state.data.clutch || [];
      var found = null;
      for (var i = 0; i < clutchRows.length; i++) {
        if (clutchRows[i]["CLUTCH ID"] === clutchId) {
          found = clutchRows[i];
          break;
        }
      }
      
      if (found) {
        state.formData["DAM"] = found["DAM"] || "";
        state.formData["SIRE"] = found["SIRE"] || "";
      } else {
        state.formData["DAM"] = "";
        state.formData["SIRE"] = "";
      }
      
      // Re-render the form
      renderModalForm("hatchling");
    }

    function getFieldOptions(field, sheetKey) {
      var f = field.toUpperCase();
      if (f === "SEX") return FIELD_OPTIONS.SEX;
      if (f === "STATUS" && sheetKey === "clutch") return FIELD_OPTIONS.CLUTCH_STATUS;
      if (f === "STATUS") return FIELD_OPTIONS.STATUS;
      if (f === "ACTIVITY") return FIELD_OPTIONS.ACTIVITY;
      if (f === "SALE SOURCE") return FIELD_OPTIONS.SALE_SOURCE;
      if (f === "PAYMENT STATUS") return FIELD_OPTIONS.PAYMENT_STATUS;
      
      // DAM/SIRE dropdowns
      if (f === "DAM") return getBreederOptions("Female");
      if (f === "SIRE") return getBreederOptions("Male");
      if (f === "CLUTCH ID" && sheetKey === "collection") return getClutchOptions();
      
      // Activity form - UNIQUE ID dropdown (all animals)
      if (f === "UNIQUE ID" && sheetKey === "activity") return getAllAnimalOptions();
      // Activity form - PAIRED WITH dropdown (for pairing/lock activities)
      if (f === "PAIRED WITH") return getAllAnimalOptions();
      
      return null;
    }

    function getAllAnimalOptions() {
      var rows = state.data.collection || [];
      var opts = [];
      rows.forEach(function(r) {
        var id = r["UNIQUE ID"] || "";
        var name = r["ANIMAL NAME"] || "";
        if (id) {
          var label = name ? name + " | " + id : id;
          opts.push(label);
        }
      });
      return opts;
    }

    function getBreederOptions(sex) {
      var rows = state.data.collection || [];
      var opts = [];
      rows.forEach(function(r) {
        var st = (r.STATUS || "").toLowerCase();
        // Only include breeders and holdbacks as potential parents
        if (st !== "breeder" && st !== "holdback") return;
        var s = (r.SEX || "").toLowerCase();
        if (sex === "Female" && !s.startsWith("f")) return;
        if (sex === "Male" && !s.startsWith("m")) return;
        var id = r["UNIQUE ID"] || "";
        var name = r["ANIMAL NAME"] || "";
        if (id || name) {
          var label = name ? (id ? name + " | " + id : name) : id;
          opts.push(label);
        }
      });
      // Always return array so it shows as dropdown, even if empty
      return opts;
    }

    function getClutchOptions() {
      var rows = state.data.clutch || [];
      var opts = [];
      rows.forEach(function(r) {
        var id = r["CLUTCH ID"];
        var status = (r["STATUS"] || "").toLowerCase();
        // Only show clutches that are NOT hatched
        if (id && status !== "hatched") {
          opts.push(id);
        }
      });
      return opts.length ? opts : null;
    }

    function updateFormField(field, value) {
      state.formData[field] = value;
      
      // Re-render if STATUS changed (to show/hide sale fields)
      if (field === "STATUS") {
        renderModalForm(state.activeTab);
      }
      
      // Re-render if ACTIVITY changed (to show/hide conditional fields)
      if (field === "ACTIVITY") {
        renderModalForm(state.activeTab);
      }
      
      // Re-render if LAY DATE changed (to update estimated hatch date)
      if (field === "LAY DATE" && state.modalTab === "clutch") {
        renderModalForm(state.activeTab);
        // Also update CLUTCH ID preview if in add mode
        if (state.modalMode === "add") {
          document.getElementById("modalIdValue").textContent = generateClutchId(value);
        }
      }
    }

    function escapeHtml(s) {
      return String(s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    function generateHatchlingId() {
      var year = new Date().getFullYear();
      var rows = state.data.collection || [];
      var max = 0;
      var re = /^H-(\d{4})-(\d{4})$/i;
      rows.forEach(function(r) {
        var id = r["UNIQUE ID"] || r["MANUAL OVERRIDE"] || "";
        var m = re.exec(id);
        if (m && m[1] === String(year)) {
          var n = parseInt(m[2], 10);
          if (n > max) max = n;
        }
      });
      return "H-" + year + "-" + String(max + 1).padStart(4, "0");
    }

    function generateBreederId() {
      var year = new Date().getFullYear();
      var rows = state.data.collection || [];
      var max = 0;
      var re = /^B-(\d{4})-(\d{4})$/i;
      rows.forEach(function(r) {
        var id = r["UNIQUE ID"] || r["MANUAL OVERRIDE"] || "";
        var m = re.exec(id);
        if (m && m[1] === String(year)) {
          var n = parseInt(m[2], 10);
          if (n > max) max = n;
        }
      });
      return "B-" + year + "-" + String(max + 1).padStart(4, "0");
    }

    function generateActivityId() {
      var year = new Date().getFullYear();
      var rows = state.data.activity || [];
      var max = 0;
      var re = /^A-(\d{4})-(\d{4})$/i;
      rows.forEach(function(r) {
        var id = r["ACTIVITY ID"] || "";
        var m = re.exec(id);
        if (m && m[1] === String(year)) {
          var n = parseInt(m[2], 10);
          if (n > max) max = n;
        }
      });
      return "A-" + year + "-" + String(max + 1).padStart(4, "0");
    }

    function generateClutchId(layDate) {
      var d = parseDate(layDate);
      var year = d ? d.getFullYear() : new Date().getFullYear();
      var rows = state.data.clutch || [];
      var count = 0;
      rows.forEach(function(r) {
        var ld = parseDate(r["LAY DATE"]);
        if (ld && ld.getFullYear() === year) count++;
      });
      return "CL-" + year + "-" + String(count + 1).padStart(4, "0");
    }

    function saveRecord() {
      var headers = state.headers[state.modalTab] || [];
      if (!headers.length) { document.getElementById("modalError").textContent = "No headers"; return; }

      // Auto-calculate EST. HATCH DATE for clutches
      if (state.modalTab === "clutch" && state.formData["LAY DATE"]) {
        var estHatchIdx = -1;
        for (var i = 0; i < headers.length; i++) {
          var hUpper = headers[i].toUpperCase();
          if (hUpper === "EST. HATCH DATE" || hUpper === "EST HATCH DATE" || hUpper === "ESTIMATED HATCH DATE") {
            estHatchIdx = i;
            break;
          }
        }
        if (estHatchIdx >= 0) {
          state.formData[headers[estHatchIdx]] = calculateEstHatchDate(state.formData["LAY DATE"]);
        }
      }

      var sheetName = SHEET_TABS[state.modalTab];
      var savedTab = state.modalTab;
      var savedFormData = Object.assign({}, state.formData);
      var isAdd = state.modalMode === "add";

      document.getElementById("saveBtn").textContent = "Saving...";
      document.getElementById("saveBtn").disabled = true;

      var promise;
      if (isAdd) {
        promise = apiCall('saveRecord', {
          tab: sheetName,
          data: state.formData
        });
      } else {
        promise = apiCall('updateRecord', {
          tab: sheetName,
          rowIndex: state.editRowIndex,
          data: state.formData
        });
      }

      promise.then(function(response) {
        if (response.success) {
          // Optimistic UI: Add to local data immediately
          if (isAdd) {
            var newRow = Object.assign({ __rowIndex: state.data[savedTab].length }, savedFormData);
            state.data[savedTab].push(newRow);
          }
          
          setStatus("Saved! ‚úì");
          closeModal();
          renderCurrentView(); // Render immediately with local data
          
          // Then refresh from server in background
          loadDataQuietly();
        } else {
          document.getElementById("modalError").textContent = response.error || "Save failed";
        }
      }).catch(function(e) {
        document.getElementById("modalError").textContent = e.message || "Save failed";
      }).finally(function() {
        document.getElementById("saveBtn").textContent = "Save";
        document.getElementById("saveBtn").disabled = false;
      });
    }
    
    // Silent data refresh (no loading message)
    function loadDataQuietly() {
      apiCall('getData', {})
        .then(function(response) {
          if (response.success) {
            var data = response.data;
            state.headers = {
              collection: data.collection ? data.collection.headers : [],
              clutch: data.clutch ? data.clutch.headers : [],
              activity: data.activity ? data.activity.headers : []
            };
            state.data = {
              collection: data.collection ? data.collection.rows : [],
              clutch: data.clutch ? data.clutch.rows : [],
              activity: data.activity ? data.activity.rows : []
            };
            renderCurrentView();
          }
        })
        .catch(function() {
          // Silently fail - we already have optimistic data
        });
    }

    function colLetter(n) {
      var s = "";
      n++;
      while (n > 0) {
        var m = (n - 1) % 26;
        s = String.fromCharCode(65 + m) + s;
        n = Math.floor((n - 1) / 26);
      }
      return s;
    }

    // ============ HATCH MODAL ============
    function openHatchModal(clutchRow) {
      state.hatchClutchRow = clutchRow;
      state.hatchDate = new Date().toISOString().split("T")[0];
      state.hatchCount = 1;
      state.hatchDrafts = [];

      var clutchId = clutchRow["CLUTCH ID"] || "Unknown";
      document.getElementById("hatchClutchId").textContent = "Clutch: " + clutchId;

      var html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">';
      html += '<div><label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Hatch Date</label>';
      html += '<input type="date" id="hatchDateInput" value="' + state.hatchDate + '" onchange="state.hatchDate=this.value" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 mono"></div>';
      html += '<div><label class="block text-xs font-semibold text-slate-600 uppercase mb-1"># of Hatchlings</label>';
      html += '<input type="number" id="hatchCountInput" value="1" min="1" max="20" onchange="state.hatchCount=parseInt(this.value)||1" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50"></div>';
      html += '</div>';
      html += '<div id="hatchDraftsArea"></div>';

      document.getElementById("hatchModalBody").innerHTML = html;
      document.getElementById("hatchModal").classList.remove("hidden");
    }

    function closeHatchModal() {
      document.getElementById("hatchModal").classList.add("hidden");
      document.getElementById("hatchModalError").textContent = "";
      state.hatchClutchRow = null;
      state.hatchDrafts = [];
    }

    function markHatchedOnly() {
      if (!state.hatchClutchRow) return;
      
      var headers = state.headers.clutch || [];
      var statusIdx = headers.indexOf("STATUS");
      var hatchDateIdx = headers.indexOf("HATCH DATE");
      if (statusIdx < 0) { document.getElementById("hatchModalError").textContent = "No STATUS column"; return; }

      var updateData = { "STATUS": "Hatched" };
      if (hatchDateIdx >= 0) {
        updateData["HATCH DATE"] = state.hatchDate;
      }

      document.getElementById("hatchOnlyBtn").textContent = "Saving...";
      document.getElementById("hatchOnlyBtn").disabled = true;

      apiCall('updateRecord', {
        tab: SHEET_TABS.clutch,
        rowIndex: state.hatchClutchRow.__rowIndex,
        data: updateData
      }).then(function(response) {
        if (response.success) {
          setStatus("Clutch marked as hatched!");
          closeHatchModal();
          loadData();
        } else {
          document.getElementById("hatchModalError").textContent = "Failed: " + response.error;
        }
      }).catch(function(e) {
        document.getElementById("hatchModalError").textContent = "Failed: " + e.message;
      }).finally(function() {
        document.getElementById("hatchOnlyBtn").textContent = "Mark Hatched Only";
        document.getElementById("hatchOnlyBtn").disabled = false;
      });
    }

    function hatchAndCreateHatchlings() {
      if (!state.hatchClutchRow) return;
      var count = parseInt(document.getElementById("hatchCountInput").value) || 1;
      var hatchDate = document.getElementById("hatchDateInput").value;
      
      if (!hatchDate) {
        document.getElementById("hatchModalError").textContent = "Please enter a hatch date";
        return;
      }
      
      // Generate hatchling drafts
      var year = new Date().getFullYear();
      var baseNum = getMaxHatchlingNum(year);
      var clutchId = state.hatchClutchRow["CLUTCH ID"] || "";
      var sire = state.hatchClutchRow["SIRE"] || "";
      var dam = state.hatchClutchRow["DAM"] || "";

      state.hatchDrafts = [];
      for (var i = 1; i <= count; i++) {
        var id = "H-" + year + "-" + String(baseNum + i).padStart(4, "0");
        state.hatchDrafts.push({
          id: id,
          clutchId: clutchId,
          sire: sire,
          dam: dam,
          hatchDate: hatchDate,
          sex: "Unknown",
          animalName: "",
          geneticSummary: "",
          status: "Unlisted",
          notes: ""
        });
      }
      
      // Render the hatchling entry forms
      renderHatchlingForms();
    }
    
    function renderHatchlingForms() {
      var html = '<div class="mb-4 bg-gray-100 border border-gray-300 rounded-xl px-4 py-3">';
      html += '<div class="text-sm text-gray-700">Enter details for each hatchling. Click "Save All Hatchlings" when done.</div>';
      html += '</div>';
      
      html += '<div class="space-y-4 max-h-96 overflow-auto">';
      
      state.hatchDrafts.forEach(function(draft, idx) {
        html += '<div class="bg-slate-50 rounded-xl p-4 border border-slate-200">';
        html += '<div class="flex items-center justify-between mb-3">';
        html += '<div class="font-bold text-slate-800 mono">' + draft.id + '</div>';
        html += '<button onclick="removeHatchDraft(' + idx + ')" class="text-red-500 hover:text-red-700 text-sm">‚úï Remove</button>';
        html += '</div>';
        
        html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-3">';
        
        // Sex dropdown
        html += '<div>';
        html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Sex</label>';
        html += '<select onchange="updateHatchDraft(' + idx + ', \'sex\', this.value)" class="w-full px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-sm">';
        html += '<option value="Unknown"' + (draft.sex === "Unknown" ? " selected" : "") + '>Unknown</option>';
        html += '<option value="Female"' + (draft.sex === "Female" ? " selected" : "") + '>Female</option>';
        html += '<option value="Male"' + (draft.sex === "Male" ? " selected" : "") + '>Male</option>';
        html += '</select>';
        html += '</div>';
        
        // Animal Name
        html += '<div>';
        html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Name (optional)</label>';
        html += '<input type="text" value="' + escapeHtml(draft.animalName) + '" onchange="updateHatchDraft(' + idx + ', \'animalName\', this.value)" class="w-full px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-sm">';
        html += '</div>';
        
        // Status
        html += '<div>';
        html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Status</label>';
        html += '<select onchange="updateHatchDraft(' + idx + ', \'status\', this.value)" class="w-full px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-sm">';
        html += '<option value="Unlisted"' + (draft.status === "Unlisted" ? " selected" : "") + '>Unlisted</option>';
        html += '<option value="Listed"' + (draft.status === "Listed" ? " selected" : "") + '>Listed</option>';
        html += '<option value="Holdback"' + (draft.status === "Holdback" ? " selected" : "") + '>Holdback</option>';
        html += '</select>';
        html += '</div>';
        
        // Genetic Summary - full width
        html += '<div class="col-span-2 md:col-span-3">';
        html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Genetic Summary</label>';
        html += '<input type="text" value="' + escapeHtml(draft.geneticSummary) + '" onchange="updateHatchDraft(' + idx + ', \'geneticSummary\', this.value)" class="w-full px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-sm" placeholder="e.g. Pastel Het Clown">';
        html += '</div>';
        
        // Notes - full width
        html += '<div class="col-span-2 md:col-span-3">';
        html += '<label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Notes (optional)</label>';
        html += '<input type="text" value="' + escapeHtml(draft.notes) + '" onchange="updateHatchDraft(' + idx + ', \'notes\', this.value)" class="w-full px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-sm">';
        html += '</div>';
        
        html += '</div>'; // grid
        html += '</div>'; // card
      });
      
      html += '</div>'; // space-y container
      
      // Add another hatchling button
      html += '<div class="mt-4">';
      html += '<button onclick="addAnotherHatchDraft()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200">+ Add Another Hatchling</button>';
      html += '</div>';
      
      document.getElementById("hatchModalBody").innerHTML = html;
      
      // Update button text
      document.getElementById("hatchAndCreateBtn").textContent = "Save All Hatchlings (" + state.hatchDrafts.length + ")";
      document.getElementById("hatchAndCreateBtn").onclick = saveAllHatchlings;
    }
    
    function updateHatchDraft(idx, field, value) {
      if (state.hatchDrafts[idx]) {
        state.hatchDrafts[idx][field] = value;
      }
    }
    
    function removeHatchDraft(idx) {
      state.hatchDrafts.splice(idx, 1);
      if (state.hatchDrafts.length === 0) {
        // Reset to initial view
        openHatchModal(state.hatchClutchRow);
      } else {
        renderHatchlingForms();
      }
    }
    
    function addAnotherHatchDraft() {
      var year = new Date().getFullYear();
      var baseNum = getMaxHatchlingNum(year) + state.hatchDrafts.length;
      var id = "H-" + year + "-" + String(baseNum + 1).padStart(4, "0");
      var clutchId = state.hatchClutchRow["CLUTCH ID"] || "";
      var sire = state.hatchClutchRow["SIRE"] || "";
      var dam = state.hatchClutchRow["DAM"] || "";
      var hatchDate = document.getElementById("hatchDateInput") ? document.getElementById("hatchDateInput").value : state.hatchDate;
      
      state.hatchDrafts.push({
        id: id,
        clutchId: clutchId,
        sire: sire,
        dam: dam,
        hatchDate: hatchDate,
        sex: "Unknown",
        animalName: "",
        geneticSummary: "",
        status: "Unlisted",
        notes: ""
      });
      
      renderHatchlingForms();
    }
    
    function saveAllHatchlings() {
      if (!state.hatchClutchRow || !state.hatchDrafts.length) return;
      
      var headers = state.headers.collection || [];
      var clutchHeaders = state.headers.clutch || [];
      var hatchDate = state.hatchDrafts[0] ? state.hatchDrafts[0].hatchDate : "";

      document.getElementById("hatchAndCreateBtn").textContent = "Saving...";
      document.getElementById("hatchAndCreateBtn").disabled = true;

      // First update the clutch status
      var clutchUpdate = { "STATUS": "Hatched" };
      if (clutchHeaders.indexOf("HATCH DATE") >= 0 && hatchDate) {
        clutchUpdate["HATCH DATE"] = hatchDate;
      }
      var numHatchedIdx = -1;
      for (var i = 0; i < clutchHeaders.length; i++) {
        if (clutchHeaders[i].toUpperCase() === "# HATCHED") {
          numHatchedIdx = i;
          clutchUpdate[clutchHeaders[i]] = String(state.hatchDrafts.length);
          break;
        }
      }

      apiCall('updateRecord', {
        tab: SHEET_TABS.clutch,
        rowIndex: state.hatchClutchRow.__rowIndex,
        data: clutchUpdate
      }).then(function(response) {
        if (!response.success) {
          throw new Error(response.error || "Failed to update clutch");
        }
        // Now save each hatchling
        var promises = state.hatchDrafts.map(function(draft) {
          var hatchlingData = {};
          headers.forEach(function(h) {
            var hUpper = h.toUpperCase();
            if (hUpper === "UNIQUE ID" || hUpper === "MANUAL OVERRIDE") hatchlingData[h] = draft.id;
            else if (hUpper === "CLUTCH ID") hatchlingData[h] = draft.clutchId;
            else if (hUpper === "SIRE") hatchlingData[h] = draft.sire;
            else if (hUpper === "DAM") hatchlingData[h] = draft.dam;
            else if (hUpper === "HATCH DATE" || hUpper === "DATE OF BIRTH") hatchlingData[h] = draft.hatchDate;
            else if (hUpper === "STATUS") hatchlingData[h] = draft.status;
            else if (hUpper === "SEX") hatchlingData[h] = draft.sex;
            else if (hUpper === "ANIMAL NAME") hatchlingData[h] = draft.animalName;
            else if (hUpper === "GENETIC SUMMARY") hatchlingData[h] = draft.geneticSummary;
            else if (hUpper === "NOTES") hatchlingData[h] = draft.notes;
            else if (hUpper === "SPECIES") hatchlingData[h] = "Ball Python";
            else if (hUpper === "BREEDER SOURCE") hatchlingData[h] = "Produced In House";
            else hatchlingData[h] = "";
          });
          return apiCall('saveRecord', {
            tab: SHEET_TABS.collection,
            data: hatchlingData
          });
        });
        return Promise.all(promises);
      }).then(function() {
        setStatus("Created " + state.hatchDrafts.length + " hatchlings!");
        closeHatchModal();
        loadData();
      }).catch(function(e) {
        document.getElementById("hatchModalError").textContent = "Failed: " + e.message;
      }).finally(function() {
        document.getElementById("hatchAndCreateBtn").textContent = "Save All Hatchlings";
        document.getElementById("hatchAndCreateBtn").disabled = false;
      });
    }

    function getMaxHatchlingNum(year) {
      var rows = state.data.collection || [];
      var max = 0;
      var re = /^H-(\d{4})-(\d{4})$/i;
      rows.forEach(function(r) {
        var id = r["UNIQUE ID"] || r["MANUAL OVERRIDE"] || "";
        var m = re.exec(id);
        if (m && m[1] === String(year)) {
          var n = parseInt(m[2], 10);
          if (n > max) max = n;
        }
      });
      return max;
    }

    // ============ SALE MODAL ============
    function openSaleModal(animalRow) {
      state.saleAnimalRow = animalRow;
      var today = new Date().toISOString().split("T")[0];
      state.saleForm = {
        soldDate: today,
        soldPrice: "",
        shippingFee: "",
        buyerName: "",
        buyerEmail: "",
        saleSource: "MorphMarket",
        paymentStatus: "Paid",
        shipDate: ""
      };

      var uid = animalRow["UNIQUE ID"] || "Unknown";
      document.getElementById("saleAnimalId").textContent = uid;

      var html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
      html += formField("Sold Date", "date", "soldDate", state.saleForm.soldDate);
      html += formField("Sold Price", "number", "soldPrice", "");
      html += formField("Shipping Fee", "number", "shippingFee", "");
      html += formField("Buyer Name", "text", "buyerName", "");
      html += formField("Buyer Email", "email", "buyerEmail", "");
      html += formSelect("Sale Source", "saleSource", FIELD_OPTIONS.SALE_SOURCE, "MorphMarket");
      html += formSelect("Payment Status", "paymentStatus", FIELD_OPTIONS.PAYMENT_STATUS, "Paid");
      html += formField("Ship Date", "date", "shipDate", "");
      html += '</div>';

      document.getElementById("saleModalBody").innerHTML = html;
      document.getElementById("saleModal").classList.remove("hidden");
    }

    function formField(label, type, key, val) {
      return '<div><label class="block text-xs font-semibold text-slate-600 uppercase mb-1">' + label + '</label>' +
             '<input type="' + type + '" value="' + (val || "") + '" onchange="state.saleForm.' + key + '=this.value" ' +
             'class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 mono text-sm"></div>';
    }

    function formSelect(label, key, opts, selected) {
      var html = '<div><label class="block text-xs font-semibold text-slate-600 uppercase mb-1">' + label + '</label>';
      html += '<select onchange="state.saleForm.' + key + '=this.value" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm">';
      opts.forEach(function(o) {
        var sel = (o === selected) ? " selected" : "";
        html += '<option value="' + o + '"' + sel + '>' + o + '</option>';
      });
      html += '</select></div>';
      return html;
    }

    function closeSaleModal() {
      document.getElementById("saleModal").classList.add("hidden");
      document.getElementById("saleModalError").textContent = "";
      state.saleAnimalRow = null;
    }

    function saveSale() {
      if (!state.saleAnimalRow) return;
      
      var f = state.saleForm;
      if (!f.soldDate) { document.getElementById("saleModalError").textContent = "Sold date required"; return; }
      if (!f.soldPrice) { document.getElementById("saleModalError").textContent = "Sold price required"; return; }
      if (!f.buyerName) { document.getElementById("saleModalError").textContent = "Buyer name required"; return; }

      // Calculate TOTAL PAID
      var total = (parseFloat(f.soldPrice) || 0) + (parseFloat(f.shippingFee) || 0);

      var updateData = {
        "STATUS": "Sold",
        "SOLD PRICE": f.soldPrice,
        "DATE SOLD": f.soldDate,
        "BUYER NAME": f.buyerName,
        "BUYER EMAIL": f.buyerEmail,
        "SHIPPING FEE": f.shippingFee,
        "SHIP DATE": f.shipDate,
        "TOTAL PAID": String(total)
      };

      document.getElementById("saveSaleBtn").textContent = "Saving...";
      document.getElementById("saveSaleBtn").disabled = true;

      apiCall('updateRecord', {
        tab: SHEET_TABS.collection,
        rowIndex: state.saleAnimalRow.__rowIndex,
        data: updateData
      }).then(function(response) {
        if (response.success) {
          setStatus("Sale recorded!");
          closeSaleModal();
          loadData();
        } else {
          document.getElementById("saleModalError").textContent = "Failed: " + response.error;
        }
      }).catch(function(e) {
        document.getElementById("saleModalError").textContent = "Failed: " + e.message;
      }).finally(function() {
        document.getElementById("saveSaleBtn").textContent = "Save Sale";
        document.getElementById("saveSaleBtn").disabled = false;
      });
    }

    // ============ HOLDBACK FUNCTION ============
    function markAsHoldback(row) {
      if (!state.isLoggedIn) {
        setStatus("Not logged in", true);
        return;
      }
      
      setStatus("Updating to Holdback...");
      
      apiCall('updateRecord', {
        tab: SHEET_TABS.collection,
        rowIndex: row.__rowIndex,
        data: { "STATUS": "Holdback" }
      }).then(function(response) {
        if (response.success) {
          setStatus("Marked as Holdback!");
          loadData();
        } else {
          setStatus("Failed: " + response.error, true);
        }
      }).catch(function(e) {
        setStatus("Failed: " + e.message, true);
      });
    }

    // ============ TOOLS ============
    function exportCSV(sheetKey) {
      var headers = state.headers[sheetKey] || [];
      var rows = state.data[sheetKey] || [];
      if (!headers.length) { alert("No data to export"); return; }

      var lines = [headers.join(",")];
      rows.forEach(function(r) {
        var vals = headers.map(function(h) {
          var v = String(r[h] || "").replace(/"/g, '""');
          return '"' + v + '"';
        });
        lines.push(vals.join(","));
      });

      var blob = new Blob([lines.join("\n")], { type: "text/csv" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = sheetKey + "_export_" + new Date().toISOString().split("T")[0] + ".csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function showDataHealth() {
      var rows = state.data.collection || [];
      var missingSex = 0, listedNoSex = 0;
      
      rows.forEach(function(r) {
        var sex = (r.SEX || "").trim();
        var status = (r.STATUS || "").toLowerCase();
        if (!sex) missingSex++;
        if ((status === "listed" || status === "for sale") && !sex) listedNoSex++;
      });

      alert("Data Health Check\n\n" +
            "Animals missing sex: " + missingSex + "\n" +
            "Listed animals missing sex: " + listedNoSex);
    }

    // ============ ARCHIVE ============
    function renderArchiveView() {
      var archiveData = state.data.archive || [];
      var html = '';
      
      if (archiveData.length === 0) {
        html = '<div class="text-center py-12 text-gray-500">';
        html += '<div class="text-4xl mb-4">Empty</div>';
        html += '<p>No archived records yet.</p>';
        html += '<p class="text-sm mt-2">When you delete animals or clutches, they will appear here.</p>';
        html += '</div>';
      } else {
        // Filter into animals and clutches
        var archivedAnimals = archiveData.filter(function(r) { return r["ARCHIVE TYPE"] === "Collection"; });
        var archivedClutches = archiveData.filter(function(r) { return r["ARCHIVE TYPE"] === "Clutch"; });
        
        // Archived Animals
        if (archivedAnimals.length > 0) {
          html += '<div class="mb-8">';
          html += '<div class="text-xs uppercase tracking-wider text-gray-500 font-semibold mb-3">Archived Animals (' + archivedAnimals.length + ')</div>';
          html += '<div class="border border-gray-200 rounded-xl overflow-hidden">';
          html += '<table class="min-w-full text-sm">';
          html += '<thead class="bg-gray-50"><tr>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Name</th>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">ID</th>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Archived</th>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Action</th>';
          html += '</tr></thead>';
          html += '<tbody class="divide-y divide-gray-100">';
          
          archivedAnimals.forEach(function(animal, index) {
            html += '<tr class="' + (index % 2 === 0 ? 'bg-white' : 'bg-gray-50') + '">';
            html += '<td class="px-3 py-2 font-medium">' + escapeHtml(animal["ANIMAL NAME"] || "Unnamed") + '</td>';
            html += '<td class="px-3 py-2 mono text-xs">' + escapeHtml(animal["UNIQUE ID"] || animal["MANUAL OVERRIDE"] || "") + '</td>';
            html += '<td class="px-3 py-2 text-gray-500 text-xs">' + (animal["DATE ARCHIVED"] || "") + '</td>';
            html += '<td class="px-3 py-2"><button onclick="restoreFromArchive(' + animal.__rowIndex + ', \'Collection\')" class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-medium hover:bg-green-200">Restore</button></td>';
            html += '</tr>';
          });
          
          html += '</tbody></table></div></div>';
        }
        
        // Archived Clutches
        if (archivedClutches.length > 0) {
          html += '<div class="mb-8">';
          html += '<div class="text-xs uppercase tracking-wider text-gray-500 font-semibold mb-3">Archived Clutches (' + archivedClutches.length + ')</div>';
          html += '<div class="border border-gray-200 rounded-xl overflow-hidden">';
          html += '<table class="min-w-full text-sm">';
          html += '<thead class="bg-gray-50"><tr>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Clutch ID</th>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Pairing</th>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Archived</th>';
          html += '<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Action</th>';
          html += '</tr></thead>';
          html += '<tbody class="divide-y divide-gray-100">';
          
          archivedClutches.forEach(function(clutch, index) {
            html += '<tr class="' + (index % 2 === 0 ? 'bg-white' : 'bg-gray-50') + '">';
            html += '<td class="px-3 py-2 mono text-xs font-medium">' + escapeHtml(clutch["CLUTCH ID"] || "") + '</td>';
            html += '<td class="px-3 py-2">' + escapeHtml((clutch["SIRE"] || "") + " x " + (clutch["DAM"] || "")) + '</td>';
            html += '<td class="px-3 py-2 text-gray-500 text-xs">' + (clutch["DATE ARCHIVED"] || "") + '</td>';
            html += '<td class="px-3 py-2"><button onclick="restoreFromArchive(' + clutch.__rowIndex + ', \'Clutch\')" class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-medium hover:bg-green-200">Restore</button></td>';
            html += '</tr>';
          });
          
          html += '</tbody></table></div></div>';
        }
      }
      
      document.getElementById("dashboardView").innerHTML = html;
      document.getElementById("dashboardView").classList.remove("hidden");
    }

    function archiveRecord(rowIndex, sourceTab) {
      var sourceData = sourceTab === "Collection" ? state.data.collection : state.data.clutch;
      var record = sourceData.find(function(r) { return r.__rowIndex === rowIndex; });
      
      if (!record) {
        setStatus("Record not found", true);
        return;
      }
      
      var recordName = record["ANIMAL NAME"] || record["CLUTCH ID"] || "this record";
      
      if (!confirm("Move \"" + recordName + "\" to Archive?\n\nYou can restore it later from the Archive tab.")) {
        return;
      }
      
      setStatus("Archiving...");
      
      // Add archive metadata
      var archiveData = Object.assign({}, record);
      archiveData["ARCHIVE TYPE"] = sourceTab;
      archiveData["DATE ARCHIVED"] = new Date().toISOString().split('T')[0];
      
      // First, save to Archive tab
      apiCall('saveRecord', { tab: 'Archive', data: archiveData })
        .then(function(response) {
          if (response.success) {
            // Then delete from original tab
            return apiCall('deleteRecord', { tab: sourceTab, rowIndex: rowIndex });
          } else {
            throw new Error(response.error || "Failed to archive");
          }
        })
        .then(function(response) {
          if (response.success) {
            setStatus("Moved to Archive");
            loadData(); // Refresh all data
          } else {
            throw new Error(response.error || "Failed to delete original");
          }
        })
        .catch(function(error) {
          setStatus("Error: " + error.message, true);
        });
    }

    function restoreFromArchive(archiveRowIndex, originalTab) {
      var record = state.data.archive.find(function(r) { return r.__rowIndex === archiveRowIndex; });
      
      if (!record) {
        setStatus("Record not found", true);
        return;
      }
      
      var recordName = record["ANIMAL NAME"] || record["CLUTCH ID"] || "this record";
      
      if (!confirm("Restore \"" + recordName + "\" from Archive?")) {
        return;
      }
      
      setStatus("Restoring...");
      
      // Remove archive metadata
      var restoreData = Object.assign({}, record);
      delete restoreData["ARCHIVE TYPE"];
      delete restoreData["DATE ARCHIVED"];
      delete restoreData.__rowIndex;
      
      // First, save to original tab
      apiCall('saveRecord', { tab: originalTab, data: restoreData })
        .then(function(response) {
          if (response.success) {
            // Then delete from Archive
            return apiCall('deleteRecord', { tab: 'Archive', rowIndex: archiveRowIndex });
          } else {
            throw new Error(response.error || "Failed to restore");
          }
        })
        .then(function(response) {
          if (response.success) {
            setStatus("Restored from Archive");
            loadData(); // Refresh all data
          } else {
            throw new Error(response.error || "Failed to remove from archive");
          }
        })
        .catch(function(error) {
          setStatus("Error: " + error.message, true);
        });
    }

    // ============ QR CODE GENERATOR ============
    function openQRGenerator() {
      if (!state.isLoggedIn) {
        setStatus("Please log in first", true);
        return;
      }
      document.getElementById("qrModal").classList.remove("hidden");
      updateQRPreview();
    }

    function closeQRModal() {
      document.getElementById("qrModal").classList.add("hidden");
    }

    function updateQRPreview() {
      var filter = document.getElementById("qrAnimalSelect").value;
      var size = document.getElementById("qrSizeSelect").value;
      var preview = document.getElementById("qrPreview");
      
      // Filter animals - include all with any ID
      var animals = state.data.collection.filter(function(r) {
        var id = (r["UNIQUE ID"] || r["MANUAL OVERRIDE"] || "").trim();
        var status = (r.STATUS || "").toLowerCase().trim();
        if (!id) return false;
        
        if (filter === "breeders") {
          return status === "breeder" || status === "on loan";
        } else if (filter === "hatchlings") {
          return status === "listed" || status === "unlisted" || status === "holdback" || status === "for sale";
        }
        return true; // all
      });
      
      if (animals.length === 0) {
        preview.innerHTML = '<p class="text-gray-500 text-sm">No animals found matching filter. Make sure animals have a STATUS set.</p>';
        return;
      }
      
      // Size settings
      var sizes = {
        small: { box: 100, qr: 60, font: 9 },
        medium: { box: 140, qr: 100, font: 11 },
        large: { box: 180, qr: 140, font: 13 }
      };
      var s = sizes[size];
      
      var html = '<div id="qrPrintArea" class="flex flex-wrap gap-2">';
      
      animals.forEach(function(animal) {
        var animalId = animal["UNIQUE ID"] || animal["MANUAL OVERRIDE"] || "";
        var animalName = animal["ANIMAL NAME"] || "";
        var scanUrl = "https://app.therackapp.io?code=" + encodeURIComponent(state.sheetId) + "&animal=" + encodeURIComponent(animalId);
        var qrImageUrl = "https://api.qrserver.com/v1/create-qr-code/?size=" + s.qr + "x" + s.qr + "&data=" + encodeURIComponent(scanUrl);
        
        html += '<div class="qr-label bg-white border border-gray-300 rounded p-2 text-center" style="width:' + s.box + 'px;">';
        html += '<img src="' + qrImageUrl + '" alt="QR" style="width:' + s.qr + 'px; height:' + s.qr + 'px; margin: 0 auto; display: block;" />';
        html += '<div class="font-bold truncate" style="font-size:' + s.font + 'px; margin-top: 4px;">' + escapeHtml(animalName) + '</div>';
        html += '<div class="text-gray-500 mono truncate" style="font-size:' + (s.font - 2) + 'px;">' + escapeHtml(animalId) + '</div>';
        html += '</div>';
      });
      
      html += '</div>';
      preview.innerHTML = html;
    }

    function printQRCodes() {
      var printContent = document.getElementById("qrPrintArea").innerHTML;
      var printWindow = window.open('', '_blank');
      printWindow.document.write('<html><head><title>QR Codes - The Rack</title>');
      printWindow.document.write('<style>');
      printWindow.document.write('body { font-family: Inter, system-ui, sans-serif; margin: 20px; }');
      printWindow.document.write('.flex { display: flex; flex-wrap: wrap; gap: 8px; }');
      printWindow.document.write('.qr-label { background: white; border: 1px solid #ccc; border-radius: 4px; padding: 8px; text-align: center; page-break-inside: avoid; }');
      printWindow.document.write('.mx-auto { margin-left: auto; margin-right: auto; display: block; }');
      printWindow.document.write('.font-bold { font-weight: bold; }');
      printWindow.document.write('.text-gray-500 { color: #6b7280; }');
      printWindow.document.write('.mono { font-family: monospace; }');
      printWindow.document.write('.truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }');
      printWindow.document.write('</style></head><body>');
      printWindow.document.write(printContent);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    }

    // ============ MORPHMARKET IMPORT ============
    var importData = [];

    function openImportModal() {
      if (!state.isLoggedIn) {
        setStatus("Please log in first", true);
        return;
      }
      resetImport();
      document.getElementById("importModal").classList.remove("hidden");
    }

    function closeImportModal() {
      document.getElementById("importModal").classList.add("hidden");
      resetImport();
    }

    function resetImport() {
      importData = [];
      document.getElementById("importStep1").classList.remove("hidden");
      document.getElementById("importStep2").classList.add("hidden");
      document.getElementById("importStep3").classList.add("hidden");
      document.getElementById("importStep4").classList.add("hidden");
      document.getElementById("importFileInput").value = "";
    }

    function handleImportFile(event) {
      var file = event.target.files[0];
      if (!file) return;

      var reader = new FileReader();
      reader.onload = function(e) {
        var text = e.target.result;
        parseImportCSV(text);
      };
      reader.readAsText(file);
    }

    function parseImportCSV(text) {
      var lines = text.split('\n');
      if (lines.length < 2) {
        setStatus("CSV file appears to be empty", true);
        return;
      }

      // Parse header
      var headers = parseCSVLine(lines[0]);
      
      // Find column indices
      var cols = {
        category: headers.indexOf('Category*'),
        title: headers.indexOf('Title*'),
        animalId: headers.indexOf('Animal_Id*'),
        sex: headers.indexOf('Sex'),
        dob: headers.indexOf('Dob'),
        weight: headers.indexOf('Weight'),
        traits: headers.indexOf('Traits'),
        state: headers.indexOf('State'),
        price: headers.indexOf('Price'),
        photoUrls: headers.indexOf('Photo_Urls'),
        desc: headers.indexOf('Desc'),
        origin: headers.indexOf('Origin'),
        sires: headers.indexOf('Sires**'),
        dams: headers.indexOf('Dams**'),
        privateNotes: headers.indexOf('Private_Notes'),
        groupId: headers.indexOf('Group_Id')
      };

      importData = [];

      // Parse each row
      for (var i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        
        var row = parseCSVLine(lines[i]);
        if (row.length < 5) continue;

        var mmState = (row[cols.state] || "").toLowerCase();
        var status = "Breeder";
        if (mmState === "for sale") status = "Listed";
        else if (mmState === "sold") status = "Sold";

        var price = parseFloat(row[cols.price]) || 0;
        var purchasePrice = "";
        var listPrice = "";
        var soldPrice = "";

        if (status === "Sold") {
          soldPrice = price;
        } else if (status === "Listed") {
          listPrice = price;
        } else {
          purchasePrice = price;
        }

        // Parse sex
        var sex = (row[cols.sex] || "").toLowerCase();
        if (sex === "female" || sex === "f") sex = "Female";
        else if (sex === "male" || sex === "m") sex = "Male";
        else sex = "Unknown";

        // Parse DOB - MorphMarket uses various formats
        var dob = row[cols.dob] || "";
        
        // Get first photo URL only
        var photoUrls = row[cols.photoUrls] || "";
        var firstPhoto = photoUrls.split(' ')[0] || "";

        // Extract sire/dam names (format: "Name (M)(#ID)")
        var sireRaw = row[cols.sires] || "";
        var damRaw = row[cols.dams] || "";
        var sire = sireRaw.split(' (')[0] || "";
        var dam = damRaw.split(' (')[0] || "";

        // Combine notes
        var notes = row[cols.desc] || "";
        var privateNotes = row[cols.privateNotes] || "";
        if (privateNotes) {
          notes = notes ? notes + "\n\n" + privateNotes : privateNotes;
        }

        importData.push({
          "ANIMAL NAME": row[cols.title] || "",
          "MANUAL OVERRIDE": row[cols.animalId] || "",
          "SPECIES": row[cols.category] || "",
          "SEX": sex,
          "DATE OF BIRTH": dob,
          "WT PURCHASE (G)": row[cols.weight] || "",
          "GENETIC SUMMARY": row[cols.traits] || "",
          "STATUS": status,
          "PURCHASE PRICE": purchasePrice,
          "LIST PRICE": listPrice,
          "SOLD PRICE": soldPrice,
          "NOTES": notes,
          "BREEDER SOURCE": row[cols.origin] || "",
          "SIRE": sire,
          "DAM": dam,
          "CLUTCH ID": row[cols.groupId] || ""
        });
      }

      if (importData.length === 0) {
        setStatus("No valid animals found in CSV", true);
        return;
      }

      // Show preview
      showImportPreview();
    }

    function parseCSVLine(line) {
      var result = [];
      var current = "";
      var inQuotes = false;
      
      for (var i = 0; i < line.length; i++) {
        var char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = "";
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      
      return result;
    }

    function showImportPreview() {
      document.getElementById("importStep1").classList.add("hidden");
      document.getElementById("importStep2").classList.remove("hidden");

      var tbody = document.getElementById("importPreviewBody");
      var html = "";
      var newCount = 0;
      var updateCount = 0;

      importData.forEach(function(animal, index) {
        // Check if this is an update or new
        var manualId = animal["MANUAL OVERRIDE"];
        var isUpdate = false;
        
        if (manualId) {
          isUpdate = state.data.collection.some(function(r) {
            return r["MANUAL OVERRIDE"] === manualId;
          });
        }

        if (isUpdate) {
          updateCount++;
        } else {
          newCount++;
        }

        var actionBadge = isUpdate 
          ? '<span class="px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800">Update</span>'
          : '<span class="px-2 py-1 rounded text-xs bg-green-100 text-green-800">New</span>';

        html += '<tr class="' + (index % 2 === 0 ? 'bg-white' : 'bg-gray-50') + '">';
        html += '<td class="px-3 py-2">' + actionBadge + '</td>';
        html += '<td class="px-3 py-2 font-medium">' + escapeHtml(animal["ANIMAL NAME"]) + '</td>';
        html += '<td class="px-3 py-2 mono text-xs">' + escapeHtml(animal["MANUAL OVERRIDE"]) + '</td>';
        html += '<td class="px-3 py-2">' + animal["SEX"] + '</td>';
        html += '<td class="px-3 py-2"><span class="px-2 py-1 rounded text-xs ' + getStatusColor(animal["STATUS"]) + '">' + animal["STATUS"] + '</span></td>';
        html += '<td class="px-3 py-2 text-xs max-w-xs truncate">' + escapeHtml(animal["GENETIC SUMMARY"]) + '</td>';
        html += '</tr>';
      });

      document.getElementById("importCount").textContent = newCount + " new, " + updateCount + " updates";
      tbody.innerHTML = html;
    }

    function getStatusColor(status) {
      switch(status) {
        case "Listed": return "bg-green-100 text-green-800";
        case "Sold": return "bg-blue-100 text-blue-800";
        case "Breeder": return "bg-purple-100 text-purple-800";
        default: return "bg-gray-100 text-gray-800";
      }
    }

    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;");
    }

    function executeImport() {
      document.getElementById("importStep2").classList.add("hidden");
      document.getElementById("importStep3").classList.remove("hidden");

      var total = importData.length;
      var completed = 0;
      var errors = 0;
      var updated = 0;
      var created = 0;

      function importNext() {
        if (completed >= total) {
          // Done
          document.getElementById("importStep3").classList.add("hidden");
          document.getElementById("importStep4").classList.remove("hidden");
          document.getElementById("importResult").textContent = 
            "Import complete: " + created + " new, " + updated + " updated." + 
            (errors > 0 ? " " + errors + " failed." : "");
          return;
        }

        var animal = importData[completed];
        document.getElementById("importProgress").textContent = 
          "Importing " + (completed + 1) + " of " + total + "...";

        // Check for existing animal by MANUAL OVERRIDE
        var manualId = animal["MANUAL OVERRIDE"];
        var existingRow = null;
        
        if (manualId) {
          existingRow = state.data.collection.find(function(r) {
            return r["MANUAL OVERRIDE"] === manualId;
          });
        }

        if (existingRow && existingRow.__rowIndex !== undefined) {
          // Update existing row
          apiCall('updateRecord', { tab: 'Collection', rowIndex: existingRow.__rowIndex, data: animal })
            .then(function(response) {
              if (response.success) {
                updated++;
                // Update local data
                Object.assign(existingRow, animal);
              } else {
                errors++;
                console.error("Failed to update:", animal["ANIMAL NAME"], response.error);
              }
            })
            .catch(function(error) {
              errors++;
              console.error("Error updating:", animal["ANIMAL NAME"], error);
            })
            .finally(function() {
              completed++;
              setTimeout(importNext, 100);
            });
        } else {
          // Create new row
          apiCall('saveRecord', { tab: 'Collection', data: animal })
            .then(function(response) {
              if (response.success) {
                created++;
              } else {
                errors++;
                console.error("Failed to import:", animal["ANIMAL NAME"], response.error);
              }
            })
            .catch(function(error) {
              errors++;
              console.error("Error importing:", animal["ANIMAL NAME"], error);
            })
            .finally(function() {
              completed++;
              setTimeout(importNext, 100);
            });
        }
      }

      importNext();
    }

    // ============ START ============
    init();
  </script>
</body>
</html>
